<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>Hexo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="">
    <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://blog.heshipeng.com/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="拾光的碎羽">
<meta name="twitter:card" content="summary">
    
        <link rel="alternate" type="application/atom+xml" title="Hexo" href="/atom.xml">
    
    <link rel="shortcut icon" href="https://img.heshipeng.com/202205092054351.png">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

<meta name="generator" content="Hexo 5.4.2"></head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu"  >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(https://img.heshipeng.com/202205092044923.jpeg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="https://img.heshipeng.com/202205092042366.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">拾光的碎羽</h5>
          <a href="mailto:1615433864@qq.com" title="1615433864@qq.com" class="mail">1615433864@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                Home
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Hexo</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="Search">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header index-header">

    <div class="container fade-scale">
        <h1 class="title">Hexo</h1>
        <h5 class="subtitle">
            
                
            
        </h5>
    </div>

    


</header>

<div class="container body-wrap">

    <ul class="post-list">
    
        <li class="post-list-item fade">
            <article id="post-JS逆向案例——阿尔法营webpack抠JS"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time class="post-time" title="2022-04-06 20:35:48" datetime="2022-04-06T12:35:48.000Z"  itemprop="datePublished">2022-04-06</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/JS%E9%80%86%E5%90%91/">JS逆向</a></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/JS%E9%80%86%E5%90%91%E6%A1%88%E4%BE%8B%E2%80%94%E2%80%94%E9%98%BF%E5%B0%94%E6%B3%95%E8%90%A5webpack%E6%8A%A0JS/">JS逆向案例——阿尔法营webpack抠JS</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent">

    
        <blockquote>
<p>免责声明：<strong>本文章中所有内容仅供学习交流，抓包内容、敏感网址、数据接口均已做脱敏处理，严禁用于商业用途和非法用途，否则由此产生的一切后果均与作者无关，若有侵权，请联系我立即删除！</strong></p>
</blockquote>
<h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>webpack抠JS的一个案例，同样用来熟练如何从webpack打包的JS代码中抠关键的JS代码。</p>
<h4 id="抠JS过程"><a href="#抠JS过程" class="headerlink" title="抠JS过程"></a>抠JS过程</h4><p>网址：aHR0cHM6Ly9hZXJmYXlpbmcuY29tLw==</p>
<p>目标：登录接口的请求参数t和s分析。</p>
<p>老规矩，先抓包。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202204061540833.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220406154058629" title="">
                </div>
                <div class="image-caption">image-20220406154058629</div>
            </figure>
<p>可以看到请求参数中username和password都是明文，t参数目测是一个时间戳，s是一串加密之后的密文。</p>
<p>从请求堆栈Initiator中一个个点进去，看看能否找到s生成的地方。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202204061545622.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220406154534518" title="">
                </div>
                <div class="image-caption">image-20220406154534518</div>
            </figure>
<p>点击上面的文件，发现有个报错：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202204061546076.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220406154640011" title="">
                </div>
                <div class="image-caption">image-20220406154640011</div>
            </figure>
<p>遇到这种<code>Could not load content for webpack:///</code>的错误，需要更改下浏览器的默认配置，Settings/Preferences/Sources，去掉Enable Javascript source maps的勾选。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202204061546397.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220406154623354" title="">
                </div>
                <div class="image-caption">image-20220406154623354</div>
            </figure>
<p>修改配置之后，就可以看到相关JS文件的代码了。找到一块疑似加密的代码，如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202204061551050.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220406155132967" title="">
                </div>
                <div class="image-caption">image-20220406155132967</div>
            </figure>
<p>window.Blockey.SecuritySalt，w和n都是固定的值。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202204061601020.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220406160129468" title="">
                </div>
                <div class="image-caption">image-20220406160129468</div>
            </figure>
<p>根据上面生成s的代码，我们整理代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">window</span> = <span class="built_in">global</span>;</span><br><span class="line"><span class="keyword">var</span> n = <span class="string">&quot;/WebApi/Users/Login&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_sign</span>(<span class="params">username, password</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> x = <span class="string">&quot;DUE$DEHFYE(YRUEHD*&amp;&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> w = <span class="string">&quot;username=&quot;</span> + username + <span class="string">&quot;&amp;&quot;</span> + <span class="string">&quot;password=&quot;</span> + password;</span><br><span class="line">    <span class="keyword">return</span> c.default((n + <span class="string">&quot;?&quot;</span> + w + x));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们的目标就很明确了，就是抠出c.default的函数，填入到我们的JS文件，我们浏览器中点进去c.default函数：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202204061607543.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220406160747460" title="">
                </div>
                <div class="image-caption">image-20220406160747460</div>
            </figure>
<p>我们上边猜想的t是一个时间戳，不准确，可以看到t是一个时间戳加上了一个固定的数值。然后s参数是一个Sha1算法生成的密文。</p>
<p>我们继续点进去Sha1.hash函数：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202204061611573.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220406161134381" title="">
                </div>
                <div class="image-caption">image-20220406161134381</div>
            </figure>
<p>然后将抠出来的JS函数一个个填充到JS文件中去，缺啥抠啥。具体详细过程不一步步展示了。最终整理的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> n = <span class="string">&quot;/WebApi/Users/Login&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> c = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> Sha1 = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">Sha1.hash = <span class="function"><span class="keyword">function</span>(<span class="params">n, t</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 代码较长，省略</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Sha1.f = <span class="function"><span class="keyword">function</span>(<span class="params">n, t, i, r</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (n) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> t &amp; i ^ ~t &amp; r;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> t ^ i ^ r;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> t &amp; i ^ t &amp; r ^ i &amp; r;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> t ^ i ^ r</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Sha1.ROTL = <span class="function"><span class="keyword">function</span>(<span class="params">n, t</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> n &lt;&lt; t | n &gt;&gt;&gt; <span class="number">32</span> - t</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Sha1.utf8Encode = <span class="function"><span class="keyword">function</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">unescape</span>(<span class="built_in">encodeURIComponent</span>(n))</span><br><span class="line">&#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">c.default = <span class="function"><span class="keyword">function</span>(<span class="params">e, t</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> n = (<span class="keyword">new</span> <span class="built_in">Date</span>).getTime() + <span class="number">2592e6</span> + (t || <span class="number">3e4</span>)</span><br><span class="line">        , r = (e || <span class="string">&quot;&quot;</span>) + <span class="string">&quot;&amp;t=&quot;</span> + n;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">t</span>: n,</span><br><span class="line">        <span class="attr">s</span>: Sha1.hash(r)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_sign</span>(<span class="params">username, password</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> x = <span class="string">&quot;DUE$DEHFYE(YRUEHD*&amp;&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> w = <span class="string">&quot;username=&quot;</span> + username + <span class="string">&quot;&amp;&quot;</span> + <span class="string">&quot;password=&quot;</span> + password;</span><br><span class="line">    <span class="keyword">return</span> c.default((n + <span class="string">&quot;?&quot;</span> + w + x));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(get_sign(<span class="string">&quot;17777777777&quot;</span>, <span class="string">&quot;123456&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>输出结果，跟预期一致：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202204061618301.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220406161810100" title="">
                </div>
                <div class="image-caption">image-20220406161810100</div>
            </figure>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>这个案例比较简单，没有什么难度，提这个案例主要目的有2点，第一就是遇到按照webpack方式组织的JS代码，不一定非得按照前面介绍的分五步走，先找模块加载器，然后编写自执行等等，一些简单的webpack可以直接去抠JS代码的。第二就是遇到<code>`Could not load content for webpack:///</code>这种报错，需要去修改浏览器配置。</p>
<h4 id="关于代码"><a href="#关于代码" class="headerlink" title="关于代码"></a>关于代码</h4><p>扫码关注微信号——逆向一步步，公众号内回复关键词<code>04</code>就可以获取本案例的全部代码。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202204061622110.jpg" alt="qrcode_for_gh_509fdefd3c81_258" title="">
                </div>
                <div class="image-caption">qrcode_for_gh_509fdefd3c81_258</div>
            </figure>

    

        <a href="/JS%E9%80%86%E5%90%91%E6%A1%88%E4%BE%8B%E2%80%94%E2%80%94%E9%98%BF%E5%B0%94%E6%B3%95%E8%90%A5webpack%E6%8A%A0JS/" class="post-more waves-effect waves-button">
            Continue reading...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JS/" rel="tag">JS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WebPack/" rel="tag">WebPack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%80%86%E5%90%91/" rel="tag">逆向</a></li></ul>

    </div>
    
</article>

        </li>
    
        <li class="post-list-item fade">
            <article id="post-JS逆向案例——某远海运公司webpack抠JS"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time class="post-time" title="2022-04-03 23:28:00" datetime="2022-04-03T15:28:00.000Z"  itemprop="datePublished">2022-04-03</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/JS%E9%80%86%E5%90%91/">JS逆向</a></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/JS%E9%80%86%E5%90%91%E6%A1%88%E4%BE%8B%E2%80%94%E2%80%94%E6%9F%90%E8%BF%9C%E6%B5%B7%E8%BF%90%E5%85%AC%E5%8F%B8webpack%E6%8A%A0JS/">JS逆向案例——某远海运公司webpack抠JS</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent">

    
        <blockquote>
<p>免责声明：<strong>本文章中所有内容仅供学习交流，抓包内容、敏感网址、数据接口均已做脱敏处理，严禁用于商业用途和非法用途，否则由此产生的一切后果均与作者无关，若有侵权，请联系我立即删除！</strong></p>
</blockquote>
<h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>webpack抠JS的一个案例，用来熟练如何从webpack打包的JS代码中抠关键的JS代码。</p>
<h4 id="抠JS过程"><a href="#抠JS过程" class="headerlink" title="抠JS过程"></a>抠JS过程</h4><p>网址：aHR0cHM6Ly9zeW5jb25odWIuY29zY29zaGlwcGluZy5jb20v</p>
<p>目标：登录接口的密码加密JS代码分析。</p>
<p>老规矩，先抓包。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202204041509227.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220404150944421" title="">
                </div>
                <div class="image-caption">image-20220404150944421</div>
            </figure>
<p>可以看到登录请求的密码这个参数是加密的。</p>
<p>搜索关键词<code>password</code>，找到一个疑似加密的函数，如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202204041624199.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220404162426120" title="">
                </div>
                <div class="image-caption">image-20220404162426120</div>
            </figure>
<p>点进去看到加密的地方：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202204041633567.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220404163306525" title="">
                </div>
                <div class="image-caption">image-20220404163306525</div>
            </figure>
<p>接着点进去看这个<code>o.a</code>函数：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202204041634530.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220404163401493" title="">
                </div>
                <div class="image-caption">image-20220404163401493</div>
            </figure>
<p>可以看到，对密码采用了RSA加密，然后进行Base64编码。然后看下代码结构，很显然是按照webpack模块化编程进行组织的。</p>
<p>按照前面介绍的——<a href="https://blog.heshipeng.com/JS%E9%80%86%E5%90%91%E4%B9%8Bwebpack%E6%89%A3JS%E6%80%9D%E8%B7%AF/">JS逆向之webpack扣JS思路</a>——这篇文章总结的方法：</p>
<ol>
<li>找到模块加载器。</li>
</ol>
<p>快速定位模块加载器，一般可以通过搜索<code>&#125;(&#123;</code>，迅速定位到，但是包含加密函数的JS文件中并未找到模块加载器，没有找到的话，我们自己写一个好了。代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (e[n])</span><br><span class="line">        <span class="keyword">return</span> e[n].exports;</span><br><span class="line">    <span class="keyword">var</span> u = e[n] = &#123;</span><br><span class="line">        <span class="attr">i</span>: n,</span><br><span class="line">        <span class="attr">l</span>: !<span class="number">1</span>,</span><br><span class="line">        <span class="attr">exports</span>: &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> c[n].call(u.exports, u, u.exports, b),</span><br><span class="line">        u.l = !<span class="number">0</span>,</span><br><span class="line">        u.exports</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>构造自执行。</li>
</ol>
<p>这个也比较简单，我们把上边的代码，稍微做修改：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">!<span class="function"><span class="keyword">function</span>(<span class="params">c</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> e = &#123;&#125;;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (e[n])</span><br><span class="line">            <span class="keyword">return</span> e[n].exports;</span><br><span class="line">        <span class="keyword">var</span> u = e[n] = &#123;</span><br><span class="line">            <span class="attr">i</span>: n,</span><br><span class="line">            <span class="attr">l</span>: !<span class="number">1</span>,</span><br><span class="line">            <span class="attr">exports</span>: &#123;&#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> c[n].call(u.exports, u, u.exports, b),</span><br><span class="line">        u.l = !<span class="number">0</span>,</span><br><span class="line">        u.exports</span><br><span class="line">    &#125;</span><br><span class="line">    encode = b;</span><br><span class="line">&#125;(&#123;</span><br><span class="line">	<span class="comment">// TODO</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ol>
<li>找到并抠出需要的模块。</li>
</ol>
<p>抠JS就变成了一道填空题，把加密方法依赖到的模块抠出来，作为参数填到上边自执行函数中去。我们先抠出加密方法， 观察下依赖哪些模块：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> r = n(<span class="string">&quot;XBrZ&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> t = r.pki.publicKeyFromPem(</span><br><span class="line">    <span class="string">&quot;-----BEGIN PUBLIC KEY-----\n MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsy4xppPDUT2eAOR5h0cyydzxtKB9O80A\n GjUT6FmDgg6CwelpnE0C2h2JQyP1gCveJs6GDwSDn20RVVpD67f//YPYErjaH/CBOxNG3k5IkW1o\n Qx04uqFNMtWvjzk0aFh2eJLsBi7Ha4elw3WySg00B8oZCL4VBay4ML9kyOAjjCj5jHCX8a2yxIMJ\n IF+EjW3kBR68IMwBvuDL45Qa0oB24vTffaSEs+hGjMTQvoCciOfti3pmEAlVc438/cBgAhK5cIMf\n IMElxYAVvmsDy0I7RCUTrajetKjX94Q+JuQUxnIHNC3IVtYsl1x0lNRtb93IhlRCkZ9djOu350eq\n hZIOXQIDAQAB\n  -----END PUBLIC KEY-----&quot;</span>).encrypt(e, <span class="string">&quot;RSA-OAEP&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">md</span>: r.md.sha256.create(),</span><br><span class="line">    <span class="attr">mgf1</span>: &#123;</span><br><span class="line">        <span class="attr">md</span>: r.md.sha1.create()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">window</span>.btoa(t)</span><br></pre></td></tr></table></figure>
<p>通过debug知e是我们填入的密码——即123456，唯一用到的模块是键为<code>XBrZ</code>的模块。我们全局搜索<code>XBrZ:</code>找到对应的模块定义：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202204041656123.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220404165620085" title="">
                </div>
                <div class="image-caption">image-20220404165620085</div>
            </figure>
<p>点进去发现这个模块又引用了很多其它的模块，如果按照模块一个一个的抠的话，比较费时。所以我们将这整个文件中定义的模块全部抠下来，作为我们上边定义的自执行函数的参数。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202204041656763.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220404165643735" title="">
                </div>
                <div class="image-caption">image-20220404165643735</div>
            </figure>
<p>整理完了之后，我们将代码放到浏览器中检验一下，防止出错：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202204041701058.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220404170102015" title="">
                </div>
                <div class="image-caption">image-20220404170102015</div>
            </figure>
<p>不出意外的话就不会出意外，没有报错。</p>
<ol>
<li>导出相应的模块。</li>
</ol>
<p>模块通过模块加载器加载，所以想要得到加密方法依赖的模块，只需要导出模块函数即可。定义一个全局变量，比如<code>encode</code>，然后将上边实现的模块加载函数赋值给这个全局变量即可。代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> encode;</span><br><span class="line"></span><br><span class="line">!<span class="function"><span class="keyword">function</span>(<span class="params">c</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> e = &#123;&#125;;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (e[n])</span><br><span class="line">            <span class="keyword">return</span> e[n].exports;</span><br><span class="line">        <span class="keyword">var</span> u = e[n] = &#123;</span><br><span class="line">            <span class="attr">i</span>: n,</span><br><span class="line">            <span class="attr">l</span>: !<span class="number">1</span>,</span><br><span class="line">            <span class="attr">exports</span>: &#123;&#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> c[n].call(u.exports, u, u.exports, b),</span><br><span class="line">        u.l = !<span class="number">0</span>,</span><br><span class="line">        u.exports</span><br><span class="line">    &#125;</span><br><span class="line">    encode = b;</span><br><span class="line">&#125;(&#123;</span><br><span class="line">    <span class="comment">// 此处省略若干行模块函数的定义</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ol>
<li>编写测试代码。</li>
</ol>
<p>对于这个案例而言，测试代码就是那一串加密代码，看能否如期的得到类似的加密字符串，就证明我们抠的JS没有问题，测试代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_pass</span>(<span class="params">passwd</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> r = encode(<span class="string">&quot;XBrZ&quot;</span>); <span class="comment">// 通过模块加载器加载XBrZ模块。</span></span><br><span class="line">    <span class="keyword">var</span> t = r.pki.publicKeyFromPem(<span class="string">&quot;-----BEGIN PUBLIC KEY-----\n MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsy4xppPDUT2eAOR5h0cyydzxtKB9O80A\n GjUT6FmDgg6CwelpnE0C2h2JQyP1gCveJs6GDwSDn20RVVpD67f//YPYErjaH/CBOxNG3k5IkW1o\n Qx04uqFNMtWvjzk0aFh2eJLsBi7Ha4elw3WySg00B8oZCL4VBay4ML9kyOAjjCj5jHCX8a2yxIMJ\n IF+EjW3kBR68IMwBvuDL45Qa0oB24vTffaSEs+hGjMTQvoCciOfti3pmEAlVc438/cBgAhK5cIMf\n IMElxYAVvmsDy0I7RCUTrajetKjX94Q+JuQUxnIHNC3IVtYsl1x0lNRtb93IhlRCkZ9djOu350eq\n hZIOXQIDAQAB\n  -----END PUBLIC KEY-----&quot;</span>).encrypt(passwd, <span class="string">&quot;RSA-OAEP&quot;</span>, &#123;</span><br><span class="line">        <span class="attr">md</span>: r.md.sha256.create(),</span><br><span class="line">        <span class="attr">mgf1</span>: &#123;</span><br><span class="line">            <span class="attr">md</span>: r.md.sha1.create()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">window</span>.btoa(t)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(get_pass(<span class="string">&quot;123456&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>运行测试代码，正常的输出了密码加密之后的密文：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202204041709186.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220404170927135" title="">
                </div>
                <div class="image-caption">image-20220404170927135</div>
            </figure>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>从webpack组织的JS代码中抠JS，虽然看起来比较简单，但是如果遇到复杂一点的案例，并且对JS语法不太熟的话，还是有一定的难度的的，所以需要对这一块多多练习。后边关于webpack的，还会再出一些案例，一些更加复杂的案例。</p>
<h4 id="关于代码的获取"><a href="#关于代码的获取" class="headerlink" title="关于代码的获取"></a>关于代码的获取</h4><p>扫码关注微信号——逆向一步步，公众号内回复关键词<code>03</code>就可以获取本案例的全部代码。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202202231720872.jpg" alt="qrcode_for_gh_509fdefd3c81_258" title="">
                </div>
                <div class="image-caption">qrcode_for_gh_509fdefd3c81_258</div>
            </figure>

    

        <a href="/JS%E9%80%86%E5%90%91%E6%A1%88%E4%BE%8B%E2%80%94%E2%80%94%E6%9F%90%E8%BF%9C%E6%B5%B7%E8%BF%90%E5%85%AC%E5%8F%B8webpack%E6%8A%A0JS/" class="post-more waves-effect waves-button">
            Continue reading...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JS/" rel="tag">JS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WebPack/" rel="tag">WebPack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%80%86%E5%90%91/" rel="tag">逆向</a></li></ul>

    </div>
    
</article>

        </li>
    
        <li class="post-list-item fade">
            <article id="post-JS逆向之webpack扣JS思路"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time class="post-time" title="2022-03-28 16:59:43" datetime="2022-03-28T08:59:43.000Z"  itemprop="datePublished">2022-03-28</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/JS%E9%80%86%E5%90%91/">JS逆向</a></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/JS%E9%80%86%E5%90%91%E4%B9%8Bwebpack%E6%89%A3JS%E6%80%9D%E8%B7%AF/">JS逆向之webpack扣JS思路</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent">

    
        <div align="center"><iframe width="560" height="315" src="https://www.youtube.com/embed/iJAxeafvn8Y" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>



<h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>这篇文章通过站在逆向的角度，解决遇到JS文件如果通过webpack的方式去组织代码模块如何扣JS代码，进行逆向分析的问题。</p>
<h3 id="关于webpack"><a href="#关于webpack" class="headerlink" title="关于webpack"></a>关于webpack</h3><h4 id="JS的自执行函数"><a href="#JS的自执行函数" class="headerlink" title="JS的自执行函数"></a>JS的自执行函数</h4><p>IIFE 全称 Immediately-invoked Function Expressions，即自执行函数。这种模式本质上就是函数表达式（命名的或者匿名的）在创建后立即执行。当函数变成立即执行的函数表达式时，表达式中的变量不能从外部访问。IIFE 主要用来隔离作用域，避免污染。</p>
<h5 id="自执行函数的几种形式"><a href="#自执行函数的几种形式" class="headerlink" title="自执行函数的几种形式"></a>自执行函数的几种形式</h5><ol>
<li>匿名函数前面加上一元操作符，后面加上 <code>()</code>。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">!<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;();</span><br><span class="line"></span><br><span class="line">+<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;();</span><br><span class="line"></span><br><span class="line">-<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;();</span><br><span class="line"></span><br><span class="line">~<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;();</span><br></pre></td></tr></table></figure>
<ol>
<li>匿名函数后边加上<code>()</code>，然后再用<code>()</code>将整个括起来。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Hello, world!&quot;</span>);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<ol>
<li>先用 <code>()</code> 将匿名函数括起来，再在后面加上 <code>()</code>。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Hello, world!&quot;</span>);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<ol>
<li>使用箭头函数表达式，先用 <code>()</code> 将箭头函数表达式括起来，再在后面加上 <code>()</code>。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;Hello, world!&quot;</span>);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<ol>
<li>匿名函数前面加上 <code>void</code> 关键字，后面加上 <code>()</code>， <code>void</code> 指定要计算或运行一个表达式，但是不返回值。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Hello, world!&quot;</span>);</span><br><span class="line">&#125;();</span><br></pre></td></tr></table></figure>
<p>有的时候，我们还有可能见到立即执行函数前面后分号的情况，比如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Hello, world!&quot;</span>);</span><br><span class="line">&#125;())</span><br><span class="line"></span><br><span class="line">;!<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Hello, world!&quot;</span>);</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<h5 id="自执行函数传参"><a href="#自执行函数传参" class="headerlink" title="自执行函数传参"></a>自执行函数传参</h5><p>将参数放在末尾的 <code>()</code> 里即可实现参数传递，如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> list = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; list.length; i++) &#123;</span><br><span class="line">        sum += list[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(sum);</span><br><span class="line">&#125;)(list);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dict = &#123;<span class="attr">name</span>: <span class="string">&quot;Bob&quot;</span>, <span class="attr">age</span>: <span class="string">&quot;20&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(dict.name);</span><br><span class="line">&#125;)(dict);</span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">a, b, c, d</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(a + b + c + d);</span><br><span class="line">&#125;)(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br></pre></td></tr></table></figure>
<h4 id="call-apply-bind三兄弟"><a href="#call-apply-bind三兄弟" class="headerlink" title="call, apply, bind三兄弟"></a>call, apply, bind三兄弟</h4><p><code>Function.prototype.call()</code>、<code>Function.prototype.apply()</code>、<code>Function.prototype.bind()</code> 都是比较常用的方法。它们的作用一毛一样，即<strong>改变函数中的 <code>this</code> 指向</strong>，它们的区别如下：</p>
<ul>
<li><code>call()</code> 方法会立即执行这个函数，接受一个多个参数，参数之间用逗号隔开；</li>
<li><code>apply()</code> 方法会立即执行这个函数，接受一个包含多个参数的数组；</li>
<li><code>bind()</code> 方法不会立即执行这个函数，返回的是一个修改过后的函数，便于稍后调用，接受的参数和 <code>call()</code> 一样。</li>
</ul>
<h5 id="call"><a href="#call" class="headerlink" title="call"></a>call</h5><p><code>call()</code> 方法接受多个参数，第一个参数 thisArg 指定了函数体内 this 对象的指向，如果这个函数处于非严格模式下，指定为 null 或 undefined 时会自动替换为指向全局对象（浏览器中就是 window 对象），在严格模式下，函数体内的 this 还是为 null。从第二个参数开始往后，每个参数被依次传入函数，基本语法如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">call</span>(<span class="params">thisArg, arg1, arg2, ...</span>)</span></span><br></pre></td></tr></table></figure>
<p>比如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func1</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(func1.call(<span class="literal">null</span>, <span class="number">1</span>, <span class="number">2</span>)); <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>[<span class="number">0</span>] + <span class="built_in">this</span>[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(func2.call([<span class="number">1</span>, <span class="number">2</span>])); <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func3</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.a + <span class="built_in">this</span>.b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(func3.call(&#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>, <span class="string">&quot;b&quot;</span>: <span class="number">2</span>&#125;)); <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>
<h5 id="apply"><a href="#apply" class="headerlink" title="apply"></a>apply</h5><p><code>apply()</code> 方法接受两个参数，第一个参数 thisArg 与 <code>call()</code> 方法一致，第二个参数为一个带下标的集合，这个集合可以为数组，也可以为类数组，<code>apply()</code> 方法把这个集合中的元素作为参数传递给被调用的函数，基本语法如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span>.apply(thisArg, [arg1, arg2, ...])</span><br></pre></td></tr></table></figure>
<p>比如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>[<span class="number">0</span>] + <span class="built_in">this</span>[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(func2.apply([<span class="number">1</span>, <span class="number">2</span>])); <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func3</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.a + <span class="built_in">this</span>.b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(func3.apply(&#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>, <span class="string">&quot;b&quot;</span>: <span class="number">2</span>&#125;)); <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>
<h5 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h5><p><code>bind()</code> 方法和 <code>call()</code> 接受的参数是相同的，只不过 <code>bind()</code> 返回的是一个函数，基本语法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">function.bind(thisArg, arg1, arg2, ...)</span><br></pre></td></tr></table></figure>
<p>比如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params">a, b, c</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b + c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(func.bind(<span class="literal">null</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)()); <span class="comment">// 6</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>[<span class="number">0</span>] + <span class="built_in">this</span>[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(func1.bind([<span class="number">1</span>, <span class="number">2</span>])()); <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>
<h4 id="理解webpack"><a href="#理解webpack" class="headerlink" title="理解webpack"></a>理解webpack</h4><p>有了以上知识后，我们再来理解一下模块化编程，也就是前面所说的 webpack 写法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">!<span class="function"><span class="keyword">function</span> (<span class="params">allModule</span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">useModule</span>(<span class="params">whichModule, xxx, xxx, <span class="comment">/*...*/</span></span>) </span>&#123;</span><br><span class="line">        allModule[whichModule].call(<span class="literal">null</span>, xxx, xxx, <span class="comment">/*...*/</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    useModule(<span class="number">0</span>, <span class="string">&#x27;abc&#x27;</span>, <span class="literal">null</span>, <span class="comment">/*...*/</span>)</span><br><span class="line">&#125;([</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">module0</span>(<span class="params">param</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;module0: &quot;</span> + param)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">module1</span>(<span class="params">param</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;module1: &quot;</span> + param)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">module2</span>(<span class="params">param</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;module2: &quot;</span> + param)</span><br><span class="line">    &#125;,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
<p>所谓webpack模块化编程，就是把一类函数——这些函数服务于某个或者某几个功能起作用——以列表或者对象的形式放在一起，封装到一个自执行的函数中，这些函数对外是不可见的，并且只对外暴露一个函数，这个函数叫做模块加载函数，外部通过这个加载函数访问自执行函数内部的函数，从而起到模块化的作用。</p>
<h5 id="webpack模块化编程的JS代码结构特点"><a href="#webpack模块化编程的JS代码结构特点" class="headerlink" title="webpack模块化编程的JS代码结构特点"></a>webpack模块化编程的JS代码结构特点</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="comment">/*加载模块的方法*/</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">xx</span>(<span class="params">yy</span>) </span>&#123;</span><br><span class="line">        x[yy].call(x1, x2, x3);</span><br><span class="line">        <span class="comment">// x[yy].apply([x1, x2, x3]);</span></span><br><span class="line">        <span class="comment">// x[yy].bind(x1, x2, x3)();</span></span><br><span class="line">        </span><br><span class="line">    &#125;([</span><br><span class="line">        <span class="comment">// 可供加载的模块列表</span></span><br><span class="line">        <span class="function"><span class="keyword">function</span>(<span class="params">x1, x2, x3</span>) </span>&#123;&#125;,</span><br><span class="line">        <span class="function"><span class="keyword">function</span>(<span class="params">x1, x2, x3</span>) </span>&#123;&#125;</span><br><span class="line">    ]</span><br><span class="line">     <span class="comment">// 或者是</span></span><br><span class="line">      &#123;</span><br><span class="line">      	<span class="string">&quot;xxx&quot;</span>: <span class="function"><span class="keyword">function</span>(<span class="params">x1, x2, x3</span>) </span>&#123;&#125;,</span><br><span class="line">        <span class="string">&quot;xxx&quot;</span>: <span class="function"><span class="keyword">function</span>(<span class="params">x1, x2, x3</span>) </span>&#123;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">     );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>webpack模块化编程的JS代码特点是包含2个部分，上面是一个加载模块的方法，也叫模块加载器。下面是可供加载的模块列表。可供加载的模块列表是一个类数组(可以是数组，可以是对象)。</p>
<h5 id="webpack扣JS的步骤"><a href="#webpack扣JS的步骤" class="headerlink" title="webpack扣JS的步骤"></a>webpack扣JS的步骤</h5><p>我们以这个网址——<a target="_blank" rel="noopener" href="https://www.gm99.com/">G妹游戏</a>——为例来介绍webpack扣js的一般步骤。我们的目的是抠出密码加密算法的那一部分JS代码。</p>
<p>找到我们要扣JS的那个文件，抓包，打断点分析的过程就不赘述了，直接贴文件：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203290055624.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220329005533139" title="">
                </div>
                <div class="image-caption">image-20220329005533139</div>
            </figure>
<ol>
<li>找到模块加载器(加载模块的方法)</li>
</ol>
<p>根据前面提到的webpack模块化编程的JS代码结构特点，很显然这个模块加载为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> i = &#123;&#125;;</span><br><span class="line">	<span class="keyword">if</span> (i[s])</span><br><span class="line">		<span class="keyword">return</span> i[s].exports;</span><br><span class="line">	<span class="keyword">var</span> n = i[s] = &#123;</span><br><span class="line">        <span class="attr">exports</span>: &#123;&#125;,</span><br><span class="line">        <span class="attr">id</span>: s,</span><br><span class="line">        <span class="attr">loaded</span>: !<span class="number">1</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> t[s].call(n.exports, n, n.exports, e),</span><br><span class="line">    n.loaded = !<span class="number">0</span>,</span><br><span class="line">    n.exports</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>构造一个自执行。可以是构造一个空的自执行，也可以是把网站的自执行JS扣下来，然后删除不必要的方法。如下：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">!<span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> i = &#123;&#125;;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (i[s])</span><br><span class="line">            <span class="keyword">return</span> i[s].exports;</span><br><span class="line">        <span class="keyword">var</span> n = i[s] = &#123;</span><br><span class="line">            <span class="attr">exports</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">id</span>: s,</span><br><span class="line">            <span class="attr">loaded</span>: !<span class="number">1</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> t[s].call(n.exports, n, n.exports, e),</span><br><span class="line">        n.loaded = !<span class="number">0</span>,</span><br><span class="line">        n.exports</span><br><span class="line">    &#125;</span><br><span class="line">&#125;();</span><br></pre></td></tr></table></figure>
<p>注意构造的这个自执行方法只需要保留模块加载方法。</p>
<ol>
<li>找到并抠出调用的模块。从可供加载的模块列表中抠出包含我们需要的加密方法的模块。</li>
</ol>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203291612665.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220329161258366" title="">
                </div>
                <div class="image-caption">image-20220329161258366</div>
            </figure>
<p>通过抓包，找请求调用栈，定位到密码加密相关的地方。打上断点，调试这个方法，如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203291613208.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220329161353804" title="">
                </div>
                <div class="image-caption">image-20220329161353804</div>
            </figure>
<p>接着断点，接着调试：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203291614519.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220329161453244" title="">
                </div>
                <div class="image-caption">image-20220329161453244</div>
            </figure>
<p>最终找到需要调用的模块如图：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203291616929.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220329161649646" title="">
                </div>
                <div class="image-caption">image-20220329161649646</div>
            </figure>
<p>接着就是抠出这个调用模块，我们可以把整个文件复制下来，我们发现可供加载的模块是一个对象，用数字作为键，模块作为值，为了方便我们把键为0的叫做模块0，键为1的叫做模块1，依此类推。搜索关键代码<code>qe.prototype.encrypt</code>，根据代码缩进，找到封装<code>qe.prototype.encrypt</code>这个方法的模块是模块4，我们拷贝整个模块4的代码，粘贴到我们第二步构建的那个自执行方法的可供加载的模块列表中去，注意是以object的方法，不要用列表形式，同时给这个模块取一个名字，比如就叫做<code>encrypt</code>。</p>
<p>注意到我们前面跟栈的示意图，生成密码的地方是调用模块3的<code>encode</code> 方法，而<code>encode</code>方法是调用模块4的<code>encrypt</code>方法，我们上边已经抠出来了模块4，不要忘了抠出模块3(虽然模块3比较简单，完全可以自己写)。同样的给模块3重新取个名为<code>encode</code>。</p>
<p>最终模块3和模块4抠出来的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">!<span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (i[s])</span><br><span class="line">            <span class="keyword">return</span> i[s].exports;</span><br><span class="line">        <span class="keyword">var</span> n = i[s] = &#123;</span><br><span class="line">            <span class="attr">exports</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">id</span>: s,</span><br><span class="line">            <span class="attr">loaded</span>: !<span class="number">1</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> t[s].call(n.exports, n, n.exports, e),</span><br><span class="line">            n.loaded = !<span class="number">0</span>,</span><br><span class="line">            n.exports</span><br><span class="line">    &#125;</span><br><span class="line">&#125;(&#123;</span><br><span class="line">    <span class="string">&quot;encrypt&quot;</span>: <span class="function"><span class="keyword">function</span>(<span class="params">t, e, i</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> s, n, r;</span><br><span class="line">        s = <span class="function"><span class="keyword">function</span>(<span class="params">t, e, i</span>) </span>&#123;</span><br><span class="line">            </span><br><span class="line">            	    <span class="comment">/* 省略若干行代码 */</span></span><br><span class="line">                    </span><br><span class="line">                    qe.prototype.decrypt = <span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="built_in">this</span>.getKey().decrypt(ye(t))</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (t) &#123;</span><br><span class="line">                            <span class="keyword">return</span> !<span class="number">1</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ,</span><br><span class="line">                    qe.prototype.encrypt = <span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> be(<span class="built_in">this</span>.getKey().encrypt(t))</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (t) &#123;</span><br><span class="line">                            <span class="keyword">return</span> !<span class="number">1</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; </span><br><span class="line"></span><br><span class="line">                    <span class="comment">/* 省略若干行代码 */</span></span><br><span class="line"></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        .call(e, i, e, t),</span><br><span class="line">        !(<span class="keyword">void</span> <span class="number">0</span> !== s &amp;&amp; (t.exports = s))</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;encode&quot;</span>: <span class="function"><span class="keyword">function</span>(<span class="params">t, e, i</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> s;</span><br><span class="line">        s = <span class="function"><span class="keyword">function</span>(<span class="params">t, e, s</span>) </span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">n</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="string">&quot;undefined&quot;</span> != <span class="keyword">typeof</span> r &amp;&amp; (<span class="built_in">this</span>.jsencrypt = <span class="keyword">new</span> r.JSEncrypt,</span><br><span class="line">                <span class="built_in">this</span>.jsencrypt.setPublicKey(<span class="string">&quot;-----BEGIN PUBLIC KEY-----MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDq04c6My441Gj0UFKgrqUhAUg+kQZeUeWSPlAU9fr4HBPDldAeqzx1UR92KJHuQh/zs1HOamE2dgX9z/2oXcJaqoRIA/FXysx+z2YlJkSk8XQLcQ8EBOkp//MZrixam7lCYpNOjadQBb2Ot0U/Ky+jF2p+Ie8gSZ7/u+Wnr5grywIDAQAB-----END PUBLIC KEY-----&quot;</span>))</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> r = i(<span class="number">4</span>);</span><br><span class="line">            n.prototype.encode = <span class="function"><span class="keyword">function</span>(<span class="params">t, e</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> i = e ? e + <span class="string">&quot;|&quot;</span> + t : t;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">encodeURIComponent</span>(<span class="built_in">this</span>.jsencrypt.encrypt(i))</span><br><span class="line">            &#125;</span><br><span class="line">            ,</span><br><span class="line">            s.exports = n</span><br><span class="line">        &#125;</span><br><span class="line">        .call(e, i, e, t),</span><br><span class="line">        !(<span class="keyword">void</span> <span class="number">0</span> !== s &amp;&amp; (t.exports = s))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>扣完代码之后，我们将整个代码放到浏览器中执行一遍，验证下抠的JS代码没有问题：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203291634343.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220329163418015" title="">
                </div>
                <div class="image-caption">image-20220329163418015</div>
            </figure>
<ol>
<li>导出相应的模块方法。我们只需要导出模块加载函数就行，因为加密中用到的<code>encode</code>和<code>encrypt</code>方法都是通过模块加载函数加载的。我们可以在自执行方法外面定义一个全局变量，然后把模块加载函数赋值给这个全局变量，这样就可以从自执行函数内部导出模块加载方法了。代码如下：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对外暴露模块加载函数</span></span><br><span class="line"><span class="keyword">var</span> _n = e;</span><br><span class="line"></span><br><span class="line">!<span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (i[s])</span><br><span class="line">            <span class="keyword">return</span> i[s].exports;</span><br><span class="line">        <span class="keyword">var</span> n = i[s] = &#123;</span><br><span class="line">            <span class="attr">exports</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">id</span>: s,</span><br><span class="line">            <span class="attr">loaded</span>: !<span class="number">1</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> t[s].call(n.exports, n, n.exports, e),</span><br><span class="line">            n.loaded = !<span class="number">0</span>,</span><br><span class="line">            n.exports</span><br><span class="line">    &#125;</span><br><span class="line">&#125;(&#123;</span><br><span class="line">    <span class="string">&quot;encrypt&quot;</span>: <span class="function"><span class="keyword">function</span>(<span class="params">t, e, i</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 省略函数体</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;encode&quot;</span>: <span class="function"><span class="keyword">function</span>(<span class="params">t, e, i</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 省略函数体</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>修改完代码之后，我们在浏览器中验证一下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203291814720.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220329181407362" title="">
                </div>
                <div class="image-caption">image-20220329181407362</div>
            </figure>
<p>可以看到成功加载了<code>encrypt</code>函数，加载<code>encode</code>函数的时候报错，我们打上断点调试，发现报错的那一行代码是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> r =  i(<span class="number">4</span>);</span><br></pre></td></tr></table></figure>
<p>这里的i是<code>encode</code>的第三个参数，是<code>t[s].call(n.exports, n, n.exports, e)</code>的第四个参数即模块加载函数(前面提到过call的第一个参数是影响this指针的参数)，表示调用模块4，然而模块4我们改名为<code>encrypt</code>(熟悉的模块3调用模块4，但是模块3盒模块4我们都改名了，😮‍💨真是给自己挖坑，其实完全跟原始JS的保持一致的命名)。所以这里我们只需要把这行代码改为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> r =  i(<span class="string">&quot;encrpty&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>改好之后，我们再次在浏览器中调试，没有报错。</p>
<ol>
<li>编写代码测试。</li>
</ol>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203292001605.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220329200136091" title="">
                </div>
                <div class="image-caption">image-20220329200136091</div>
            </figure>
<p>可以看到测试结果符合预期。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203292004706.png" alt="output-onlinepngtools" title="">
                </div>
                <div class="image-caption">output-onlinepngtools</div>
            </figure>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>这篇文章主要介绍了webpack模块化以及如何从中抠出相应的模块。抠JS的方法，总结起来分五步：</p>
<ul>
<li>找到模块加载器</li>
<li>构造自执行</li>
<li>找到并抠出需要的模块</li>
<li>导出相应的模块方法</li>
<li>编写代码测试</li>
</ul>

    

        <a href="/JS%E9%80%86%E5%90%91%E4%B9%8Bwebpack%E6%89%A3JS%E6%80%9D%E8%B7%AF/" class="post-more waves-effect waves-button">
            Continue reading...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JS/" rel="tag">JS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WebPack/" rel="tag">WebPack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%80%86%E5%90%91/" rel="tag">逆向</a></li></ul>

    </div>
    
</article>

        </li>
    
        <li class="post-list-item fade">
            <article id="post-JS逆向之WebSocket协议"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time class="post-time" title="2022-03-27 17:45:51" datetime="2022-03-27T09:45:51.000Z"  itemprop="datePublished">2022-03-27</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/JS%E9%80%86%E5%90%91/">JS逆向</a></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/JS%E9%80%86%E5%90%91%E4%B9%8BWebSocket%E5%8D%8F%E8%AE%AE/">JS逆向之WebSocket协议</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent">

    
        <div align="center"><iframe width="560" height="315" src="https://www.youtube.com/embed/Hlp8XD0R5qo" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>



<blockquote>
<p>免责声明：<strong>本文章中所有内容仅供学习交流，抓包内容、敏感网址、数据接口均已做脱敏处理，严禁用于商业用途和非法用途，否则由此产生的一切后果均与作者无关，若有侵权，请联系我立即删除！</strong></p>
</blockquote>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本文的目的不是着重讲WebSockets，而是解决在JS逆向过程中遇到网站使用WebSockets协议的时候如何处理。</p>
<h3 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h3><h4 id="什么是WebSocket"><a href="#什么是WebSocket" class="headerlink" title="什么是WebSocket"></a>什么是WebSocket</h4><p>WebSocket是一种网络传输协议，可在单个TCP连接上进行全双工通信，位于OSI模型的应用层。WebSocket使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向客户端推送数据。WebSocket的最大特点就是浏览器和服务器只需要完成一次握手，两者之间就可以创建持久性的连接，并进行双向数据传输。</p>
<p>WebSocket协议规范将<code>ws</code>（WebSocket）和<code>wss</code>（WebSocket Secure）定义为两个新的统一资源标识符(URI)方案，分别对应明文和加密连接。除了方案名称和片段ID（不支持<code>#</code>）之外，其余的URI组件都被定义为此URI的通用语法。</p>
<p><img src="https://img.heshipeng.com/202203272028182.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="img"></p>
<p>WebSocket的其它特点：</p>
<ol>
<li>建立在 TCP 协议之上，服务器端的实现比较容易。</li>
<li>与 HTTP 协议有着良好的兼容性。默认端口也是80和443，并且握手阶段采用 HTTP 协议，因此握手时不容易屏蔽，能通过各种 HTTP 代理服务器。</li>
<li>数据格式比较轻量，性能开销小，通信高效。</li>
<li>可以发送文本(json/xml/纯文本)，也可以发送二进制数据(protobuf)。</li>
<li>没有同源限制，客户端可以与任意服务器通信。</li>
<li>协议标识符是<code>ws</code>（如果加密，则为<code>wss</code>），服务器网址就是 URL。如ws(wss)://example.com:80/some/path。</li>
</ol>
<p><img src="https://img.heshipeng.com/202203272034038.jpg?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="img"></p>
<h4 id="为什么需要WebSocket"><a href="#为什么需要WebSocket" class="headerlink" title="为什么需要WebSocket"></a>为什么需要WebSocket</h4><p>我们已经有了 HTTP 协议，为什么还需要另一个协议？它能带来什么好处？答案很简单，因为 HTTP 协议有一个缺陷：通信只能由客户端发起。试想一下，现在有个场景，比如聊天室。如果A用户与B用户聊天，如果用HTTP协议，只能是A用户客户端向服务器发起一个HTTP请求，询问是否有B用户的消息，同样的对于B用户也一样。这种单向请求的特点，注定了如果服务器有连续的状态变化，客户端要获知就非常麻烦。就只能用轮询的方式：每隔一段时间就发出一个询问，了解服务器有没有新的信息。</p>
<p>轮询的效率低，非常浪费资源（因为必须不停连接，或者 HTTP 连接始终打开）。因此，工程师们一直在思考，有没有更好的方法。WebSocket 就是这样发明的。</p>
<h4 id="握手协议"><a href="#握手协议" class="headerlink" title="握手协议"></a>握手协议</h4><p>WebSocket 是独立的、创建在TCP上的协议。Websocket 通过HTTP</p>
<h5 id="协议说明"><a href="#协议说明" class="headerlink" title="协议说明"></a>协议说明</h5><p>客户端请求：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /chat HTTP/1.1</span><br><span class="line">Host: server.example.com</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Origin: http://example.com</span><br><span class="line">Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==</span><br><span class="line">Sec-WebSocket-Protocol: chat, superchat</span><br><span class="line">Sec-WebSocket-Version: 13</span><br></pre></td></tr></table></figure>
<p>服务器回应：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 101 Switching Protocols</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span><br><span class="line">Sec-WebSocket-Protocol: chat</span><br></pre></td></tr></table></figure>
<p>字段说明：</p>
<ul>
<li>Connection必须设置Upgrade，表示客户端希望连接升级。</li>
<li>Upgrade字段必须设置Websocket，表示希望升级到Websocket协议。</li>
<li>Sec-WebSocket-Key是随机的字符串，服务器端会用这些数据来构造出一个SHA-1的信息摘要，然后进行Base64编码。</li>
<li>Sec-WebSocket-Version 表示支持的Websocket版本。</li>
<li>Origin字段是必须的。如果缺少origin字段，WebSocket服务器需要回复HTTP 403 状态码（禁止访问）。</li>
</ul>
<h4 id="WebSocket-NodeJS版的客户端API"><a href="#WebSocket-NodeJS版的客户端API" class="headerlink" title="WebSocket NodeJS版的客户端API"></a>WebSocket NodeJS版的客户端API</h4><h5 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h5><p>客户端代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> WebSocket = <span class="built_in">require</span>(<span class="string">&#x27;ws&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">&#x27;ws://localhost:3000&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接受</span></span><br><span class="line">ws.on(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">message</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(message.toString())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当数字达到 10 时，断开连接</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Number</span>.parseInt(message) === <span class="number">10</span>) &#123;</span><br><span class="line">        ws.send(<span class="string">&#x27;close&#x27;</span>);</span><br><span class="line">        ws.close()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>服务端代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> WebSocket = <span class="built_in">require</span>(<span class="string">&#x27;ws&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> WebSocketServer = WebSocket.Server;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 websocket 服务器 监听在 3000 端口</span></span><br><span class="line"><span class="keyword">const</span> wss = <span class="keyword">new</span> WebSocketServer(&#123;<span class="attr">port</span>: <span class="number">3000</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务器被客户端连接</span></span><br><span class="line">wss.on(<span class="string">&#x27;connection&#x27;</span>, <span class="function">(<span class="params">ws</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 通过 ws 对象，就可以获取到客户端发送过来的信息和主动推送信息给客户端</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">setInterval</span>(<span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        ws.send(i++) <span class="comment">// 每隔 1 秒给连接方报一次数</span></span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h5 id="详细API介绍"><a href="#详细API介绍" class="headerlink" title="详细API介绍"></a>详细API介绍</h5><ol>
<li>WebSocket 构造函数</li>
</ol>
<p>WebSocket 对象作为一个构造函数，用于新建 WebSocket 实例。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">&#x27;ws://localhost:8080&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>执行上面语句之后，客户端就会与服务器进行连接。</p>
<ol>
<li>webSocket.readyState</li>
</ol>
<p><code>readyState</code>属性返回实例对象的当前状态，共有四种。</p>
<ul>
<li>CONNECTING：值为0，表示正在连接。</li>
<li>OPEN：值为1，表示连接成功，可以通信了。</li>
<li>CLOSING：值为2，表示连接正在关闭。</li>
<li>CLOSED：值为3，表示连接已经关闭，或者打开连接失败。</li>
</ul>
<p>下面是一个示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (ws.readyState) &#123;</span><br><span class="line">  <span class="keyword">case</span> WebSocket.CONNECTING:</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> WebSocket.OPEN:</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> WebSocket.CLOSING:</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> WebSocket.CLOSED:</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="comment">// this never happens</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>webSocket.onopen</li>
</ol>
<p>实例对象的<code>onopen</code>属性，用于指定连接成功后的回调函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ws.onopen = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  ws.send(<span class="string">&#x27;Hello Server!&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果要指定多个回调函数，可以使用<code>addEventListener</code>方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ws.addEventListener(<span class="string">&#x27;open&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  ws.send(<span class="string">&#x27;Hello Server!&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ol>
<li>webSocket.onclose</li>
</ol>
<p>实例对象的<code>onclose</code>属性，用于指定连接关闭后的回调函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ws.onclose = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> code = event.code;</span><br><span class="line">  <span class="keyword">var</span> reason = event.reason;</span><br><span class="line">  <span class="keyword">var</span> wasClean = event.wasClean;</span><br><span class="line">  <span class="comment">// handle close event</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ws.addEventListener(<span class="string">&quot;close&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> code = event.code;</span><br><span class="line">  <span class="keyword">var</span> reason = event.reason;</span><br><span class="line">  <span class="keyword">var</span> wasClean = event.wasClean;</span><br><span class="line">  <span class="comment">// handle close event</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ol>
<li>webSocket.onmessage</li>
</ol>
<p>实例对象的<code>onmessage</code>属性，用于指定收到服务器数据后的回调函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ws.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> data = event.data;</span><br><span class="line">  <span class="comment">// 处理数据</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ws.addEventListener(<span class="string">&quot;message&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> data = event.data;</span><br><span class="line">  <span class="comment">// 处理数据</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>注意，服务器数据可能是文本，也可能是二进制数据（<code>blob</code>对象或<code>Arraybuffer</code>对象）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ws.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">typeof</span> event.data === <span class="built_in">String</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Received data string&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(event.data <span class="keyword">instanceof</span> <span class="built_in">ArrayBuffer</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> buffer = event.data;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Received arraybuffer&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>除了动态判断收到的数据类型，也可以使用<code>binaryType</code>属性，显式指定收到的二进制数据类型。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 收到的是 blob 数据</span></span><br><span class="line">ws.binaryType = <span class="string">&quot;blob&quot;</span>;</span><br><span class="line">ws.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(e.data.size);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 收到的是 ArrayBuffer 数据</span></span><br><span class="line">ws.binaryType = <span class="string">&quot;arraybuffer&quot;</span>;</span><br><span class="line">ws.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(e.data.byteLength);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol>
<li>webSocket.send()</li>
</ol>
<p>实例对象的<code>send()</code>方法用于向服务器发送数据。</p>
<p>发送文本的例子。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ws.send(<span class="string">&#x27;your message&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>发送 Blob 对象的例子。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> file = <span class="built_in">document</span></span><br><span class="line">  .querySelector(<span class="string">&#x27;input[type=&quot;file&quot;]&#x27;</span>)</span><br><span class="line">  .files[<span class="number">0</span>];</span><br><span class="line">ws.send(file);</span><br></pre></td></tr></table></figure>
<p>发送 ArrayBuffer 对象的例子。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sending canvas ImageData as ArrayBuffer</span></span><br><span class="line"><span class="keyword">var</span> img = canvas_context.getImageData(<span class="number">0</span>, <span class="number">0</span>, <span class="number">400</span>, <span class="number">320</span>);</span><br><span class="line"><span class="keyword">var</span> binary = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(img.data.length);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; img.data.length; i++) &#123;</span><br><span class="line">  binary[i] = img.data[i];</span><br><span class="line">&#125;</span><br><span class="line">ws.send(binary.buffer);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol>
<li>webSocket.bufferedAmount</li>
</ol>
<p>实例对象的<code>bufferedAmount</code>属性，表示还有多少字节的二进制数据没有发送出去。它可以用来判断发送是否结束。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">10000000</span>);</span><br><span class="line">socket.send(data);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (socket.bufferedAmount === <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="comment">// 发送完毕</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 发送还没结束</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>webSocket.onerror</li>
</ol>
<p>实例对象的<code>onerror</code>属性，用于指定报错时的回调函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">socket.onerror = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// handle error event</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">socket.addEventListener(<span class="string">&quot;error&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// handle error event</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="逆向案例介绍"><a href="#逆向案例介绍" class="headerlink" title="逆向案例介绍"></a>逆向案例介绍</h4><h5 id="蝌蚪聊天室"><a href="#蝌蚪聊天室" class="headerlink" title="蝌蚪聊天室"></a>蝌蚪聊天室</h5><p>网址：<a target="_blank" rel="noopener" href="http://kedou.workerman.net/">http://kedou.workerman.net/</a></p>
<p>按照JS逆向的步骤，即抓包，分析包信息，调试，本地运行。先进行抓包，网络面板过滤器选择WS，如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203272250420.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220327225044186" title="">
                </div>
                <div class="image-caption">image-20220327225044186</div>
            </figure>
<p>点中这个WebSocket请求，然后切换到Message面板，如图：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203272253279.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220327225356124" title="">
                </div>
                <div class="image-caption">image-20220327225356124</div>
            </figure>
<p>这个Message信息是实时的消息，因为WebSocket一经连接，除非断开就会一直存在，会实时发送消息。上边每条消息前面都有一个箭头，红色的表示服务器发给客户端的，绿色的箭头表示我们发送给服务器的。随便选中一条信息，可以看到它的详细信息，很显然这里的消息格式是使用JSON。</p>
<p>接下来就是断点分析，我们可以通过这个WebSocket请求的Initiator找到相应的代码：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203272301258.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220327230133082" title="">
                </div>
                <div class="image-caption">image-20220327230133082</div>
            </figure>
<p>也可以通过全局搜索关键字<code>.onopen</code>，如图：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203272303646.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220327230318560" title="">
                </div>
                <div class="image-caption">image-20220327230318560</div>
            </figure>
<p>不管用什么方法，都会定位到如下的代码段：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203272304410.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220327230426306" title="">
                </div>
                <div class="image-caption">image-20220327230426306</div>
            </figure>
<p>点进去<code>onMessage</code>方法， 然后打上断点，然后刷新网页，成功断上：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203272305422.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220327230536234" title="">
                </div>
                <div class="image-caption">image-20220327230536234</div>
            </figure>
<p>这里的数据消息比较简单，明文JSON，没有任何的加密。</p>
<h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><p><a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2017/05/websocket.html">WebSocket 教程</a></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>WebSocket与HTTP都是网络传输协议，它们的相同点是：</p>
<ul>
<li>建立在TCP之上，通过TCP协议来传输数据</li>
<li>都是可靠性传输协议</li>
<li>都是应用层协议</li>
</ul>
<p>它们的不同点：</p>
<ul>
<li>WebSocket是HTML5中的协议，支持持久连接，HTTP不支持持久连接</li>
<li>HTTP是单向协议，只能由客户端发起，做不到服务器主动向客户端推送信息</li>
</ul>

    

        <a href="/JS%E9%80%86%E5%90%91%E4%B9%8BWebSocket%E5%8D%8F%E8%AE%AE/" class="post-more waves-effect waves-button">
            Continue reading...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JS/" rel="tag">JS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WebSockets/" rel="tag">WebSockets</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%80%86%E5%90%91/" rel="tag">逆向</a></li></ul>

    </div>
    
</article>

        </li>
    
        <li class="post-list-item fade">
            <article id="post-JS逆向之加解密进阶篇"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time class="post-time" title="2022-03-22 20:43:08" datetime="2022-03-22T12:43:08.000Z"  itemprop="datePublished">2022-03-22</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/JS%E9%80%86%E5%90%91/">JS逆向</a></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/JS%E9%80%86%E5%90%91%E4%B9%8B%E5%8A%A0%E8%A7%A3%E5%AF%86%E8%BF%9B%E9%98%B6%E7%AF%87/">JS逆向之加解密进阶篇</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent">

    
        <h4 id="不一样的加密算法"><a href="#不一样的加密算法" class="headerlink" title="不一样的加密算法"></a>不一样的加密算法</h4><h5 id="栅栏密码"><a href="#栅栏密码" class="headerlink" title="栅栏密码"></a>栅栏密码</h5><p>栅栏密码(Rail-fence Cipher)就是把要加密的明文分为N个一组，然后把每组的第一个字符组合，每组的第二个字符组合…每组的第N个(最后一个分组可能不足N个)个字符组合，最后把他们全部连接起来就是密文。这里以2栏栅栏加密为例。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203221629016.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220322162944513" title="">
                </div>
                <div class="image-caption">image-20220322162944513</div>
            </figure>
<p>以一句话Are you ok为例：</p>
<ol>
<li>去空格，结果为Areyouok</li>
<li><p>分组，结果为Ar ey ou ok</p>
</li>
<li><p>重组</p>
<ul>
<li>第一组：Aeoo</li>
<li>第二组：ryuk</li>
</ul>
</li>
<li>生成密文，结果为：Aeooryuk</li>
</ol>
<p><strong>Python代码演示</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span>(<span class="params">flag, num</span>):</span></span><br><span class="line">    <span class="keyword">from</span> math <span class="keyword">import</span> ceil</span><br><span class="line">    length = <span class="built_in">len</span>(flag)</span><br><span class="line">    lines = ceil(length / num)</span><br><span class="line">    arr = [flag[i:i+num] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, lines * num, num)]</span><br><span class="line">    flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(arr[<span class="number">0</span>])):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> arr:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                flag += j[i]</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span>(<span class="params">flag, num</span>):</span></span><br><span class="line">    length = <span class="built_in">len</span>(flag)   <span class="comment"># flag的长度</span></span><br><span class="line">    lines = length // num   <span class="comment"># 判断共有几层并减一</span></span><br><span class="line">    remainder = num * (lines + <span class="number">1</span>) - length  <span class="comment"># 相差的数量</span></span><br><span class="line">    <span class="comment"># 补全flag</span></span><br><span class="line">    result = flag[:length-lines*remainder]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(remainder-<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">        result += flag[length - (i + <span class="number">1</span>) * lines:length - i * lines] + <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    <span class="comment"># 还原flag</span></span><br><span class="line">    lines += <span class="number">1</span></span><br><span class="line">    arr = [result[i:i + lines] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(result), lines)]</span><br><span class="line">    flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(arr[<span class="number">0</span>])):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> arr:</span><br><span class="line">            flag += j[i]</span><br><span class="line">    <span class="keyword">return</span> flag[:length]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(encode(<span class="string">&quot;Are you ok&quot;</span>, <span class="number">2</span>))	<span class="comment"># Aeyuor o k</span></span><br><span class="line">    <span class="built_in">print</span>(decode(<span class="string">&quot;Aeyuor o k&quot;</span>, <span class="number">2</span>))	<span class="comment"># Are you ok</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="列位移密码"><a href="#列位移密码" class="headerlink" title="列位移密码"></a>列位移密码</h5><p>列位移密码(Columnar Transposition Cipher)是一种比较简单，易于实现的换位密码，通过一个简单的规则将明文打乱混合成密文。将明文填入事先约定填充的行列数，如果明文不能填充完表格，可以约定使用某个字母进行填充，然后根据密钥在字母表中出现的先后顺序进行编号，根据编码即可推出密文。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203221940630.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220322194007474" title="">
                </div>
                <div class="image-caption">image-20220322194007474</div>
            </figure>
<p>还是以那句话Are you ok为明文，以car为密钥，x为填充字符：</p>
<ol>
<li>去空格，结果为：Areyouok</li>
<li>因为密钥car的长度为3，所以以3个字符为一个单位分组，如下：</li>
</ol>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">c</th>
<th style="text-align:center">a</th>
<th style="text-align:center">r</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">A</td>
<td style="text-align:center">r</td>
<td style="text-align:center">e</td>
</tr>
<tr>
<td style="text-align:center">y</td>
<td style="text-align:center">o</td>
<td style="text-align:center">u</td>
</tr>
<tr>
<td style="text-align:center">o</td>
<td style="text-align:center">k</td>
<td style="text-align:center">x</td>
</tr>
</tbody>
</table>
</div>
<p>最后一组只有2个元素不足三个，所以用x填充。由于密钥car的字母顺序排序是a&gt;c&gt;r，所以上述列排序也要根据这个顺序重新排列，如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">a</th>
<th style="text-align:center">c</th>
<th style="text-align:center">r</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">r</td>
<td style="text-align:center">A</td>
<td style="text-align:center">e</td>
</tr>
<tr>
<td style="text-align:center">o</td>
<td style="text-align:center">y</td>
<td style="text-align:center">u</td>
</tr>
<tr>
<td style="text-align:center">k</td>
<td style="text-align:center">o</td>
<td style="text-align:center">x</td>
</tr>
</tbody>
</table>
</div>
<p>重新排序完成之后，从第一列到最后一列按列取值组成的字符串就是密文了，很显然密钥是不能出现在明文中的，填充字符可以出现在明文中，所以每一列的第一个字符被忽略，最终的密文为：rokAyoeux。</p>
<p><strong>Python代码演示</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pycipher <span class="keyword">import</span> ColTrans</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ColTrans(<span class="string">&quot;car&quot;</span>).encipher(<span class="string">&#x27;Are you ok&#x27;</span>) <span class="comment"># ROKAYOEU</span></span><br><span class="line">ColTrans(<span class="string">&quot;car&quot;</span>).decipher(<span class="string">&#x27;ROKAYOEU&#x27;</span>)   <span class="comment"># AREYOUOK</span></span><br></pre></td></tr></table></figure>
<h5 id="凯撒密码"><a href="#凯撒密码" class="headerlink" title="凯撒密码"></a>凯撒密码</h5><p>凯撒密码(Caesar Cipher或称凯撒加密，凯撒变换，变换加密，位移加密)是一种替换加密，明文中的所有字母都在字母表上向后(或向前)按照一个固定的数目进行偏移后被替换成密文。例，当偏移量是3的时候，所有的字母A都将被替换成D，B变成E，依此类推。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203222207955.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220322220707572" title="">
                </div>
                <div class="image-caption">image-20220322220707572</div>
            </figure>
<p> 依旧以Are you ok为例：</p>
<ol>
<li><p>去除空格，变为Areyouok</p>
</li>
<li><p>以5作为偏移映射，A对应F，r对应w，e对应j，依此往下推，转换后的密文为Fwjdtztp。</p>
</li>
</ol>
<p><strong>Python代码演示</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt_char</span>(<span class="params">char, key</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">&#x27;A&#x27;</span>) + (<span class="built_in">ord</span>(char) - <span class="built_in">ord</span>(<span class="string">&#x27;A&#x27;</span>) + key) % <span class="number">26</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt_message</span>(<span class="params">message, key</span>):</span></span><br><span class="line">    message = message.upper()</span><br><span class="line">    cipher = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> message:</span><br><span class="line">        <span class="keyword">if</span> char <span class="keyword">not</span> <span class="keyword">in</span> <span class="string">&#x27; ,.&#x27;</span>:</span><br><span class="line">            cipher += encrypt_char(char, key)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            cipher += char</span><br><span class="line">    <span class="keyword">return</span> cipher</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt_char</span>(<span class="params">char, key</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">&#x27;A&#x27;</span>) + (<span class="built_in">ord</span>(char) - <span class="built_in">ord</span>(<span class="string">&#x27;A&#x27;</span>) + <span class="number">26</span> - key) % <span class="number">26</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt_message</span>(<span class="params">cipher, key</span>):</span></span><br><span class="line">    cipher = cipher.upper()</span><br><span class="line">    message = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> cipher:</span><br><span class="line">        <span class="keyword">if</span> char <span class="keyword">not</span> <span class="keyword">in</span> <span class="string">&#x27; ,.&#x27;</span>:</span><br><span class="line">            message += decrypt_char(char, key)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            message += char</span><br><span class="line">    <span class="keyword">return</span> message</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(encrypt_message(<span class="string">&quot;Are you ok&quot;</span>, <span class="number">5</span>))	<span class="comment"># FWJ DTZ TP</span></span><br><span class="line">    <span class="built_in">print</span>(decrypt_message(<span class="string">&quot;FWJ DTZ TP&quot;</span>, <span class="number">5</span>)) <span class="comment"># ARE YOU OK</span></span><br></pre></td></tr></table></figure>
<h5 id="其它加密"><a href="#其它加密" class="headerlink" title="其它加密"></a>其它加密</h5><p>JSfuck仅使用6个字符，即[]+()!，来编写js程序。</p>
<p>jother是一种可以运用于javascript语言中利用少量字符构造精简的匿名函数方法对于字符串进行的编码方式。其中8个少量字符包括：!+()[]{}。只用这些字符就可以完成任意字符串的编码。</p>
<p>jjencode将JS代码转换成只有符号的字符串。</p>
<p>aaencode可以将JS代码转换成常用的网络表情，也就是我们说的颜文字JS加密。</p>
<h4 id="JS加密上的实例分析与变化"><a href="#JS加密上的实例分析与变化" class="headerlink" title="JS加密上的实例分析与变化"></a>JS加密上的实例分析与变化</h4><h5 id="凯撒加密变种加密算法分析"><a href="#凯撒加密变种加密算法分析" class="headerlink" title="凯撒加密变种加密算法分析"></a>凯撒加密变种加密算法分析</h5><p>密文：lQyjcvi|dcQR pktg t 2 cxl 9tixQR0 wxujzzxg0 gxijgc cxl 9tixQR V t 3 ZYY0rQRR</p>
<p>算法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_$aU</span>(<span class="params">_$Fj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _$U4 = _$Fj.length;</span><br><span class="line">    <span class="keyword">var</span> _$_L, _$cu = <span class="keyword">new</span> <span class="built_in">Array</span>(_$U4 - <span class="number">1</span>), _$h9 = _$Fj.charCodeAt(<span class="number">0</span>) - <span class="number">97</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> _$1B = <span class="number">0</span>, _$lp = <span class="number">1</span>; _$lp &lt; _$U4; ++_$lp) &#123;</span><br><span class="line">        _$_L = _$Fj.charCodeAt(_$lp);</span><br><span class="line">        <span class="keyword">if</span> (_$_L &gt;= <span class="number">40</span> &amp;&amp; _$_L &lt; <span class="number">92</span>) &#123;</span><br><span class="line">            _$_L += _$h9;</span><br><span class="line">            <span class="keyword">if</span> (_$_L &gt;= <span class="number">92</span>)</span><br><span class="line">                _$_L -= <span class="number">52</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_$_L &gt;= <span class="number">97</span> &amp;&amp; _$_L &lt; <span class="number">127</span>) &#123;</span><br><span class="line">            _$_L += _$h9;</span><br><span class="line">            <span class="keyword">if</span> (_$_L &gt;= <span class="number">127</span>)</span><br><span class="line">                _$_L -= <span class="number">30</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        _$cu[_$1B++] = _$_L;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">String</span>.fromCharCode.apply(<span class="literal">null</span>, _$cu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用上述算法解密密文结果如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203231807071.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220323180744951" title="">
                </div>
                <div class="image-caption">image-20220323180744951</div>
            </figure>
<p>可以看到上面是一个无限debugger的字符串，然后通过eval调用可以达到无限debugger的目的，通过前面学习了凯撒密码之后，我们除了可以使用hook的方式绕过无限debugger，还可以使用凯撒密码达到目的，我们删除密文中的<code>wxujzzxg0</code>，然后执行：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203231813548.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220323181330460" title="">
                </div>
                <div class="image-caption">image-20220323181330460</div>
            </figure>
<p>可以看到，同样干掉了debugger关键字。</p>
<h4 id="常规加密算法的变种"><a href="#常规加密算法的变种" class="headerlink" title="常规加密算法的变种"></a>常规加密算法的变种</h4><h5 id="借鉴古典密码学改造现在密码学"><a href="#借鉴古典密码学改造现在密码学" class="headerlink" title="借鉴古典密码学改造现在密码学"></a>借鉴古典密码学改造现在密码学</h5><p>看一段AES实际案例(某常见人机验证码代码部分案例)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> CryptoJS = <span class="built_in">require</span>(<span class="string">&quot;crypto-js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> key = <span class="string">&quot;ABC1234567891234&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> iv = <span class="string">&quot;1234567812345678&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> CryptoJS.AES.encrypt(text, CryptoJS.enc.Utf8.parse(key), &#123;</span><br><span class="line">        <span class="attr">iv</span>: CryptoJS.enc.Utf8.parse(iv),</span><br><span class="line">        <span class="attr">mode</span>: CryptoJS.mode.CBC,</span><br><span class="line">        <span class="attr">padding</span>: CryptoJS.pad.Pkcs7</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decrypt</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = CryptoJS.AES.decrypt(text, CryptoJS.enc.Utf8.parse(key), &#123;</span><br><span class="line">        <span class="attr">iv</span>: CryptoJS.enc.Utf8.parse(iv),</span><br><span class="line">        <span class="attr">mode</span>: CryptoJS.mode.CBC,</span><br><span class="line">        <span class="attr">padding</span>: CryptoJS.pad.Pkcs7</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> result.toString(CryptoJS.enc.Utf8);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> encrypted = encrypt(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> s = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; encrypted.ciphertext.sigBytes; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> x = encrypted.ciphertext.words[i &gt;&gt;&gt; <span class="number">2</span>] &gt;&gt;&gt; <span class="number">24</span> - i % <span class="number">4</span> * <span class="number">8</span> &amp; <span class="number">255</span>;</span><br><span class="line">    s.push(x)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> data = encrypt(<span class="built_in">String</span>.fromCharCode.apply(<span class="literal">null</span>, s)).toString();</span><br><span class="line"><span class="built_in">console</span>.log(encrypted.toString());	<span class="comment">// 6S3YRylMmp9vIFOplWxypw==</span></span><br><span class="line"><span class="built_in">console</span>.log(data);					<span class="comment">// u79HHbvmZtoSScagKO2JsQzytZH1L5SJGSh338DbaMA=</span></span><br><span class="line"><span class="built_in">console</span>.log(decrypt(data));			<span class="comment">// é-ØG)L  o S© lr§</span></span><br></pre></td></tr></table></figure>
<p>如上，假如加密代码出现了cryptojs关键字，然后让人以为是传统的cryptojs加密，但是实际上做了一点修改，导致如果直接拿data去做解密，会得到的乱码，达到混淆视听的目的。</p>

    

        <a href="/JS%E9%80%86%E5%90%91%E4%B9%8B%E5%8A%A0%E8%A7%A3%E5%AF%86%E8%BF%9B%E9%98%B6%E7%AF%87/" class="post-more waves-effect waves-button">
            Continue reading...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JS/" rel="tag">JS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%80%86%E5%90%91/" rel="tag">逆向</a></li></ul>

    </div>
    
</article>

        </li>
    
        <li class="post-list-item fade">
            <article id="post-JS逆向之混淆JS手动逆向"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time class="post-time" title="2022-03-08 20:24:52" datetime="2022-03-08T12:24:52.000Z"  itemprop="datePublished">2022-03-08</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/JS%E9%80%86%E5%90%91/">JS逆向</a></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/JS%E9%80%86%E5%90%91%E4%B9%8B%E6%B7%B7%E6%B7%86JS%E6%89%8B%E5%8A%A8%E9%80%86%E5%90%91/">JS逆向之混淆JS手动逆向</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent">

    
        <blockquote>
<p> 免责声明：<strong>本文章中所有内容仅供学习交流，抓包内容、敏感网址、数据接口均已做脱敏处理，严禁用于商业用途和非法用途，否则由此产生的一切后果均与作者无关，若有侵权，请联系我立即删除！</strong></p>
</blockquote>
<h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>写作目的：记录手动逆向一个JS高度混淆的网站的整个过程。</p>
<p>网址：aHR0cHM6Ly81NTI0OTY5Ni5jb206Nzc3Ny8=</p>
<h4 id="逆向过程"><a href="#逆向过程" class="headerlink" title="逆向过程"></a>逆向过程</h4><p>话不多说，直接开始调试。输入用户名17777777777和密码123456点击登录，弹出验证码：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203081636681.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220308163635586" title="">
                </div>
                <div class="image-caption">image-20220308163635586</div>
            </figure>
<p><strong>一般来说网站如果出现复杂验证码都会配合JS参数加密增加防护等级</strong>。我们抓包抓到2个XHR请求：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203081638469.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220308163823432" title="">
                </div>
                <div class="image-caption">image-20220308163823432</div>
            </figure>
<p>初步推测第一个请求get是获取验证码，第二个请求check是校验验证码。今天的目标就是破解这两个请求的加密参数与返回值。</p>
<p> 我们观察这2个接口，发现check请求的参数包含get请求的参数，所以只需要解决check请求的参数就行了。</p>
<p>我们直接看check请求，在Source面板打上XHR断点，断住checkv3.php请求：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203081704604.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220308170430516" title="">
                </div>
                <div class="image-caption">image-20220308170430516</div>
            </figure>
<p>在Call Stack中找到一个疑似加密点：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203081705338.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220308170529279" title="">
                </div>
                <div class="image-caption">image-20220308170529279</div>
            </figure>
<p>点击进去，可以看到JS代码基本上是高度混淆的：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203081706000.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220308170617796" title="">
                </div>
                <div class="image-caption">image-20220308170617796</div>
            </figure>
<p>我们把断点断到拼接请求参数的地方：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203091058349.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220309105805200" title="">
                </div>
                <div class="image-caption">image-20220309105805200</div>
            </figure>
<h5 id="逆向URL生成规则"><a href="#逆向URL生成规则" class="headerlink" title="逆向URL生成规则"></a>逆向URL生成规则</h5><p>先看下URL的生成，扣出代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;url&#x27;</span>: _0x15a5d0[_0x59cb56(<span class="number">0x8bc</span>, <span class="number">0x763</span>, <span class="number">0xba1</span>, <span class="string">&#x27;0jdF&#x27;</span>, <span class="number">0x6bd</span>)](_0x15a5d0[_0x59cb56(<span class="number">0x8ea</span>, <span class="number">0x8b8</span>, <span class="number">0x9b2</span>, <span class="string">&#x27;m*3l&#x27;</span>, <span class="number">0xcfc</span>)], _0x36b61f),</span><br></pre></td></tr></table></figure>
<p>我们再取出<code>_0x15a5d0[_0x59cb56(0x8bc, 0x763, 0xba1, &#39;0jdF&#39;, 0x6bd)]</code>放到console上输出，发现其是一个函数：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203091101267.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220309110157210" title="">
                </div>
                <div class="image-caption">image-20220309110157210</div>
            </figure>
<p>点击进去，看到它是一个花指令，就是把两个参数相加：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203091102623.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220309110253933" title="">
                </div>
                <div class="image-caption">image-20220309110253933</div>
            </figure>
<p>所以URL参数的生成实际上是调用一个加法，把两个参数相加。我们再看这个加法传入的2个参数。<code>_0x15a5d0[_0x59cb56(0x8ea, 0x8b8, 0x9b2, &#39;m*3l&#39;, 0xcfc)]</code>和<code>_0x36b61f</code>。</p>
<p><code>`_0x15a5d0[_0x59cb56(0x8ea, 0x8b8, 0x9b2, &#39;m*3l&#39;, 0xcfc)]</code>是一个固定的地址。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203091104606.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220309110445528" title="">
                </div>
                <div class="image-caption">image-20220309110445528</div>
            </figure>
<p><code>_0x36b61f</code>是一个13位数的时间戳。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203091106206.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220309110602734" title="">
                </div>
                <div class="image-caption">image-20220309110602734</div>
            </figure>
<p>所以URL实际上就是一个固定的地址拼接一个13位的时间戳，即/yzmtest/checkv3.php?t={13位时间戳}。</p>
<h5 id="逆向data生成规则"><a href="#逆向data生成规则" class="headerlink" title="逆向data生成规则"></a>逆向data生成规则</h5><p>先扣出data生成那一部分代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;data&#x27;</span>: _0xf828e5[_0x59cb56(<span class="number">0x7c7</span>, <span class="number">0x4a1</span>, <span class="number">0x425</span>, <span class="string">&#x27;F^5Z&#x27;</span>, <span class="number">0x1f3</span>)](<span class="built_in">JSON</span>[_0x2e7c5c(<span class="number">0x9ff</span>, <span class="number">0x5fa</span>, <span class="number">0x813</span>, <span class="string">&#x27;Ra[M&#x27;</span>, <span class="number">0x821</span>) + _0x160f59(<span class="number">0x921</span>, <span class="number">0x690</span>, <span class="number">0x2a4</span>, <span class="string">&#x27;ZP*j&#x27;</span>, <span class="number">0x657</span>)](</span><br><span class="line">    &#123;</span><br><span class="line">         <span class="string">&#x27;d&#x27;</span>: _0x15a5d0[_0x2e7c5c(<span class="number">0x2ce</span>, <span class="number">0x61d</span>, <span class="number">0xa5a</span>, <span class="string">&#x27;4[E4&#x27;</span>, <span class="number">0x33d</span>)](_0x15a5d0[_0x160f59(<span class="number">0x4a2</span>, <span class="number">0x99e</span>, <span class="number">0xb7e</span>, <span class="string">&#x27;ZHhp&#x27;</span>, <span class="number">0xb6b</span>)](_0x15a5d0[_0x59cb56(<span class="number">0x92b</span>, <span class="number">0x683</span>, <span class="number">0x968</span>, <span class="string">&#x27;F^5Z&#x27;</span>, <span class="number">0x9a7</span>)](_0x15a5d0[_0x160f59(<span class="number">0x11f</span>, <span class="number">0x403</span>, <span class="number">0x29d</span>, <span class="string">&#x27;AVXK&#x27;</span>, <span class="number">0x518</span>)](_0x4fd69b[_0x8eb3(<span class="number">0xc7a</span>, <span class="number">0x728</span>, <span class="number">0x704</span>, <span class="string">&#x27;OBf4&#x27;</span>, <span class="number">0xc4c</span>)](<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;&#x27;</span>), _0xf828e5[_0x8eb3(<span class="number">0x136</span>, <span class="number">0x44f</span>, <span class="number">0x748</span>, <span class="string">&#x27;HZxj&#x27;</span>, <span class="number">0x2a3</span>) + <span class="string">&#x27;en&#x27;</span>]), _0x36b61f[_0x556be9(<span class="number">0x5cf</span>, <span class="number">0x870</span>, <span class="number">0x50b</span>, <span class="string">&#x27;Ra[M&#x27;</span>, <span class="number">0x3af</span>) + <span class="string">&#x27;r&#x27;</span>](-(<span class="number">0x2670</span> + -<span class="number">0x77d</span> * -<span class="number">0x2</span> + -<span class="number">0x3568</span> * <span class="number">0x1</span>))), _0xf828e5[_0x160f59(<span class="number">0xae3</span>, <span class="number">0x5f9</span>, <span class="number">0x92d</span>, <span class="string">&#x27;NUpf&#x27;</span>, <span class="number">0x8a5</span>)]),</span><br><span class="line">         <span class="string">&#x27;username&#x27;</span>: _0xf828e5[_0x2e7c5c(<span class="number">0x241</span>, <span class="number">0x70d</span>, <span class="number">0x75c</span>, <span class="string">&#x27;o4oN&#x27;</span>, <span class="number">0x1eb</span>) + _0x8eb3(<span class="number">0xac</span>, <span class="number">0x90</span>, <span class="number">0x5c9</span>, <span class="string">&#x27;o4oN&#x27;</span>, <span class="number">0x3a8</span>)],</span><br><span class="line">         <span class="string">&#x27;password&#x27;</span>: _0xf828e5[_0x2e7c5c(<span class="number">0x4b3</span>, <span class="number">0x757</span>, <span class="number">0x5d1</span>, <span class="string">&#x27;*EQ3&#x27;</span>, <span class="number">0x86a</span>) + _0x2e7c5c(<span class="number">0xb07</span>, <span class="number">0x6f1</span>, <span class="number">0xa86</span>, <span class="string">&#x27;ZP*j&#x27;</span>, <span class="number">0x2bd</span>)]</span><br><span class="line">    &#125;</span><br><span class="line">))</span><br></pre></td></tr></table></figure>
<p>在console面板上，很容易看出，username是我们输入的账号17777777777前面拼接了e5。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203091816525.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220309181634727" title="">
                </div>
                <div class="image-caption">image-20220309181634727</div>
            </figure>
<p>​        password则是明文：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203091817805.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220309181714546" title="">
                </div>
                <div class="image-caption">image-20220309181714546</div>
            </figure>
<p>​        所以上面的代码可以加以简化为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;data&#x27;</span>: _0xf828e5[_0x59cb56(<span class="number">0x7c7</span>, <span class="number">0x4a1</span>, <span class="number">0x425</span>, <span class="string">&#x27;F^5Z&#x27;</span>, <span class="number">0x1f3</span>)](<span class="built_in">JSON</span>[_0x2e7c5c(<span class="number">0x9ff</span>, <span class="number">0x5fa</span>, <span class="number">0x813</span>, <span class="string">&#x27;Ra[M&#x27;</span>, <span class="number">0x821</span>) + _0x160f59(<span class="number">0x921</span>, <span class="number">0x690</span>, <span class="number">0x2a4</span>, <span class="string">&#x27;ZP*j&#x27;</span>, <span class="number">0x657</span>)](</span><br><span class="line">    &#123;</span><br><span class="line">         <span class="string">&#x27;d&#x27;</span>: _0x15a5d0[_0x2e7c5c(<span class="number">0x2ce</span>, <span class="number">0x61d</span>, <span class="number">0xa5a</span>, <span class="string">&#x27;4[E4&#x27;</span>, <span class="number">0x33d</span>)](_0x15a5d0[_0x160f59(<span class="number">0x4a2</span>, <span class="number">0x99e</span>, <span class="number">0xb7e</span>, <span class="string">&#x27;ZHhp&#x27;</span>, <span class="number">0xb6b</span>)](_0x15a5d0[_0x59cb56(<span class="number">0x92b</span>, <span class="number">0x683</span>, <span class="number">0x968</span>, <span class="string">&#x27;F^5Z&#x27;</span>, <span class="number">0x9a7</span>)](_0x15a5d0[_0x160f59(<span class="number">0x11f</span>, <span class="number">0x403</span>, <span class="number">0x29d</span>, <span class="string">&#x27;AVXK&#x27;</span>, <span class="number">0x518</span>)](_0x4fd69b[_0x8eb3(<span class="number">0xc7a</span>, <span class="number">0x728</span>, <span class="number">0x704</span>, <span class="string">&#x27;OBf4&#x27;</span>, <span class="number">0xc4c</span>)](<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;&#x27;</span>), _0xf828e5[_0x8eb3(<span class="number">0x136</span>, <span class="number">0x44f</span>, <span class="number">0x748</span>, <span class="string">&#x27;HZxj&#x27;</span>, <span class="number">0x2a3</span>) + <span class="string">&#x27;en&#x27;</span>]), _0x36b61f[_0x556be9(<span class="number">0x5cf</span>, <span class="number">0x870</span>, <span class="number">0x50b</span>, <span class="string">&#x27;Ra[M&#x27;</span>, <span class="number">0x3af</span>) + <span class="string">&#x27;r&#x27;</span>](-(<span class="number">0x2670</span> + -<span class="number">0x77d</span> * -<span class="number">0x2</span> + -<span class="number">0x3568</span> * <span class="number">0x1</span>))), _0xf828e5[_0x160f59(<span class="number">0xae3</span>, <span class="number">0x5f9</span>, <span class="number">0x92d</span>, <span class="string">&#x27;NUpf&#x27;</span>, <span class="number">0x8a5</span>)]),</span><br><span class="line">         <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;e517777777777&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123456&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">))</span><br></pre></td></tr></table></figure>
<p>调试下<code>_0x59cb56(0x7c7, 0x4a1, 0x425, &#39;F^5Z&#39;, 0x1f3)</code></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203091823518.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220309182331379" title="">
                </div>
                <div class="image-caption">image-20220309182331379</div>
            </figure>
<p>再调试下<code>_0x2e7c5c(0x9ff, 0x5fa, 0x813, &#39;Ra[M&#39;, 0x821) + _0x160f59(0x921, 0x690, 0x2a4, &#39;ZP*j&#39;, 0x657)</code>：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203091824415.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220309182359819" title="">
                </div>
                <div class="image-caption">image-20220309182359819</div>
            </figure>
<p>把上面的代码简化下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;data&#x27;</span>: _0xf828e5.enc.JSON.stringify(</span><br><span class="line">    &#123;</span><br><span class="line">         <span class="string">&#x27;d&#x27;</span>: _0x15a5d0[_0x2e7c5c(<span class="number">0x2ce</span>, <span class="number">0x61d</span>, <span class="number">0xa5a</span>, <span class="string">&#x27;4[E4&#x27;</span>, <span class="number">0x33d</span>)](_0x15a5d0[_0x160f59(<span class="number">0x4a2</span>, <span class="number">0x99e</span>, <span class="number">0xb7e</span>, <span class="string">&#x27;ZHhp&#x27;</span>, <span class="number">0xb6b</span>)](_0x15a5d0[_0x59cb56(<span class="number">0x92b</span>, <span class="number">0x683</span>, <span class="number">0x968</span>, <span class="string">&#x27;F^5Z&#x27;</span>, <span class="number">0x9a7</span>)](_0x15a5d0[_0x160f59(<span class="number">0x11f</span>, <span class="number">0x403</span>, <span class="number">0x29d</span>, <span class="string">&#x27;AVXK&#x27;</span>, <span class="number">0x518</span>)](_0x4fd69b[_0x8eb3(<span class="number">0xc7a</span>, <span class="number">0x728</span>, <span class="number">0x704</span>, <span class="string">&#x27;OBf4&#x27;</span>, <span class="number">0xc4c</span>)](<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;&#x27;</span>), _0xf828e5[_0x8eb3(<span class="number">0x136</span>, <span class="number">0x44f</span>, <span class="number">0x748</span>, <span class="string">&#x27;HZxj&#x27;</span>, <span class="number">0x2a3</span>) + <span class="string">&#x27;en&#x27;</span>]), _0x36b61f[_0x556be9(<span class="number">0x5cf</span>, <span class="number">0x870</span>, <span class="number">0x50b</span>, <span class="string">&#x27;Ra[M&#x27;</span>, <span class="number">0x3af</span>) + <span class="string">&#x27;r&#x27;</span>](-(<span class="number">0x2670</span> + -<span class="number">0x77d</span> * -<span class="number">0x2</span> + -<span class="number">0x3568</span> * <span class="number">0x1</span>))), _0xf828e5[_0x160f59(<span class="number">0xae3</span>, <span class="number">0x5f9</span>, <span class="number">0x92d</span>, <span class="string">&#x27;NUpf&#x27;</span>, <span class="number">0x8a5</span>)]),</span><br><span class="line">         <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;e517777777777&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123456&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">))</span><br></pre></td></tr></table></figure>
<p>可以看到，这里是用了某种加密算法对{“d”: xxx, “username”: “xxx”,  “password”: “xxx”}进行加密从而得到data。这个加密算法到底是什么加密呢？我们console面板上输入_0xf828e5.enc然后点击进去：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203091844956.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220309184438821" title="">
                </div>
                <div class="image-caption">image-20220309184438821</div>
            </figure>
<p>看到了整个方法有2个分支，我们分别对2个分支打上断点，发现只进去else了。如果对JS常见的加密有过了解的话，这里看到iv，mode，padding这三个关键字立马会想到用的是AES加密算法。第一个参数_0x4d04a3是待加密的字符串：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203101006438.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220310100612354" title="">
                </div>
                <div class="image-caption">image-20220310100612354</div>
            </figure>
<p>第二个参数this[_0x19e2aa(0x93, 0x454, ‘cu5X’, 0x139, 0x43d) + ‘e’]是密钥。我们打印出其内容：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> key = &#123;</span><br><span class="line">    <span class="string">&quot;words&quot;</span>: [</span><br><span class="line">        <span class="number">1701066809</span>,</span><br><span class="line">        <span class="number">929182054</span>,</span><br><span class="line">        <span class="number">1698117986</span>,</span><br><span class="line">        <span class="number">1697659188</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;sigBytes&quot;</span>: <span class="number">16</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>第三个参数是AES加密的一些参数，mode一般是CBC，padding不重要可以不传。最后我们在console上输出iv的值：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> iv = &#123;</span><br><span class="line">    <span class="string">&quot;words&quot;</span>: [</span><br><span class="line">        <span class="number">1668053103</span>,</span><br><span class="line">        <span class="number">875983984</span>,</span><br><span class="line">        <span class="number">1731224932</span>,</span><br><span class="line">        <span class="number">943273826</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;sigBytes&quot;</span>: <span class="number">16</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>有了AES加密的这几个参数我们就可以很简单的还原出解密算法了。代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> CryptoJS = <span class="built_in">require</span>(<span class="string">&quot;crypto-js&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> key = &#123;</span><br><span class="line">    <span class="string">&quot;words&quot;</span>: [</span><br><span class="line">        <span class="number">1701066809</span>,</span><br><span class="line">        <span class="number">929182054</span>,</span><br><span class="line">        <span class="number">1698117986</span>,</span><br><span class="line">        <span class="number">1697659188</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;sigBytes&quot;</span>: <span class="number">16</span></span><br><span class="line">&#125;; <span class="comment">// 密钥，已经转化为128bit的格式。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> iv = &#123;</span><br><span class="line">    <span class="string">&quot;words&quot;</span>: [</span><br><span class="line">        <span class="number">1668053103</span>,</span><br><span class="line">        <span class="number">875983984</span>,</span><br><span class="line">        <span class="number">1731224932</span>,</span><br><span class="line">        <span class="number">943273826</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;sigBytes&quot;</span>: <span class="number">16</span></span><br><span class="line">&#125;; <span class="comment">// IV，已经转化为128bit的格式。</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Decrypt</span>(<span class="params">word</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> a = CryptoJS.AES.decrypt(word, key, &#123; <span class="attr">iv</span>: iv, <span class="attr">mode</span>: CryptoJS.mode.CBC &#125;);</span><br><span class="line">    <span class="keyword">return</span> CryptoJS.enc.Utf8.stringify(a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> data = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="built_in">console</span>.log(Decrypt(data));</span><br></pre></td></tr></table></figure>
<p>还记得前面我们提到过抓到2个XHR请求吗？一个是请求验证码的，一个是进行验证码验证的。我们看第一个请求验证码的请求。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203101015210.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220310101530093" title="">
                </div>
                <div class="image-caption">image-20220310101530093</div>
            </figure>
<p>这个返回值c是不是就是用的AES加密呢？我们用上边的解码程序试验一下。果不其然，可以正确反解出加密内容：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203101017949.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220310101738862" title="">
                </div>
                <div class="image-caption">image-20220310101738862</div>
            </figure>
<p>里面的一串JSON正好是我们刚才出现的验证码的内容：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="string">&#x27;90b389d8490d42a8&#x27;</span>, <span class="attr">txt</span>: <span class="string">&#x27;鸭子&#x27;</span>&#125;,</span><br><span class="line">	&#123;<span class="attr">id</span>: <span class="string">&#x27;a7985fb229d9e935&#x27;</span>, <span class="attr">txt</span>: <span class="string">&#x27;长颈鹿&#x27;</span>&#125;,</span><br><span class="line">	&#123;<span class="attr">id</span>: <span class="string">&#x27;c38548f7b6c0a3d8&#x27;</span>, <span class="attr">txt</span>: <span class="string">&#x27;小马&#x27;</span>&#125;,</span><br><span class="line">	&#123;<span class="attr">id</span>: <span class="string">&#x27;4c2c8bc886b8bf8d&#x27;</span>, <span class="attr">txt</span>: <span class="string">&#x27;海马&#x27;</span>&#125;,</span><br><span class="line">	&#123;<span class="attr">id</span>: <span class="string">&#x27;25897767b2ffc531&#x27;</span>, <span class="attr">txt</span>: <span class="string">&#x27;牛&#x27;</span>&#125;,</span><br><span class="line">	&#123;<span class="attr">id</span>: <span class="string">&#x27;24bafe8f4a1eac0e&#x27;</span>, <span class="attr">txt</span>: <span class="string">&#x27;斑马&#x27;</span>&#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>记住这个JSON，我们待会还有用。我们接着回到data破解的思路上去。data的生成代码进一步简化：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;data&#x27;</span>: AES.encode(</span><br><span class="line">    &#123;</span><br><span class="line">         <span class="string">&#x27;d&#x27;</span>: _0x15a5d0[_0x2e7c5c(<span class="number">0x2ce</span>, <span class="number">0x61d</span>, <span class="number">0xa5a</span>, <span class="string">&#x27;4[E4&#x27;</span>, <span class="number">0x33d</span>)](_0x15a5d0[_0x160f59(<span class="number">0x4a2</span>, <span class="number">0x99e</span>, <span class="number">0xb7e</span>, <span class="string">&#x27;ZHhp&#x27;</span>, <span class="number">0xb6b</span>)](_0x15a5d0[_0x59cb56(<span class="number">0x92b</span>, <span class="number">0x683</span>, <span class="number">0x968</span>, <span class="string">&#x27;F^5Z&#x27;</span>, <span class="number">0x9a7</span>)](_0x15a5d0[_0x160f59(<span class="number">0x11f</span>, <span class="number">0x403</span>, <span class="number">0x29d</span>, <span class="string">&#x27;AVXK&#x27;</span>, <span class="number">0x518</span>)](_0x4fd69b[_0x8eb3(<span class="number">0xc7a</span>, <span class="number">0x728</span>, <span class="number">0x704</span>, <span class="string">&#x27;OBf4&#x27;</span>, <span class="number">0xc4c</span>)](<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;&#x27;</span>), _0xf828e5[_0x8eb3(<span class="number">0x136</span>, <span class="number">0x44f</span>, <span class="number">0x748</span>, <span class="string">&#x27;HZxj&#x27;</span>, <span class="number">0x2a3</span>) + <span class="string">&#x27;en&#x27;</span>]), _0x36b61f[_0x556be9(<span class="number">0x5cf</span>, <span class="number">0x870</span>, <span class="number">0x50b</span>, <span class="string">&#x27;Ra[M&#x27;</span>, <span class="number">0x3af</span>) + <span class="string">&#x27;r&#x27;</span>](-(<span class="number">0x2670</span> + -<span class="number">0x77d</span> * -<span class="number">0x2</span> + -<span class="number">0x3568</span> * <span class="number">0x1</span>))), _0xf828e5[_0x160f59(<span class="number">0xae3</span>, <span class="number">0x5f9</span>, <span class="number">0x92d</span>, <span class="string">&#x27;NUpf&#x27;</span>, <span class="number">0x8a5</span>)]),</span><br><span class="line">         <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;e517777777777&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123456&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">))</span><br></pre></td></tr></table></figure>
<p>接下来看看最核心的d的生成规则。_0x15a5d0[_0x2e7c5c(0x2ce, 0x61d, 0xa5a, ‘4[E4’, 0x33d)]是一个加法的花指令。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203101024724.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220310102400570" title="">
                </div>
                <div class="image-caption">image-20220310102400570</div>
            </figure>
<p>_0x15a5d0[_0x59cb56(0x92b, 0x683, 0x968, ‘F^5Z’, 0x9a7)]也是一个加法的花指令：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203101026613.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220310102640758" title="">
                </div>
                <div class="image-caption">image-20220310102640758</div>
            </figure>
<p>_0x15a5d0[_0x59cb56(0x92b, 0x683, 0x968, ‘F^5Z’, 0x9a7)]也是加法花指令。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203101027076.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220310102715978" title="">
                </div>
                <div class="image-caption">image-20220310102715978</div>
            </figure>
<p>_0x15a5d0[_0x160f59(0x11f, 0x403, 0x29d, ‘AVXK’, 0x518)]依旧是一个加法花指令。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203101028062.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220310102811012" title="">
                </div>
                <div class="image-caption">image-20220310102811012</div>
            </figure>
<p>_0x4fd69b[_0x8eb3(0xc7a, 0x728, 0x704, ‘OBf4’, 0xc4c)]是内置的join方法。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203101029626.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220310102934544" title="">
                </div>
                <div class="image-caption">image-20220310102934544</div>
            </figure>
<p>_0x4fd69b是个字符串：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203101059338.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220310105915453" title="">
                </div>
                <div class="image-caption">image-20220310105915453</div>
            </figure>
<p>_0x8eb3(0x136, 0x44f, 0x748, ‘HZxj’, 0x2a3) + ‘en’是字符串$strlen</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203101032240.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220310103214178" title="">
                </div>
                <div class="image-caption">image-20220310103214178</div>
            </figure>
<p>_0xf828e5[_0x8eb3(0x136, 0x44f, 0x748, ‘HZxj’, 0x2a3) + ‘en’]则是取_0xf828e5这个object的$strlen属性，这里的值是3。</p>
<p>_0x556be9(0x5cf, 0x870, 0x50b, ‘Ra[M’, 0x3af) + ‘r’这里是substr。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203101041001.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220310104111880" title="">
                </div>
                <div class="image-caption">image-20220310104111880</div>
            </figure>
<p>_0x36b61f是13位的时间戳。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203101042436.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220310104215390" title="">
                </div>
                <div class="image-caption">image-20220310104215390</div>
            </figure>
<p>-(0x2670 + -0x77d <em> -0x2 + -0x3568 </em> 0x1)是固定的常量，-2。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203101042243.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220310104254188" title="">
                </div>
                <div class="image-caption">image-20220310104254188</div>
            </figure>
<p>_0x160f59(0xae3, 0x5f9, 0x92d, ‘NUpf’, 0x8a5)是字符串$ver。这个ver其实在我们刚才解码第一个请求的返回值的里面就有了，值为3587，跟这里的吻合。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203101100041.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220310110046938" title="">
                </div>
                <div class="image-caption">image-20220310110046938</div>
            </figure>
<p>最终简化代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;data&#x27;</span>: AES.encode(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;d&#x27;</span>: add(add(add(add(<span class="string">&quot;4c2c8bc886b8bf8d&quot;</span>.join(<span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;&#x27;</span>), _0xf828e5.$strlen), _0x36b61f.substr(-<span class="number">2</span>)), _0xf828e5.$ver),</span><br><span class="line">        <span class="comment">// &#x27;d&#x27;: &quot;4c2c8bc886b8bf8d&quot; +  _0xf828e5.$strlen + _0x36b61f.substr(-2)) + _0xf828e5.$ver</span></span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;e517777777777&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123456&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">))</span><br></pre></td></tr></table></figure>
<p>到这里d的生成算法基本上一目了然了。d=字符串(这里是4c2c8bc886b8bf8d)+_0xf828e5.$strlen(这里是3)+13位时间戳的最后2位(这里是17)+版本号(第一个请求接口有返回为3587)=4c2c8bc886b8bf8d3173587。扣出d的生成代码，在console上输出，验证下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203101114177.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220310111442039" title="">
                </div>
                <div class="image-caption">image-20220310111442039</div>
            </figure>
<p>完全吻合。现在唯一的问题是_0x4fd69b这个字符串怎么来的以及_0xf828e5.$strlen这个值怎么算出来的，解决了这两个问题，d的生成规则就破解了。</p>
<p>我们手动搜索_0x4fd69b这个字符串，总共找到三处：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203101121754.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220310112140608" title="">
                </div>
                <div class="image-caption">image-20220310112140608</div>
            </figure>
<p>扣出第二处的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_0x4fd69b[_0x219591(<span class="string">&#x27;FZa9&#x27;</span>, <span class="number">0x79c</span>, <span class="number">0x826</span>, <span class="number">0x6a9</span>, <span class="number">0x45f</span>)](_0xf828e5[_0x59b553(<span class="string">&#x27;W]B)&#x27;</span>, <span class="number">0xd30</span>, <span class="number">0x809</span>, <span class="number">0x809</span>, <span class="number">0x2c4</span>)][_0x19f5d9[_0x3ebe03(<span class="string">&#x27;nCyg&#x27;</span>, <span class="number">0xb6c</span>, <span class="number">0x868</span>, <span class="number">0x4ee</span>, <span class="number">0xd78</span>)](<span class="built_in">parseInt</span>, _0x1bf4a9[_0x59b553(<span class="string">&#x27;#og4&#x27;</span>, <span class="number">0xbb9</span>, <span class="number">0x8a2</span>, <span class="number">0x953</span>, <span class="number">0x441</span>) + <span class="string">&#x27;ce&#x27;</span>](_0x19f5d9[_0x3ebe03(<span class="string">&#x27;F^5Z&#x27;</span>, <span class="number">0x448</span>, <span class="number">0xc1</span>, -<span class="number">0x2ba</span>, <span class="number">0x8c</span>)], <span class="string">&#x27;&#x27;</span>))][<span class="string">&#x27;d&#x27;</span>]);</span><br></pre></td></tr></table></figure>
<p>按照上边提供的方法，在console上分段调试代码含义，代码反混淆如下(<font style="color: red;">为节省篇幅，从这里开始，代码反混淆过程都不会写了，直接给出反混淆的结果</font>):</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_0x4fd69b.push(_0xf828e5.$list[<span class="built_in">parseInt</span>(<span class="string">&quot;btncanv_3&quot;</span>.replace(<span class="string">&quot;btncanv_&quot;</span>, <span class="string">&quot;&quot;</span>))][<span class="string">&#x27;d&#x27;</span>]);</span><br></pre></td></tr></table></figure>
<p>这个代码的意思就是取上边我们提到的验证码数组中索引为3的值，即4c2c8bc886b8bf8d，把这个值push到数组_0x4fd69b（这里虽然取得是d这个属性，但是实际上d属性跟id属性的值是一样的，_0x281004[‘d’] = _0x3aa5c6[‘id’]）。这里的这个btncanv_3恰好是验证码的答案，即正确答案的元素的id。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203101405702.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220310140550569" title="">
                </div>
                <div class="image-caption">image-20220310140550569</div>
            </figure>
<p>那么这个<code>btncanv_3</code>是怎么确定的呢？是我们手动点选验证码图案的时候选中的，我们手动选中了验证码图案，JS代码会根据我们选中的图案，拿到它的id（如果有选中了多个，也只取第一个），然后进行JS加密，后端会根据相应的解密算法，拿到我们上传的那个验证码。我们开篇提到过“一般来说网站如果出现复杂验证码都会配合JS参数加密增加防护等级”，这里就验证了这句话。<strong>我们这里虽然破解了验证码验证接口表单数据的加密算法，但是验证码的点选，我们还需要辅助相应的验证码识别的算法，帮助我们完成验证码的识别与点选</strong>。这里主要是讲解手动反混淆方案，验证码后边会有专门的专题文章进行介绍，先埋一个坑后边补上。</p>
<p>接下来看下另外一个_0xf828e5.$strlen的生成规则。我们文件中全局搜索’en’（为什么要搜索这个？因为前面$strlen的字符串混淆是_0x8eb3(0x136, 0x44f, 0x748, ‘HZxj’, 0x2a3) + ‘en’），果然被我们找到了。代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>[_0x2a85c2(<span class="number">0x8a2</span>, <span class="number">0x60c</span>, <span class="number">0xa3d</span>, <span class="number">0x7b0</span>, <span class="string">&#x27;0NjW&#x27;</span>) + <span class="string">&#x27;en&#x27;</span>] = _0x15a5d0[_0x19b874(<span class="number">0xc8f</span>, <span class="number">0xe5a</span>, <span class="number">0x13b9</span>, <span class="number">0xb8b</span>, <span class="string">&#x27;W]B)&#x27;</span>)](<span class="built_in">Math</span>[_0x26b2f7(<span class="number">0xf44</span>, <span class="number">0xc7b</span>, <span class="number">0xbc1</span>, <span class="number">0x1077</span>, <span class="string">&#x27;o4oN&#x27;</span>)](_0x15a5d0[_0x26b578(<span class="number">0xfa3</span>, <span class="number">0xcfb</span>, <span class="number">0x820</span>, <span class="number">0x11b8</span>, <span class="string">&#x27;m*3l&#x27;</span>)](-<span class="number">0x1bcd</span> + <span class="number">0x1</span> * <span class="number">0x1b23</span> + -<span class="number">0xaf</span> * -<span class="number">0x1</span>, <span class="built_in">Math</span>[_0x2a85c2(<span class="number">0x11fb</span>, <span class="number">0xf8b</span>, <span class="number">0xd69</span>, <span class="number">0x137a</span>, <span class="string">&#x27;*EQ3&#x27;</span>) + <span class="string">&#x27;m&#x27;</span>]())), -<span class="number">0x727</span> * <span class="number">0x2</span> + <span class="number">0x24d7</span> + -<span class="number">0x1f</span> * <span class="number">0xba</span>)</span><br></pre></td></tr></table></figure>
<p>代码反混淆之后整理如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.$strlen = <span class="built_in">Math</span>.floor(<span class="number">5</span> * <span class="built_in">Math</span>.random()) + <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p> 至此，整个data数据生成过程调试完了。最终的算法伪代码整理如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> _0xf828e5.$strlen = <span class="built_in">Math</span>.floor(<span class="number">5</span> * <span class="built_in">Math</span>.random()) + <span class="number">3</span>;</span><br><span class="line"><span class="keyword">let</span> _0x36b61f = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</span><br><span class="line"><span class="keyword">let</span> _0xf828e5.$ver = <span class="string">&quot;3587&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> code = [</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="string">&#x27;90b389d8490d42a8&#x27;</span>, <span class="attr">txt</span>: <span class="string">&#x27;鸭子&#x27;</span>&#125;,</span><br><span class="line">	&#123;<span class="attr">id</span>: <span class="string">&#x27;a7985fb229d9e935&#x27;</span>, <span class="attr">txt</span>: <span class="string">&#x27;长颈鹿&#x27;</span>&#125;,</span><br><span class="line">	&#123;<span class="attr">id</span>: <span class="string">&#x27;c38548f7b6c0a3d8&#x27;</span>, <span class="attr">txt</span>: <span class="string">&#x27;小马&#x27;</span>&#125;,</span><br><span class="line">	&#123;<span class="attr">id</span>: <span class="string">&#x27;4c2c8bc886b8bf8d&#x27;</span>, <span class="attr">txt</span>: <span class="string">&#x27;海马&#x27;</span>&#125;,</span><br><span class="line">	&#123;<span class="attr">id</span>: <span class="string">&#x27;25897767b2ffc531&#x27;</span>, <span class="attr">txt</span>: <span class="string">&#x27;牛&#x27;</span>&#125;,</span><br><span class="line">	&#123;<span class="attr">id</span>: <span class="string">&#x27;24bafe8f4a1eac0e&#x27;</span>, <span class="attr">txt</span>: <span class="string">&#x27;斑马&#x27;</span>&#125;,</span><br><span class="line">]; <span class="comment">// 这个验证码的JSON从第一个接口中拿</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// AES的密钥以及IV值上边已经给出</span></span><br><span class="line"><span class="string">&#x27;data&#x27;</span>: AES.encode(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;d&#x27;</span>: code[<span class="comment">/*人工选中的第一个验证码的索引*/</span>].id +  _0xf828e5.$strlen + _0x36b61f.substr(-<span class="number">2</span>) + _0xf828e5.$ver</span><br><span class="line">         <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;e517777777777&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123456&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">))</span><br></pre></td></tr></table></figure>
<h5 id="逆向clientid生成规则"><a href="#逆向clientid生成规则" class="headerlink" title="逆向clientid生成规则"></a>逆向clientid生成规则</h5><p>扣出clientid生成相关的代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>[_0x26b2f7(<span class="number">0x9fc</span>, <span class="number">0xa9b</span>, <span class="number">0xe1c</span>, <span class="number">0x6b2</span>, <span class="string">&#x27;%jat&#x27;</span>) + _0x34ce5a(<span class="number">0x1321</span>, <span class="number">0xfb2</span>, <span class="number">0x11d0</span>, <span class="number">0x109c</span>, <span class="string">&#x27;m*3l&#x27;</span>)] = _0x1c3499[_0x2a85c2(<span class="number">0xf23</span>, <span class="number">0xc3d</span>, <span class="number">0x99d</span>, <span class="number">0xf50</span>, <span class="string">&#x27;OBf4&#x27;</span>)](<span class="string">&#x27;&#x27;</span>)[_0x26b2f7(<span class="number">0xf47</span>, <span class="number">0xb49</span>, <span class="number">0xe76</span>, <span class="number">0xc02</span>, <span class="string">&#x27;W]B)&#x27;</span>) + <span class="string">&#x27;r&#x27;</span>](<span class="number">0x4f</span> * -<span class="number">0x1</span> + <span class="number">0x1779</span> + -<span class="number">0x172a</span>, -<span class="number">0x4ff</span> * <span class="number">0x3</span> + -<span class="number">0x3</span> * -<span class="number">0x75c</span> + <span class="number">0x1</span> * -<span class="number">0x70d</span>)</span><br></pre></td></tr></table></figure>
<p>代码反混淆如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.$clientid = _0x1c3499.join(<span class="string">&quot;&quot;</span>).substr(<span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line"><span class="comment">// _0x1c3499 = [&#x27;54mwjp6&#x27;, 8, &#x27;zvc&#x27;]</span></span><br></pre></td></tr></table></figure>
<p>$clientid的生成规则依赖_0x1c3499，我继续往下看，扣出_0x1c3499的相关代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_0x1c3499 = []</span><br><span class="line">_0x1c3499[_0x26b578(<span class="number">0xc37</span>, <span class="number">0xd61</span>, <span class="number">0x122c</span>, <span class="number">0xeeb</span>, <span class="string">&#x27;g(lc&#x27;</span>)](_0x3e49dd[_0x2a85c2(<span class="number">0x1ea</span>, <span class="number">0x608</span>, <span class="number">0x810</span>, <span class="number">0xf3</span>, <span class="string">&#x27;o4oN&#x27;</span>) + <span class="string">&#x27;r&#x27;</span>](-<span class="number">0x5f</span> * <span class="number">0x1b</span> + -<span class="number">0x1</span> * <span class="number">0x15c1</span> + <span class="number">0x1fc6</span>, _0x15a5d0[_0x26b578(<span class="number">0xee3</span>, <span class="number">0xb7c</span>, <span class="number">0x893</span>, <span class="number">0xddb</span>, <span class="string">&#x27;HZxj&#x27;</span>)](_0x3badf1, -<span class="number">0x1</span> * -<span class="number">0x14e3</span> + <span class="number">0x26</span> * -<span class="number">0x56</span> + <span class="number">0x81e</span> * -<span class="number">0x1</span>))),</span><br><span class="line">_0x1c3499[_0x34ce5a(<span class="number">0x10ca</span>, <span class="number">0xef3</span>, <span class="number">0xa62</span>, <span class="number">0x10c1</span>, <span class="string">&#x27;[tJe&#x27;</span>)](_0x3badf1),</span><br><span class="line">_0x1c3499[_0x19b874(<span class="number">0x4bb</span>, <span class="number">0x55a</span>, <span class="number">0x35d</span>, <span class="number">0x7ce</span>, <span class="string">&#x27;R[NP&#x27;</span>)](_0x3e49dd[_0x2a85c2(<span class="number">0x11c</span>, <span class="number">0x5da</span>, <span class="number">0xde</span>, <span class="number">0x229</span>, <span class="string">&#x27;FrGG&#x27;</span>) + <span class="string">&#x27;r&#x27;</span>](_0x3badf1, _0x3e49dd[_0x26b578(<span class="number">0xf55</span>, <span class="number">0xbca</span>, <span class="number">0x95d</span>, <span class="number">0xd00</span>, <span class="string">&#x27;0jdF&#x27;</span>) + <span class="string">&#x27;t&#x27;</span>])),</span><br></pre></td></tr></table></figure>
<p>代码反混淆如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">_0x1c3499 = [];</span><br><span class="line">_0x1c3499.push(_0x3e49dd.substr(<span class="number">0</span>, _0x3badf1 - <span class="number">1</span>));                <span class="comment">//_0x1c3499.push(54mwjp6)</span></span><br><span class="line">_0x1c3499.push(_0x3badf1);										   <span class="comment">//_0x1c3499.push(8)</span></span><br><span class="line">_0x3e49dd.push(_0x3e49dd.substr(_0x3badf1, _0x3e49dd.length));     <span class="comment">//_0x1c3499.push(zvc)</span></span><br><span class="line"><span class="comment">// _0x3e49dd = &quot;54mwjp6tzvc&quot;</span></span><br><span class="line"><span class="comment">// _0x3badf1 = 8</span></span><br></pre></td></tr></table></figure>
<p>可以看到__0x1c3499的值又依赖_0x3e49dd和_0x3badf1。我们再扣出相应的代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_0x3e49dd = _0x15a5d0[_0x2a85c2(<span class="number">0x240</span>, <span class="number">0x6a9</span>, <span class="number">0x570</span>, <span class="number">0x230</span>, <span class="string">&#x27;ZP*j&#x27;</span>)](<span class="built_in">Number</span>, _0x15a5d0[_0x26b578(<span class="number">0x8cc</span>, <span class="number">0xaab</span>, <span class="number">0xa86</span>, <span class="number">0xf1d</span>, <span class="string">&#x27;NUpf&#x27;</span>)](<span class="built_in">Math</span>[_0x19b874(<span class="number">0x12ba</span>, <span class="number">0xd7c</span>, <span class="number">0xb35</span>, <span class="number">0xe72</span>, <span class="string">&#x27;o4oN&#x27;</span>) + <span class="string">&#x27;m&#x27;</span>]()[_0x34ce5a(<span class="number">0xffa</span>, <span class="number">0xa91</span>, <span class="number">0x802</span>, <span class="number">0xe92</span>, <span class="string">&#x27;uUCz&#x27;</span>) + _0x19b874(<span class="number">0x174</span>, <span class="number">0x684</span>, <span class="number">0x9d7</span>, <span class="number">0x737</span>, <span class="string">&#x27;G0Im&#x27;</span>)]()[_0x26b2f7(<span class="number">0xaa8</span>, <span class="number">0x6bd</span>, <span class="number">0x562</span>, <span class="number">0x35a</span>, <span class="string">&#x27;F^5Z&#x27;</span>) + <span class="string">&#x27;r&#x27;</span>](<span class="number">0x10</span> * <span class="number">0xc2</span> + <span class="number">0x6d</span> * -<span class="number">0x5</span> + -<span class="number">0x9</span> * <span class="number">0x11c</span>, <span class="number">0xb3</span> * <span class="number">0x35</span> + <span class="number">0x13</span> * <span class="number">0x1a5</span> + -<span class="number">0x444a</span> * <span class="number">0x1</span>), <span class="built_in">Date</span>[_0x26b2f7(<span class="number">0xbf3</span>, <span class="number">0xd8c</span>, <span class="number">0xaf2</span>, <span class="number">0xacf</span>, <span class="string">&#x27;g(lc&#x27;</span>)]()))[_0x26b578(<span class="number">0x326</span>, <span class="number">0x69f</span>, <span class="number">0xaa3</span>, <span class="number">0x78d</span>, <span class="string">&#x27;*EQ3&#x27;</span>) + _0x26b2f7(<span class="number">0x8dc</span>, <span class="number">0x900</span>, <span class="number">0x8f0</span>, <span class="number">0xa3a</span>, <span class="string">&#x27;hROy&#x27;</span>)](<span class="number">0x143b</span> + <span class="number">0x53c</span> + -<span class="number">0x1953</span>)</span><br><span class="line">                      </span><br><span class="line"> _0x3badf1 = _0x15a5d0[_0x34ce5a(<span class="number">0x11ce</span>, <span class="number">0xdf7</span>, <span class="number">0x9a2</span>, <span class="number">0xad1</span>, <span class="string">&#x27;!OnF&#x27;</span>)](<span class="built_in">parseInt</span>, _0x3577fe[<span class="built_in">Math</span>[_0x19b874(<span class="number">0x871</span>, <span class="number">0xb0b</span>, <span class="number">0xf76</span>, <span class="number">0xb41</span>, <span class="string">&#x27;#og4&#x27;</span>)](_0x15a5d0[_0x2a85c2(<span class="number">0x123a</span>, <span class="number">0xeb6</span>, <span class="number">0xbf1</span>, <span class="number">0x10d4</span>, <span class="string">&#x27;bsj&amp;&#x27;</span>)](<span class="built_in">Math</span>[_0x2a85c2(<span class="number">0x7ca</span>, <span class="number">0x776</span>, <span class="number">0x9aa</span>, <span class="number">0x847</span>, <span class="string">&#x27;R[NP&#x27;</span>) + <span class="string">&#x27;m&#x27;</span>](), _0x3577fe[_0x26b2f7(<span class="number">0x2ac</span>, <span class="number">0x73b</span>, <span class="number">0xbfc</span>, <span class="number">0x1ff</span>, <span class="string">&#x27;FrGG&#x27;</span>) + <span class="string">&#x27;h&#x27;</span>]))])</span><br></pre></td></tr></table></figure>
<p>代码反混淆后结果如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_0x3e49dd = <span class="built_in">Number</span>(<span class="built_in">Math</span>.random().toString().substr(<span class="number">3</span>, <span class="number">4</span>) + <span class="built_in">Date</span>.now().toString()).toString(<span class="number">36</span>)</span><br><span class="line">_0x3badf1 = <span class="built_in">parseInt</span>(_0x3577fe[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * _0x3577fe.length)])</span><br></pre></td></tr></table></figure>
<p>_0x3577fe的值是固定的三个元素的数组，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_0x3577fe = [-<span class="number">0x2090</span> + -<span class="number">0x1b</span> * <span class="number">0x139</span> + <span class="number">0x4197</span>, <span class="number">0x959</span> + -<span class="number">0x248c</span> + <span class="number">0x45</span> * <span class="number">0x65</span>, <span class="number">0x2</span> * -<span class="number">0x1ea</span> + <span class="number">0x229f</span> + -<span class="number">0x1ec3</span>]; <span class="comment">// 4 6 8</span></span><br></pre></td></tr></table></figure>
<p>到这里为止，$clientid的生成规则就全部反混淆出来了，最终的代码整理如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> _0x3577fe = [<span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>];</span><br><span class="line"><span class="keyword">let</span> _0x3e49dd = <span class="built_in">Number</span>(<span class="built_in">Math</span>.random().toString().substr(<span class="number">3</span>, <span class="number">4</span>) + <span class="built_in">Date</span>.now().toString()).toString(<span class="number">36</span>);</span><br><span class="line"><span class="keyword">let</span> _0x3badf1 = <span class="built_in">parseInt</span>(_0x3577fe[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * _0x3577fe.length)]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _0x1c3499 = [];</span><br><span class="line">_0x1c3499.push(_0x3e49dd.substr(<span class="number">0</span>, _0x3badf1 - <span class="number">1</span>));</span><br><span class="line">_0x1c3499.push(_0x3badf1);</span><br><span class="line">_0x1c3499.push(_0x3e49dd.substr(_0x3badf1, _0x3e49dd.length));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> clientid = _0x1c3499.join(<span class="string">&quot;&quot;</span>).substr(<span class="number">0</span>,<span class="number">10</span>);</span><br><span class="line"><span class="built_in">console</span>.log(clientid);</span><br></pre></td></tr></table></figure>
<p>真是一层一层剥开你的心🥴</p>
<h5 id="逆向token生成规则"><a href="#逆向token生成规则" class="headerlink" title="逆向token生成规则"></a>逆向token生成规则</h5><p>扣出token生成的相关代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;token&#x27;</span>: _0xf828e5[_0x2e7c5c(<span class="number">0x3c9</span>, <span class="number">0x4c</span>, -<span class="number">0x2fc</span>, <span class="string">&#x27;hROy&#x27;</span>, -<span class="number">0x1f8</span>)](_0x15a5d0[_0x2e7c5c(<span class="number">0x78e</span>, <span class="number">0x6f8</span>, <span class="number">0x927</span>, <span class="string">&#x27;(e@x&#x27;</span>, <span class="number">0x3d0</span>)](_0x15a5d0[_0x59cb56(<span class="number">0x398</span>, <span class="number">0x6f8</span>, <span class="number">0x7eb</span>, <span class="string">&#x27;(e@x&#x27;</span>, <span class="number">0x571</span>)](_0x15a5d0[_0x160f59(<span class="number">0xbca</span>, <span class="number">0xad5</span>, <span class="number">0x7c2</span>, <span class="string">&#x27;FZa9&#x27;</span>, <span class="number">0xa2c</span>)](_0xf828e5[_0x2e7c5c(<span class="number">0x56b</span>, <span class="number">0x25a</span>, <span class="number">0x1e6</span>, <span class="string">&#x27;g(lc&#x27;</span>, -<span class="number">0x22c</span>) + _0x556be9(<span class="number">0x527</span>, <span class="number">0x2b</span>, <span class="number">0x30c</span>, <span class="string">&#x27;su5h&#x27;</span>, <span class="number">0x58f</span>)], _0xf828e5[_0x8eb3(<span class="number">0x1bf</span>, <span class="number">0x17c</span>, <span class="number">0x58</span>, <span class="string">&#x27;Ra[M&#x27;</span>, -<span class="number">0xec</span>) + _0x2e7c5c(<span class="number">0x203</span>, <span class="number">0x237</span>, -<span class="number">0x41</span>, <span class="string">&#x27;Qm)6&#x27;</span>, <span class="number">0x40c</span>)]), _0xf828e5[_0x2e7c5c(<span class="number">0xd48</span>, <span class="number">0x8de</span>, <span class="number">0x717</span>, <span class="string">&#x27;j[vi&#x27;</span>, <span class="number">0xd5e</span>) + _0x59cb56(<span class="number">0x301</span>, <span class="number">0x4c3</span>, <span class="number">0x1e5</span>, <span class="string">&#x27;0jdF&#x27;</span>, <span class="number">0x8fb</span>)]), _0x15a5d0[_0x59cb56(-<span class="number">0x1ee</span>, <span class="number">0xb3</span>, <span class="number">0x35</span>, <span class="string">&#x27;OBf4&#x27;</span>, <span class="number">0x524</span>)]))</span><br></pre></td></tr></table></figure>
<p>反混淆之后的最终代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;token&#x27;</span>: _0xf828e5[<span class="string">&quot;sign&quot;</span>](_0xf828e5.$clientid + _0xf828e5.$username + _0x15a5d0.sGZgF))</span><br></pre></td></tr></table></figure>
<p>庆幸的是，这里的_0x15a5d0.sGZgF是一个固定的字符串，内容为”x045783”。所以重点在于破解这个加密方法sign。我们扣出相应的代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">_0x58b6e0[_0x339e58(<span class="number">0x61a</span>, -<span class="number">0x24f</span>, <span class="number">0x94</span>, <span class="string">&#x27;nCyg&#x27;</span>, <span class="number">0x267</span>) + _0x18c3fa(<span class="number">0x813</span>, <span class="number">0x825</span>, <span class="number">0x36f</span>, <span class="string">&#x27;TEE1&#x27;</span>, <span class="number">0x6be</span>)][_0x1d90d1(<span class="number">0x18a</span>, <span class="number">0x8b2</span>, -<span class="number">0x158</span>, <span class="string">&#x27;Qm)6&#x27;</span>, <span class="number">0x348</span>)] = <span class="function"><span class="keyword">function</span>(<span class="params">_0x1c6621</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...此处省略若干行</span></span><br><span class="line">    <span class="keyword">var</span> _0x4f239d = []</span><br><span class="line">    , _0x4996c2 = cjs[_0x8a0b67(<span class="string">&#x27;FrGG&#x27;</span>, <span class="number">0x9dc</span>, <span class="number">0x3fa</span>, <span class="number">0xaba</span>, <span class="number">0x868</span>)](_0x15a5d0[_0x343f8b(<span class="string">&#x27;ZiBy&#x27;</span>, <span class="number">0x377</span>, <span class="number">0x152</span>, <span class="number">0x542</span>, <span class="number">0x4df</span>)](_0x1c6621, _0x46b6c3[_0x8a0b67(<span class="string">&#x27;TEE1&#x27;</span>, <span class="number">0x3db</span>, <span class="number">0x7c8</span>, <span class="number">0x6a4</span>, <span class="number">0x347</span>) + _0x429176(<span class="string">&#x27;NUpf&#x27;</span>, <span class="number">0x241</span>, -<span class="number">0x1c1</span>, <span class="number">0x4ab</span>, <span class="number">0x81</span>)][_0x343f8b(<span class="string">&#x27;HZxj&#x27;</span>, <span class="number">0x49c</span>, <span class="number">0x718</span>, <span class="number">0xa22</span>, <span class="number">0x854</span>)][_0x429176(<span class="string">&#x27;F^5Z&#x27;</span>, <span class="number">0x472</span>, <span class="number">0x2c9</span>, <span class="number">0x687</span>, <span class="number">0x272</span>) + _0x8a0b67(<span class="string">&#x27;g(lc&#x27;</span>, <span class="number">0x39e</span>, <span class="number">0x19b</span>, <span class="number">0x616</span>, <span class="number">0x5b8</span>) + <span class="string">&#x27;e&#x27;</span>]()))[_0x4b55c2(<span class="string">&#x27;OBf4&#x27;</span>, -<span class="number">0x22b</span>, -<span class="number">0x342</span>, <span class="number">0x13a</span>, <span class="number">0x2c</span>) + _0x8a0b67(<span class="string">&#x27;xVxp&#x27;</span>, -<span class="number">0x78</span>, <span class="number">0x45c</span>, <span class="number">0x287</span>, <span class="number">0x16b</span>)]();</span><br><span class="line">    <span class="keyword">return</span> _0x4f239d[_0xafe698(<span class="string">&#x27;Ra[M&#x27;</span>, <span class="number">0x1d0</span>, -<span class="number">0x66b</span>, <span class="number">0x2ad</span>, -<span class="number">0x177</span>)](_0x4996c2[_0xafe698(<span class="string">&#x27;IF#P&#x27;</span>, <span class="number">0x2d0</span>, <span class="number">0x958</span>, <span class="number">0x506</span>, <span class="number">0x55e</span>) + <span class="string">&#x27;r&#x27;</span>](-<span class="number">0x15d</span> + -<span class="number">0x49</span> * -<span class="number">0x45</span> + -<span class="number">0x1246</span>, <span class="number">0x8c2</span> + <span class="number">0x25af</span> + -<span class="number">0x2e6c</span>)),</span><br><span class="line">        _0x4f239d[_0x8a0b67(<span class="string">&#x27;g(lc&#x27;</span>, <span class="number">0x34a</span>, <span class="number">0x43e</span>, <span class="number">0x955</span>, <span class="number">0x683</span>)](_0x4996c2[_0x4b55c2(<span class="string">&#x27;ZiBy&#x27;</span>, <span class="number">0x71</span>, <span class="number">0x10f</span>, <span class="number">0x9a7</span>, <span class="number">0x506</span>) + <span class="string">&#x27;r&#x27;</span>](<span class="number">0x142b</span> * -<span class="number">0x1</span> + <span class="number">0x21b7</span> + <span class="number">0xd85</span> * -<span class="number">0x1</span>, -<span class="number">0xb69</span> * -<span class="number">0x3</span> + -<span class="number">0x61</span> * <span class="number">0x58</span> + -<span class="number">0xde</span>)),</span><br><span class="line">        _0x4f239d[_0x429176(<span class="string">&#x27;W]B)&#x27;</span>, <span class="number">0x82f</span>, <span class="number">0x119</span>, <span class="number">0x27e</span>, <span class="number">0x4fb</span>)](_0x4996c2[_0x4b55c2(<span class="string">&#x27;AVXK&#x27;</span>, <span class="number">0x3e8</span>, <span class="number">0x4fc</span>, <span class="number">0x6f2</span>, <span class="number">0x79f</span>) + <span class="string">&#x27;r&#x27;</span>](<span class="number">0x61b</span> + <span class="number">0xc</span> * -<span class="number">0x11e</span> + <span class="number">0x75c</span>, -<span class="number">0x677</span> * <span class="number">0x1</span> + -<span class="number">0x2272</span> * <span class="number">0x1</span> + <span class="number">0x28ee</span>)),</span><br><span class="line">        _0x4f239d[_0xafe698(<span class="string">&#x27;0NjW&#x27;</span>, <span class="number">0x3c5</span>, <span class="number">0x181</span>, -<span class="number">0x47</span>, <span class="number">0x125</span>)](_0x4996c2[_0x8a0b67(<span class="string">&#x27;uUCz&#x27;</span>, <span class="number">0xcea</span>, <span class="number">0x99c</span>, <span class="number">0x405</span>, <span class="number">0x8c3</span>) + <span class="string">&#x27;r&#x27;</span>](-<span class="number">0x4ba</span> + -<span class="number">0x59d</span> * <span class="number">0x1</span> + <span class="number">0xa6b</span>, -<span class="number">0x2</span> * <span class="number">0xe80</span> + <span class="number">0x1c01</span> + <span class="number">0x104</span>)),</span><br><span class="line">        _0x4f239d[_0x429176(<span class="string">&#x27;IF#P&#x27;</span>, <span class="number">0x2b</span>, -<span class="number">0x2cb</span>, <span class="number">0x33e</span>, <span class="number">0x20d</span>)](_0x4996c2[_0xafe698(<span class="string">&#x27;TEE1&#x27;</span>, <span class="number">0xcb6</span>, <span class="number">0x668</span>, <span class="number">0x5fa</span>, <span class="number">0x833</span>) + <span class="string">&#x27;r&#x27;</span>](-<span class="number">0x4b</span> * -<span class="number">0x4</span> + -<span class="number">0x2a</span> * <span class="number">0x86</span> + <span class="number">0x5</span> * <span class="number">0x42e</span>, -<span class="number">0xd</span> * -<span class="number">0x119</span> + -<span class="number">0x1791</span> + <span class="number">0x951</span>)),</span><br><span class="line">        _0x4f239d[_0x429176(<span class="string">&#x27;j[vi&#x27;</span>, <span class="number">0x5e6</span>, <span class="number">0x2bd</span>, <span class="number">0x5e2</span>, <span class="number">0x648</span>)](_0x4996c2[_0x429176(<span class="string">&#x27;#og4&#x27;</span>, <span class="number">0xd5</span>, <span class="number">0x68e</span>, <span class="number">0x54b</span>, <span class="number">0x516</span>) + <span class="string">&#x27;r&#x27;</span>](-<span class="number">0x193d</span> + <span class="number">0x399</span> * -<span class="number">0x5</span> + -<span class="number">0x1</span> * -<span class="number">0x2b55</span>, -<span class="number">0x8a8</span> * -<span class="number">0x4</span> + <span class="number">0xd6</span> * <span class="number">0x6</span> + <span class="number">0x3</span> * -<span class="number">0xd35</span>)),</span><br><span class="line">        _0x4f239d[_0x8a0b67(<span class="string">&#x27;Cy2U&#x27;</span>, <span class="number">0x689</span>, <span class="number">0x578</span>, <span class="number">0x485</span>, <span class="number">0x71e</span>)](_0x4996c2[_0x4b55c2(<span class="string">&#x27;4[E4&#x27;</span>, <span class="number">0x272</span>, <span class="number">0x5ce</span>, <span class="number">0x4e1</span>, <span class="number">0x668</span>) + <span class="string">&#x27;r&#x27;</span>](-<span class="number">0x97</span> * <span class="number">0x17</span> + -<span class="number">0xe</span> * <span class="number">0x46</span> + <span class="number">0x1166</span>, -<span class="number">0x18f4</span> * -<span class="number">0x1</span> + -<span class="number">0x93</span> * <span class="number">0x3b</span> + <span class="number">0x8ef</span> * <span class="number">0x1</span>)),</span><br><span class="line">        _0x4f239d[_0x343f8b(<span class="string">&#x27;&amp;zHf&#x27;</span>, -<span class="number">0xb</span>, -<span class="number">0x5bc</span>, -<span class="number">0x16b</span>, -<span class="number">0x108</span>)](<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到这么大一段代码不要慌！！！我们慢慢开始剥洋葱。🙃，剥到最后，很简单。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_0x58b6e0.prototype.sign = <span class="function"><span class="keyword">function</span>(<span class="params">_0x1c6621</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _0x4f239d = [], _0x4996c2 = MD5(_0x1c6621 + <span class="built_in">document</span>.location.href.toLowerCase()).toString();</span><br><span class="line">    <span class="keyword">return</span> _0x4f239d.push(_0x4996c2.substr(<span class="number">10</span>, <span class="number">5</span>)), _0x4f239d.push(_0x4996c2.substr(<span class="number">7</span>, <span class="number">5</span>)), _0x4f239d.push(_0x4996c2.substr(<span class="number">15</span>, <span class="number">5</span>)), _0x4f239d.push(_0x4996c2.substr(<span class="number">20</span>, <span class="number">5</span>)), _0x4f239d.push(_0x4996c2.substr(<span class="number">22</span>, <span class="number">5</span>)), _0x4f239d.push(_0x4996c2.substr(<span class="number">27</span>, <span class="number">5</span>)), _0x4f239d.push(_0x4996c2.substr(<span class="number">1</span>, <span class="number">2</span>)), _0x4f239d.join(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实就是对传入的参数做了一个md5的加密，然后进行乱序处理。</p>
<p>到这里我们两个接口的所有请求参数加密算法，以及接口的返回值的解密算法都已经破解了。我们接下来简单验证下是否正确。</p>
<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p>由于check接口需要机器学习对验证码进行识别，所以这里只验证get接口的参数。用NodeJS的Express框架搭建好获取token的服务，供Python调用。</p>
<p>运行结果如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203122207679.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220312220733810" title="">
                </div>
                <div class="image-caption">image-20220312220733810</div>
            </figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203122208606.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220312220820149" title="">
                </div>
                <div class="image-caption">image-20220312220820149</div>
            </figure>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>本文通过一个网站，手动对AST混淆代码进行了一个反混淆。在<a href="https://blog.heshipeng.com/JS%E4%BB%A3%E7%A0%81%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94AST%E6%B7%B7%E6%B7%86%E5%8E%9F%E7%90%86/">JS代码安全防护原理——AST混淆原理</a>中提到的几种混淆原理基本都出现过了。比如数组混淆，数组逆向，花指令，流程平坦化，逗号表达式混淆，字符串加密，常量加密等。可以看到，手动混淆的过程是极其容易出错，工作量非常大且十分痛苦的。接下来会写相关文章，介绍如何通过工具对AST混淆代码进行自动反混淆，不过，手动混淆这种能力也是必须要掌握的，万一你使用的工具失效了，或者说遇到一些更加特殊的网站，只能通过手动混淆呢？如果想获取本文的完整代码，扫码关注公众号，然后公众号内回复关键字<code>02</code>即可获取。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203122210618.jpg" alt="qrcode_for_gh_509fdefd3c81_258" title="">
                </div>
                <div class="image-caption">qrcode_for_gh_509fdefd3c81_258</div>
            </figure>

    

        <a href="/JS%E9%80%86%E5%90%91%E4%B9%8B%E6%B7%B7%E6%B7%86JS%E6%89%8B%E5%8A%A8%E9%80%86%E5%90%91/" class="post-more waves-effect waves-button">
            Continue reading...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AST/" rel="tag">AST</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JS/" rel="tag">JS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%80%86%E5%90%91/" rel="tag">逆向</a></li></ul>

    </div>
    
</article>

        </li>
    
        <li class="post-list-item fade">
            <article id="post-JS代码安全防护原理——AST混淆原理"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time class="post-time" title="2022-03-03 22:22:11" datetime="2022-03-03T14:22:11.000Z"  itemprop="datePublished">2022-03-03</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/JS%E9%80%86%E5%90%91/">JS逆向</a></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/JS%E4%BB%A3%E7%A0%81%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94AST%E6%B7%B7%E6%B7%86%E5%8E%9F%E7%90%86/">JS代码安全防护原理——AST混淆原理</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent">

    
        <h4 id="常量的混淆原理"><a href="#常量的混淆原理" class="headerlink" title="常量的混淆原理"></a>常量的混淆原理</h4><p>本篇所用的demo如下。接下来的案例都是围绕这个demo进行混淆。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Date</span>.prototype.format = <span class="function"><span class="keyword">function</span>(<span class="params">formatStr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> str = formatStr;</span><br><span class="line">    <span class="keyword">var</span> Week = [<span class="string">&#x27;日&#x27;</span>, <span class="string">&#x27;一&#x27;</span>, <span class="string">&#x27;二&#x27;</span>, <span class="string">&#x27;三&#x27;</span>, <span class="string">&#x27;四&#x27;</span>, <span class="string">&#x27;五&#x27;</span>, <span class="string">&#x27;六&#x27;</span>];</span><br><span class="line">    str = str.replace(<span class="regexp">/yyyy|YYYY/</span>, <span class="built_in">this</span>.getFullYear());</span><br><span class="line">    str = str.replace(<span class="regexp">/MM/</span>, (<span class="built_in">this</span>.getMonth() + <span class="number">1</span>) &gt; <span class="number">9</span> ? (<span class="built_in">this</span>.getMonth() + <span class="number">1</span>).toString() : <span class="string">&#x27;0&#x27;</span> + (<span class="built_in">this</span>.getMonth() + <span class="number">1</span>));</span><br><span class="line">    str = str.replace(<span class="regexp">/dd|DD/</span>, <span class="built_in">this</span>.getDate() &gt; <span class="number">9</span> ? <span class="built_in">this</span>.getDate().toString() : <span class="string">&#x27;0&#x27;</span> + <span class="built_in">this</span>.getDate());</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>().format(<span class="string">&#x27;yyyy-MM-dd&#x27;</span>));</span><br></pre></td></tr></table></figure>
<h5 id="对象属性的两种访问方式"><a href="#对象属性的两种访问方式" class="headerlink" title="对象属性的两种访问方式"></a>对象属性的两种访问方式</h5><p>看下面一段代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">People</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">&#125;</span><br><span class="line">People.prototype.sayHello = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;Hello&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> People(<span class="string">&#x27;zhang san&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(p.name);    <span class="comment">// zhang san</span></span><br><span class="line">p.sayHello();           <span class="comment">// Hello</span></span><br><span class="line"><span class="built_in">console</span>.log(p[<span class="string">&#x27;name&#x27;</span>]); <span class="comment">// zhang san</span></span><br><span class="line">p[<span class="string">&#x27;sayHello&#x27;</span>]();				<span class="comment">// Hello</span></span><br></pre></td></tr></table></figure>
<ol>
<li>p.name这种方式name是一个标识符，必须明确出现在代码中，不能加密和拼接。</li>
<li>p[‘name’]这种方式name是一个字符串。由于是字符串，所以访问的时候可以进行拼接和加密等操作。所以在JS混淆中，一般会选择这种方式访问属性。</li>
</ol>
<p>所以改变对象属性的访问方式，是代码混淆的前提。</p>
<p>所以开篇提到的demo改变对象属性的访问方式之后，代码修改如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>[<span class="string">&#x27;Date&#x27;</span>][<span class="string">&#x27;prototype&#x27;</span>][<span class="string">&#x27;format&#x27;</span>] = <span class="function"><span class="keyword">function</span>(<span class="params">formatStr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> str = formatStr;</span><br><span class="line">    <span class="keyword">var</span> Week = [<span class="string">&#x27;日&#x27;</span>, <span class="string">&#x27;一&#x27;</span>, <span class="string">&#x27;二&#x27;</span>, <span class="string">&#x27;三&#x27;</span>, <span class="string">&#x27;四&#x27;</span>, <span class="string">&#x27;五&#x27;</span>, <span class="string">&#x27;六&#x27;</span>];</span><br><span class="line">    str = str[<span class="string">&#x27;replace&#x27;</span>](<span class="regexp">/yyyy|YYYY/</span>, <span class="built_in">this</span>[<span class="string">&#x27;getFullYear&#x27;</span>]());</span><br><span class="line">    str = str[<span class="string">&#x27;replace&#x27;</span>](<span class="regexp">/MM/</span>, (<span class="built_in">this</span>[<span class="string">&#x27;getMonth&#x27;</span>]() + <span class="number">1</span>) &gt; <span class="number">9</span> ? (<span class="built_in">this</span>[<span class="string">&#x27;getMonth&#x27;</span>]() + <span class="number">1</span>).toString() : <span class="string">&#x27;0&#x27;</span> + (<span class="built_in">this</span>[<span class="string">&#x27;getMonth&#x27;</span>]() + <span class="number">1</span>));</span><br><span class="line">    str = str[<span class="string">&#x27;replace&#x27;</span>](<span class="regexp">/dd|DD/</span>, <span class="built_in">this</span>[<span class="string">&#x27;getDate&#x27;</span>]() &gt; <span class="number">9</span> ? <span class="built_in">this</span>[<span class="string">&#x27;getDate&#x27;</span>]().toString() : <span class="string">&#x27;0&#x27;</span> + <span class="built_in">this</span>[<span class="string">&#x27;getDate&#x27;</span>]());</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">window</span>[<span class="string">&#x27;Date&#x27;</span>]()[<span class="string">&#x27;format&#x27;</span>](<span class="string">&#x27;yyyy-MM-dd&#x27;</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Date是JS的内置对象，在JS中很多内置对象都属于window的属性。另外，代码中定义的全局变量都是全局对象window的属性，代码中定义的全局方法都是全局对象window的方法。全局对象的属性或者方法在调用的时候可以省略全局对象名。比如，new window.Date()等同于new Date()。由于把Date变成了字符串，所以前面必须加window。</p>
<h5 id="十六进制字符串"><a href="#十六进制字符串" class="headerlink" title="十六进制字符串"></a>十六进制字符串</h5><p>在JS中支持字符串的十六进制形式表示，所以可以用字符串的十六进制形式来代替原有的字符串。比如’yyyy-MM-dd’可以表示成’\x79\x79\x79\x79\x2d\x4d\x4d\x2d\x64\x64’。其实，0x79就是字母y的ASCII码的十六进制形式，其余的字母类推。可以用一个方法来完成十六进制字符串的转换。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hexEnc</span>(<span class="params">code</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> hexStr = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, s; i &lt; code.length; i++) &#123;</span><br><span class="line">        s = code.charCodeAt(i).toString(<span class="number">16</span>);</span><br><span class="line">        hexStr += <span class="string">&#x27;\\x&#x27;</span> + s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hexStr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>开篇的demo转换为十六进制字符串之后如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>[<span class="string">&#x27;\x44\x61\x74\x65&#x27;</span>][<span class="string">&#x27;\x70\x72\x6f\x74\x6f\x74\x79\x70\x65&#x27;</span>][<span class="string">&#x27;\x66\x6f\x72\x6d\x61\x74&#x27;</span>] = <span class="function"><span class="keyword">function</span>(<span class="params">formatStr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> str = formatStr;</span><br><span class="line">    <span class="keyword">var</span> Week = [<span class="string">&#x27;\x65e5&#x27;</span>, <span class="string">&#x27;\x4e00&#x27;</span>, <span class="string">&#x27;\x4e8c&#x27;</span>, <span class="string">&#x27;\x4e09&#x27;</span>, <span class="string">&#x27;\x56db&#x27;</span>, <span class="string">&#x27;\x4e94&#x27;</span>, <span class="string">&#x27;\x516d&#x27;</span>];</span><br><span class="line">    str = str[<span class="string">&#x27;\x72\x65\x70\x6c\x61\x63\x65&#x27;</span>](<span class="regexp">/yyyy|YYYY/</span>, <span class="built_in">this</span>[<span class="string">&#x27;\x67\x65\x74\x46\x75\x6c\x6c\x59\x65\x61\x72&#x27;</span>]());</span><br><span class="line">    str = str[<span class="string">&#x27;\x72\x65\x70\x6c\x61\x63\x65&#x27;</span>](<span class="regexp">/MM/</span>, (<span class="built_in">this</span>[<span class="string">&#x27;\x67\x65\x74\x4d\x6f\x6e\x74\x68&#x27;</span>]() + <span class="number">1</span>) &gt; <span class="number">9</span> ? (<span class="built_in">this</span>[<span class="string">&#x27;\x67\x65\x74\x4d\x6f\x6e\x74\x68&#x27;</span>]() + <span class="number">1</span>).toString() : <span class="string">&#x27;\x30&#x27;</span> + (<span class="built_in">this</span>[<span class="string">&#x27;\x67\x65\x74\x4d\x6f\x6e\x74\x68&#x27;</span>]() + <span class="number">1</span>));</span><br><span class="line">    str = str[<span class="string">&#x27;\x72\x65\x70\x6c\x61\x63\x65&#x27;</span>](<span class="regexp">/dd|DD/</span>, <span class="built_in">this</span>[<span class="string">&#x27;\x67\x65\x74\x44\x61\x74\x65&#x27;</span>]() &gt; <span class="number">9</span> ? <span class="built_in">this</span>[<span class="string">&#x27;\x67\x65\x74\x44\x61\x74\x65&#x27;</span>]().toString() : <span class="string">&#x27;\x30&#x27;</span> + <span class="built_in">this</span>[<span class="string">&#x27;\x67\x65\x74\x44\x61\x74\x65&#x27;</span>]());</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">window</span>[<span class="string">&#x27;\x44\x61\x74\x65&#x27;</span>]()[<span class="string">&#x27;\x66\x6f\x72\x6d\x61\x74&#x27;</span>](<span class="string">&#x27;\x79\x79\x79\x79\x2d\x4d\x4d\x2d\x64\x64&#x27;</span>));</span><br></pre></td></tr></table></figure>
<h5 id="unicode字符串"><a href="#unicode字符串" class="headerlink" title="unicode字符串"></a>unicode字符串</h5><p>在JS中，字符串除了可以表示成十六进制的形式外，还支持使用unicode形式表示。比如：</p>
<ol>
<li>以var Week = [‘日’, ‘一’, ‘二’, ‘三’, ‘四’, ‘五’, ‘六’]为例，可以表示成var Week = [‘\u65e5’, ‘\u4e00’, ‘\u4e8c’, ‘\u4e09’, ‘\u56db’, ‘\u4e94’, ‘\u516d’]</li>
<li>非中文的情况，Date可以表示成’\u0044\u0061\u0074\u0065’</li>
</ol>
<p>从上述例子不难看出，unicode形式就是\u开头，后面跟四位数的十六进制形式，不足四位的补0。可以通过以下代码完成unicode转换：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unicodeEnc</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> value = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  	<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; str.length; i++) &#123;</span><br><span class="line">      	value += <span class="string">&quot;\\u&quot;</span> + (<span class="string">&quot;0000&quot;</span> + <span class="built_in">parseInt</span>(str.charCodeAt(i)).toString(<span class="number">16</span>)).substr(-<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>开篇的demo转换为unicode编码之后如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>[<span class="string">&#x27;\u0044\u0061\u0074\u0065&#x27;</span>][<span class="string">&#x27;\u0070\u0072\u006f\u0074\u006f\u0074\u0079\u0070\u0065&#x27;</span>][<span class="string">&#x27;\u0066\u006f\u0072\u006d\u0061\u0074&#x27;</span>] = <span class="function"><span class="keyword">function</span>(<span class="params">formatStr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> str = formatStr;</span><br><span class="line">    <span class="keyword">var</span> Week = [<span class="string">&#x27;\u65e5&#x27;</span>, <span class="string">&#x27;\u4e00&#x27;</span>, <span class="string">&#x27;\u4e8c&#x27;</span>, <span class="string">&#x27;\u4e09&#x27;</span>, <span class="string">&#x27;\u56db&#x27;</span>, <span class="string">&#x27;\u4e94&#x27;</span>, <span class="string">&#x27;\u516d&#x27;</span>];</span><br><span class="line">    str = str[<span class="string">&#x27;\u0072\u0065\u0070\u006c\u0061\u0063\u0065&#x27;</span>](<span class="regexp">/yyyy|YYYY/</span>, <span class="built_in">this</span>[<span class="string">&#x27;\u0067\u0065\u0074\u0046\u0075\u006c\u006c\u0059\u0065\u0061\u0072&#x27;</span>]());</span><br><span class="line">    str = str[<span class="string">&#x27;\u0072\u0065\u0070\u006c\u0061\u0063\u0065&#x27;</span>](<span class="regexp">/MM/</span>, (<span class="built_in">this</span>[<span class="string">&#x27;\u0067\u0065\u0074\u004d\u006f\u006e\u0074\u0068&#x27;</span>]() + <span class="number">1</span>) &gt; <span class="number">9</span> ? (<span class="built_in">this</span>[<span class="string">&#x27;\u0067\u0065\u0074\u004d\u006f\u006e\u0074\u0068&#x27;</span>]() + <span class="number">1</span>).toString() : <span class="string">&#x27;\u0030&#x27;</span> + (<span class="built_in">this</span>[<span class="string">&#x27;\u0067\u0065\u0074\u004d\u006f\u006e\u0074\u0068&#x27;</span>]() + <span class="number">1</span>));</span><br><span class="line">    str = str[<span class="string">&#x27;\u0072\u0065\u0070\u006c\u0061\u0063\u0065&#x27;</span>](<span class="regexp">/dd|DD/</span>, <span class="built_in">this</span>[<span class="string">&#x27;\u0067\u0065\u0074\u0044\u0061\u0074\u0065&#x27;</span>]() &gt; <span class="number">9</span> ? <span class="built_in">this</span>[<span class="string">&#x27;\u0067\u0065\u0074\u0044\u0061\u0074\u0065&#x27;</span>]().toString() : <span class="string">&#x27;\u0030&#x27;</span> + <span class="built_in">this</span>[<span class="string">&#x27;\u0067\u0065\u0074\u0044\u0061\u0074\u0065&#x27;</span>]());</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">window</span>[<span class="string">&#x27;\u0044\u0061\u0074\u0065&#x27;</span>]()[<span class="string">&#x27;\u0066\u006f\u0072\u006d\u0061\u0074&#x27;</span>](<span class="string">&#x27;\u0079\u0079\u0079\u0079\u002d\u004d\u004d\u002d\u0064\u0064&#x27;</span>));</span><br></pre></td></tr></table></figure>
<p>unicode字符和十六进制字符串都能轻易的还原，即直接把字符串放到控制台打印即可还原。</p>
<h5 id="字符串的ASCII码混淆"><a href="#字符串的ASCII码混淆" class="headerlink" title="字符串的ASCII码混淆"></a>字符串的ASCII码混淆</h5><p>首先关注2个方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;x&#x27;</span>.charCodeAt(<span class="number">0</span>));						 <span class="comment">//120</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;b&#x27;</span>.charCodeAt(<span class="number">0</span>));						 <span class="comment">//98</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">String</span>.fromCharCode(<span class="number">120</span>, <span class="number">98</span>)); <span class="comment">//xb</span></span><br></pre></td></tr></table></figure>
<p>charCodeAt方法表示把字符串转换成ASCII编码，fromCharCode表示把ASCII码转换为字符串形式。</p>
<p>可以通过以下代码将字符串变成字节数组。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stringToByte</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  	<span class="keyword">var</span> byteArr = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; str.length; i++) &#123;</span><br><span class="line">        byteArr.push(str.charCodeAt(i));</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="keyword">return</span> byteArr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>比如demo中的format可以用字节数组表示为[102, 111, 114, 109, 97, 116]，因此代码中的format可以表示成String.fromCharCode(102, 111, 114, 109, 97, 116)。注意，fromCharCode接受的参数类型不是数组，而是可变参数类型。如果非要传一个数组，可以使用String.fromCharCode.apply(null, [102, 111, 114, 109, 97, 116])。<strong>JS的函数也是对象，可以给函数定义属性和方法，而函数本身也自带一些属性和方法。apply就是从函数的原型对象Function.prototype继承过来的方法</strong>。</p>
<p>ASCII码混淆不仅可以用于混淆字符串，还可以用来做代码混淆。比如我们把代码<code>str = str[&#39;replace&#39;](/yyyy|YYYY/, this[&#39;getFullYear&#39;]());</code>看作一个字符串：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stringToByte(<span class="string">&quot;str = str[&#x27;replace&#x27;](/yyyy|YYYY/, this[&#x27;getFullYear&#x27;]());&quot;</span>);</span><br><span class="line"><span class="comment">// [ 115, 116, 114,  32,  61, 32, 115, 116, 114,  91, 39, 114, 101, 112, 108,  97, 99, 101,  39,  93,  40, 47, 121, 121, 121, 121, 124, 89,  89,  89,  89,  47, 44, 32, 116, 104, 105, 115, 91,  39, 103, 101, 116, 70, 117, 108, 108,  89, 101, 97, 114,  39,  93,  40, 41, 41,  59 ]</span></span><br></pre></td></tr></table></figure>
<p>然后再把这个字符串当作代码执行即可。在JS中把字符串当作代码执行的有2个方法，eval和Function。其中eval用来执行一段代码，Function用来生成一个函数。</p>
<p>所以我们之前的demo可以改写如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>[<span class="string">&#x27;\u0044\u0061\u0074\u0065&#x27;</span>][<span class="string">&#x27;\u0070\u0072\u006f\u0074\u006f\u0074\u0079\u0070\u0065&#x27;</span>][<span class="string">&#x27;\u0066\u006f\u0072\u006d\u0061\u0074&#x27;</span>] = <span class="function"><span class="keyword">function</span>(<span class="params">formatStr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> str = formatStr;</span><br><span class="line">    <span class="keyword">var</span> Week = [<span class="string">&#x27;\u65e5&#x27;</span>, <span class="string">&#x27;\u4e00&#x27;</span>, <span class="string">&#x27;\u4e8c&#x27;</span>, <span class="string">&#x27;\u4e09&#x27;</span>, <span class="string">&#x27;\u56db&#x27;</span>, <span class="string">&#x27;\u4e94&#x27;</span>, <span class="string">&#x27;\u516d&#x27;</span>];</span><br><span class="line">    <span class="built_in">eval</span>(<span class="built_in">String</span>.fromCharCode(<span class="number">115</span>, <span class="number">116</span>, <span class="number">114</span>,  <span class="number">32</span>,  <span class="number">61</span>, <span class="number">32</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">114</span>,  <span class="number">91</span>, <span class="number">39</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">112</span>, <span class="number">108</span>,  <span class="number">97</span>, <span class="number">99</span>, <span class="number">101</span>,  <span class="number">39</span>,  <span class="number">93</span>,  <span class="number">40</span>, <span class="number">47</span>, <span class="number">121</span>, <span class="number">121</span>, <span class="number">121</span>, <span class="number">121</span>, <span class="number">124</span>, <span class="number">89</span>,  <span class="number">89</span>,  <span class="number">89</span>,  <span class="number">89</span>,  <span class="number">47</span>, <span class="number">44</span>, <span class="number">32</span>, <span class="number">116</span>, <span class="number">104</span>, <span class="number">105</span>, <span class="number">115</span>, <span class="number">91</span>,  <span class="number">39</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">70</span>, <span class="number">117</span>, <span class="number">108</span>, <span class="number">108</span>,  <span class="number">89</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">114</span>,  <span class="number">39</span>,  <span class="number">93</span>,  <span class="number">40</span>, <span class="number">41</span>, <span class="number">41</span>,  <span class="number">59</span>))</span><br><span class="line">    str = str[<span class="string">&#x27;\u0072\u0065\u0070\u006c\u0061\u0063\u0065&#x27;</span>](<span class="regexp">/MM/</span>, (<span class="built_in">this</span>[<span class="string">&#x27;\u0067\u0065\u0074\u004d\u006f\u006e\u0074\u0068&#x27;</span>]() + <span class="number">1</span>) &gt; <span class="number">9</span> ? (<span class="built_in">this</span>[<span class="string">&#x27;\u0067\u0065\u0074\u004d\u006f\u006e\u0074\u0068&#x27;</span>]() + <span class="number">1</span>).toString() : <span class="string">&#x27;\u0030&#x27;</span> + (<span class="built_in">this</span>[<span class="string">&#x27;\u0067\u0065\u0074\u004d\u006f\u006e\u0074\u0068&#x27;</span>]() + <span class="number">1</span>));</span><br><span class="line">    str = str[<span class="string">&#x27;\u0072\u0065\u0070\u006c\u0061\u0063\u0065&#x27;</span>](<span class="regexp">/dd|DD/</span>, <span class="built_in">this</span>[<span class="string">&#x27;\u0067\u0065\u0074\u0044\u0061\u0074\u0065&#x27;</span>]() &gt; <span class="number">9</span> ? <span class="built_in">this</span>[<span class="string">&#x27;\u0067\u0065\u0074\u0044\u0061\u0074\u0065&#x27;</span>]().toString() : <span class="string">&#x27;\u0030&#x27;</span> + <span class="built_in">this</span>[<span class="string">&#x27;\u0067\u0065\u0074\u0044\u0061\u0074\u0065&#x27;</span>]());</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">window</span>[<span class="string">&#x27;\u0044\u0061\u0074\u0065&#x27;</span>]()[<span class="string">&#x27;\u0066\u006f\u0072\u006d\u0061\u0074&#x27;</span>](<span class="string">&#x27;\u0079\u0079\u0079\u0079\u002d\u004d\u004d\u002d\u0064\u0064&#x27;</span>));</span><br></pre></td></tr></table></figure>
<h5 id="字符串常量加密"><a href="#字符串常量加密" class="headerlink" title="字符串常量加密"></a>字符串常量加密</h5><p>字符串加密的最核心思想是先把字符串加密得到密文，然后在使用之前，调用对应的函数去解密，得到明文。代码中仅仅出现解密函数和明密文。当然也可以使用不同的加密方法去加密字符串，然后再调用不同的解密函数去解密。字符串加密最简单的方式是Base64编码。</p>
<p>浏览器中自带Base64的编码与解码的函数，其中btoa用来编码，atob用来解码。但是实际的应用中最好是自己去实现，然后加以混淆。注意，字符串加密之后，需要把对应的解码函数放入其中，方能正常运转。比如开头的demo可以改写如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>[atob(<span class="string">&#x27;RGF0ZQ==&#x27;</span>)][atob(<span class="string">&#x27;cHJvdG90eXBl&#x27;</span>)][atob(<span class="string">&#x27;Zm9ybWF0&#x27;</span>)] = <span class="function"><span class="keyword">function</span>(<span class="params">formatStr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> str = formatStr;</span><br><span class="line">    <span class="keyword">var</span> Week = [<span class="string">&#x27;\u65e5&#x27;</span>, <span class="string">&#x27;\u4e00&#x27;</span>, <span class="string">&#x27;\u4e8c&#x27;</span>, <span class="string">&#x27;\u4e09&#x27;</span>, <span class="string">&#x27;\u56db&#x27;</span>, <span class="string">&#x27;\u4e94&#x27;</span>, <span class="string">&#x27;\u516d&#x27;</span>];</span><br><span class="line">    str = str[atob(<span class="string">&#x27;cmVwbGFjZQ==&#x27;</span>)](<span class="regexp">/yyyy|YYYY/</span>, <span class="built_in">this</span>[atob(<span class="string">&#x27;Z2V0RnVsbFllYXI=&#x27;</span>)]());</span><br><span class="line">    str = str[atob(<span class="string">&#x27;cmVwbGFjZQ==&#x27;</span>)](<span class="regexp">/MM/</span>, (<span class="built_in">this</span>[atob(<span class="string">&#x27;Z2V0TW9udGg=&#x27;</span>)]() + <span class="number">1</span>) &gt; <span class="number">9</span> ? (<span class="built_in">this</span>[atob(<span class="string">&#x27;Z2V0TW9udGg=&#x27;</span>)]() + <span class="number">1</span>).toString() : atob(<span class="string">&#x27;MA==&#x27;</span>) + (<span class="built_in">this</span>[atob(<span class="string">&#x27;Z2V0TW9udGg=&#x27;</span>)]() + <span class="number">1</span>));</span><br><span class="line">    str = str[atob(<span class="string">&#x27;cmVwbGFjZQ==&#x27;</span>)](<span class="regexp">/dd|DD/</span>, <span class="built_in">this</span>[atob(<span class="string">&#x27;Z2V0RGF0ZQ==&#x27;</span>)]() &gt; <span class="number">9</span> ? <span class="built_in">this</span>[atob(<span class="string">&#x27;Z2V0RGF0ZQ==&#x27;</span>)]().toString() : atob(<span class="string">&#x27;MA==&#x27;</span>) + <span class="built_in">this</span>[atob(<span class="string">&#x27;Z2V0RGF0ZQ==&#x27;</span>)]());</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">window</span>[atob(<span class="string">&#x27;RGF0ZQ==&#x27;</span>)]()[atob(<span class="string">&#x27;Zm9ybWF0&#x27;</span>)](atob(<span class="string">&#x27;eXl5eS1NTS1kZA==&#x27;</span>)));</span><br></pre></td></tr></table></figure>
<p>在实际的混淆应用中，标识符必须处理成没有语义的，不然很容易定位到关键代码。此外，建议减少使用系统函数，自己去实现相应的函数，因为不管怎样混淆，最终执行过程中，系统函数是固定的，通过Hook技术很容易定位到关键代码。</p>
<h5 id="数值常量加密"><a href="#数值常量加密" class="headerlink" title="数值常量加密"></a>数值常量加密</h5><p>算法加密过程中，会使用一些固定的数值常量，如MD5中的常量0×67452301，0xefcdab89，0x98badcfe和0x10325476，以及SHA1中的常量0x67452301， 0xefcdab89，0x98badcte，0x10325476和0xc3d2e1f0。因此，在标准算法逆向中，会通过搜索这些数值量，来定位代码关键位置,或者确定使用的是哪个算法。当然，在代码中不一定会写十六进制形式，如0x67452301，在代码中可能会与成十进制的1732584193。 安全起见，可以把这些数值常量也进行简单加密。<br>可以利用位异或的特性来加密。例如，如果a^b=c,那么c^b=a。以SHA1算法中的0xc3d2e1f0常量为例，0xc3d2elf0^0x12345678=0xd1e6b788，那么在代码中可以用0xd1e66788^0x12345678来代替0xc3d2e1f0，其中0x12345678可以理解成密钥，它可以随机生成。</p>
<h4 id="增加JS逆向者的工作量"><a href="#增加JS逆向者的工作量" class="headerlink" title="增加JS逆向者的工作量"></a>增加JS逆向者的工作量</h4><h5 id="数组混淆"><a href="#数组混淆" class="headerlink" title="数组混淆"></a>数组混淆</h5><p>看一行代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">window</span>.Date().getTime());</span><br></pre></td></tr></table></figure>
<p>按照前面介绍的对象属性的2种访问方式，使用第二种改写如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>[<span class="string">&#x27;log&#x27;</span>](<span class="keyword">new</span> <span class="built_in">window</span>[<span class="string">&#x27;Date&#x27;</span>]()[<span class="string">&#x27;getTime&#x27;</span>]());</span><br></pre></td></tr></table></figure>
<p>这样产生了三个字符串，我们把三个字符串放在数组里面。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bigArr = [<span class="string">&#x27;Date&#x27;</span>, <span class="string">&#x27;getTime&#x27;</span>, <span class="string">&#x27;log&#x27;</span>];</span><br><span class="line"><span class="built_in">console</span>[bigArr[<span class="number">2</span>]](<span class="keyword">new</span> <span class="built_in">window</span>[bigArr[<span class="number">0</span>]]()[bigArr[<span class="number">1</span>]]());</span><br></pre></td></tr></table></figure>
<p>这就是数组混淆。当代码有上千行，那么数组可以提取的字符串可能也有上千个，然后在代码中引用字符串的时候，全部以bigArr[1001]，bigArr[1002]这种去访问，这样更加不容易建立映射关系了。</p>
<p>在JS中，同一个数组可以存放各种类型，比如布尔，数值，字符串，数组，对象和函数等。因此可以把代码中的一部分函数提取到大数组中去。为了安全，通常对提取到数组中的字符串进行加密处理，把代码处理成字符串就可以进行加密了。比如，对于String.fromCharCode可以改写成：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;</span>[<span class="string">&quot;constructor&quot;</span>][<span class="string">&quot;fromCharCode&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>最前面的表示任意字符串对象或者空字符串，constructor表示构造方法，这样<code>&quot;&quot;[&quot;constructor&quot;]</code>就相当于String。前面的demo处理成数组混淆的形式如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bigArr = [</span><br><span class="line">    <span class="string">&#x27;\u65e5&#x27;</span>, <span class="string">&#x27;\u4e00&#x27;</span>, <span class="string">&#x27;\u4e8c&#x27;</span>, <span class="string">&#x27;\u4e09&#x27;</span>, <span class="string">&#x27;\u56db&#x27;</span>, <span class="string">&#x27;\u4e94&#x27;</span>, <span class="string">&#x27;\u516d&#x27;</span>, <span class="string">&#x27;cmVwbGFjZQ==&#x27;</span>, <span class="string">&#x27;Z2V0TW9udGg=&#x27;</span>, <span class="string">&#x27;MA==&#x27;</span>, <span class="string">&#x27;Z2V0RGF0ZQ==&#x27;</span>, <span class="string">&#x27;RGF0ZQ==&#x27;</span>, <span class="string">&#x27;Zm9ybWF0&#x27;</span>, <span class="string">&#x27;eXl5eS1NTS1kZA==&#x27;</span>, <span class="string">&quot;&quot;</span>[<span class="string">&#x27;constructor&#x27;</span>][<span class="string">&#x27;fromCharCode&#x27;</span>]</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>[atob(<span class="string">&#x27;RGF0ZQ==&#x27;</span>)][atob(<span class="string">&#x27;cHJvdG90eXBl&#x27;</span>)][atob(<span class="string">&#x27;Zm9ybWF0&#x27;</span>)] = <span class="function"><span class="keyword">function</span>(<span class="params">formatStr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> str = formatStr;</span><br><span class="line">    <span class="keyword">var</span> Week = [bigArr[<span class="number">0</span>], bigArr[<span class="number">1</span>], bigArr[<span class="number">2</span>], bigArr[<span class="number">3</span>], bigArr[<span class="number">4</span>], bigArr[<span class="number">5</span>], bigArr[<span class="number">6</span>]];</span><br><span class="line">    <span class="built_in">eval</span>(bigArr[<span class="number">14</span>](<span class="number">115</span>, <span class="number">116</span>, <span class="number">114</span>,  <span class="number">32</span>,  <span class="number">61</span>, <span class="number">32</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">114</span>,  <span class="number">91</span>, <span class="number">39</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">112</span>, <span class="number">108</span>,  <span class="number">97</span>, <span class="number">99</span>, <span class="number">101</span>,  <span class="number">39</span>,  <span class="number">93</span>,  <span class="number">40</span>, <span class="number">47</span>, <span class="number">121</span>, <span class="number">121</span>, <span class="number">121</span>, <span class="number">121</span>, <span class="number">124</span>, <span class="number">89</span>,  <span class="number">89</span>,  <span class="number">89</span>,  <span class="number">89</span>,  <span class="number">47</span>, <span class="number">44</span>, <span class="number">32</span>, <span class="number">116</span>, <span class="number">104</span>, <span class="number">105</span>, <span class="number">115</span>, <span class="number">91</span>,  <span class="number">39</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">70</span>, <span class="number">117</span>, <span class="number">108</span>, <span class="number">108</span>,  <span class="number">89</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">114</span>,  <span class="number">39</span>,  <span class="number">93</span>,  <span class="number">40</span>, <span class="number">41</span>, <span class="number">41</span>,  <span class="number">59</span>));</span><br><span class="line">    str = str[atob(bigArr[<span class="number">7</span>])](<span class="regexp">/MM/</span>, (<span class="built_in">this</span>[atob(bigArr[<span class="number">8</span>])]() + <span class="number">1</span>) &gt; <span class="number">9</span> ? (<span class="built_in">this</span>[atob(bigArr[<span class="number">8</span>])]() + <span class="number">1</span>).toString() : atob(bigArr[<span class="number">9</span>]) + (<span class="built_in">this</span>[atob(bigArr[<span class="number">8</span>])]() + <span class="number">1</span>));</span><br><span class="line">    str = str[atob(bigArr[<span class="number">7</span>])](<span class="regexp">/dd|DD/</span>, <span class="built_in">this</span>[atob(bigArr[<span class="number">10</span>])]() &gt; <span class="number">9</span> ? <span class="built_in">this</span>[atob(bigArr[<span class="number">10</span>])]().toString() : atob(bigArr[<span class="number">9</span>]) + <span class="built_in">this</span>[atob(bigArr[<span class="number">10</span>])]());</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">window</span>[atob(bigArr[<span class="number">11</span>])]()[atob(bigArr[<span class="number">12</span>])](atob(bigArr[<span class="number">13</span>])));</span><br></pre></td></tr></table></figure>
<h5 id="数组乱序"><a href="#数组乱序" class="headerlink" title="数组乱序"></a>数组乱序</h5><p>上边进行数组混淆之后，数组下标索引与数组成员是一一对应。比如引用bigArr[14]的地方，需要成员String.fromCharCode，而该数组的下标为14的成员刚好是这个方法。可以将数组成员打乱，这样在分析的时候就更加费力，然后在执行的时候，通过一个方法将打乱的数组还原，从而不影响正确的逻辑。</p>
<p>可以使用以下代码打乱数组：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">var</span> bigArr = [</span><br><span class="line">    <span class="string">&#x27;\u65e5&#x27;</span>, <span class="string">&#x27;\u4e00&#x27;</span>, <span class="string">&#x27;\u4e8c&#x27;</span>, <span class="string">&#x27;\u4e09&#x27;</span>, <span class="string">&#x27;\u56db&#x27;</span>, <span class="string">&#x27;\u4e94&#x27;</span>, <span class="string">&#x27;\u516d&#x27;</span>, <span class="string">&#x27;cmVwbGFjZQ==&#x27;</span>, <span class="string">&#x27;Z2V0TW9udGg=&#x27;</span>, <span class="string">&#x27;MA==&#x27;</span>, <span class="string">&#x27;Z2V0RGF0ZQ==&#x27;</span>, <span class="string">&#x27;RGF0ZQ==&#x27;</span>, <span class="string">&#x27;Zm9ybWF0&#x27;</span>, <span class="string">&#x27;eXl5eS1NTS1kZA==&#x27;</span>, <span class="string">&quot;&quot;</span>[<span class="string">&#x27;constructor&#x27;</span>][<span class="string">&#x27;fromCharCode&#x27;</span>]</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">arr, num</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> shuffer = <span class="function"><span class="keyword">function</span>(<span class="params">nums</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (--nums) &#123;</span><br><span class="line">            arr.unshift(arr.pop());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    shuffer(++num);</span><br><span class="line">&#125;(bigArr, <span class="number">0x20</span>));</span><br></pre></td></tr></table></figure>
<p>可以使用以下代码还原数组：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bigArr = [</span><br><span class="line">    <span class="string">&#x27;eXl5eS1NTS1kZA==&#x27;</span>, <span class="string">&quot;&quot;</span>[<span class="string">&#x27;constructor&#x27;</span>][<span class="string">&#x27;fromCharCode&#x27;</span>], <span class="string">&#x27;\u65e5&#x27;</span>, <span class="string">&#x27;\u4e00&#x27;</span>, <span class="string">&#x27;\u4e8c&#x27;</span>, <span class="string">&#x27;\u4e09&#x27;</span>, <span class="string">&#x27;\u56db&#x27;</span>, <span class="string">&#x27;\u4e94&#x27;</span>, <span class="string">&#x27;\u516d&#x27;</span>, <span class="string">&#x27;cmVwbGFjZQ==&#x27;</span>, <span class="string">&#x27;Z2V0TW9udGg=&#x27;</span>, <span class="string">&#x27;MA==&#x27;</span>, <span class="string">&#x27;Z2V0RGF0ZQ==&#x27;</span>, <span class="string">&#x27;RGF0ZQ==&#x27;</span>, <span class="string">&#x27;Zm9ybWF0&#x27;</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">arr, num</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> shuffer = <span class="function"><span class="keyword">function</span>(<span class="params">nums</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (--nums) &#123;</span><br><span class="line">            arr[<span class="string">&#x27;push&#x27;</span>](arr[<span class="string">&#x27;shift&#x27;</span>]());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    shuffer(++num);</span><br><span class="line">&#125;(bigArr, <span class="number">0x20</span>));</span><br></pre></td></tr></table></figure>
<p>所以最前面的demo经过数组混淆和数组乱序之后，可以改写为如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bigArr = [</span><br><span class="line">    <span class="string">&#x27;eXl5eS1NTS1kZA==&#x27;</span>, <span class="string">&quot;&quot;</span>[<span class="string">&#x27;constructor&#x27;</span>][<span class="string">&#x27;fromCharCode&#x27;</span>], <span class="string">&#x27;\u65e5&#x27;</span>, <span class="string">&#x27;\u4e00&#x27;</span>, <span class="string">&#x27;\u4e8c&#x27;</span>, <span class="string">&#x27;\u4e09&#x27;</span>, <span class="string">&#x27;\u56db&#x27;</span>, <span class="string">&#x27;\u4e94&#x27;</span>, <span class="string">&#x27;\u516d&#x27;</span>, <span class="string">&#x27;cmVwbGFjZQ==&#x27;</span>, <span class="string">&#x27;Z2V0TW9udGg=&#x27;</span>, <span class="string">&#x27;MA==&#x27;</span>, <span class="string">&#x27;Z2V0RGF0ZQ==&#x27;</span>, <span class="string">&#x27;RGF0ZQ==&#x27;</span>, <span class="string">&#x27;Zm9ybWF0&#x27;</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">arr, num</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> shuffer = <span class="function"><span class="keyword">function</span>(<span class="params">nums</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (--nums) &#123;</span><br><span class="line">            arr[<span class="string">&#x27;push&#x27;</span>](arr[<span class="string">&#x27;shift&#x27;</span>]());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    shuffer(++num);</span><br><span class="line">&#125;(bigArr, <span class="number">0x20</span>));</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>[atob(<span class="string">&#x27;RGF0ZQ==&#x27;</span>)][atob(<span class="string">&#x27;cHJvdG90eXBl&#x27;</span>)][atob(<span class="string">&#x27;Zm9ybWF0&#x27;</span>)] = <span class="function"><span class="keyword">function</span>(<span class="params">formatStr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> str = formatStr;</span><br><span class="line">    <span class="keyword">var</span> Week = [bigArr[<span class="number">0</span>], bigArr[<span class="number">1</span>], bigArr[<span class="number">2</span>], bigArr[<span class="number">3</span>], bigArr[<span class="number">4</span>], bigArr[<span class="number">5</span>], bigArr[<span class="number">6</span>]];</span><br><span class="line">    <span class="built_in">eval</span>(bigArr[<span class="number">14</span>](<span class="number">115</span>, <span class="number">116</span>, <span class="number">114</span>,  <span class="number">32</span>,  <span class="number">61</span>, <span class="number">32</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">114</span>,  <span class="number">91</span>, <span class="number">39</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">112</span>, <span class="number">108</span>,  <span class="number">97</span>, <span class="number">99</span>, <span class="number">101</span>,  <span class="number">39</span>,  <span class="number">93</span>,  <span class="number">40</span>, <span class="number">47</span>, <span class="number">121</span>, <span class="number">121</span>, <span class="number">121</span>, <span class="number">121</span>, <span class="number">124</span>, <span class="number">89</span>,  <span class="number">89</span>,  <span class="number">89</span>,  <span class="number">89</span>,  <span class="number">47</span>, <span class="number">44</span>, <span class="number">32</span>, <span class="number">116</span>, <span class="number">104</span>, <span class="number">105</span>, <span class="number">115</span>, <span class="number">91</span>,  <span class="number">39</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">70</span>, <span class="number">117</span>, <span class="number">108</span>, <span class="number">108</span>,  <span class="number">89</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">114</span>,  <span class="number">39</span>,  <span class="number">93</span>,  <span class="number">40</span>, <span class="number">41</span>, <span class="number">41</span>,  <span class="number">59</span>));</span><br><span class="line">    str = str[atob(bigArr[<span class="number">7</span>])](<span class="regexp">/MM/</span>, (<span class="built_in">this</span>[atob(bigArr[<span class="number">8</span>])]() + <span class="number">1</span>) &gt; <span class="number">9</span> ? (<span class="built_in">this</span>[atob(bigArr[<span class="number">8</span>])]() + <span class="number">1</span>).toString() : atob(bigArr[<span class="number">9</span>]) + (<span class="built_in">this</span>[atob(bigArr[<span class="number">8</span>])]() + <span class="number">1</span>));</span><br><span class="line">    str = str[atob(bigArr[<span class="number">7</span>])](<span class="regexp">/dd|DD/</span>, <span class="built_in">this</span>[atob(bigArr[<span class="number">10</span>])]() &gt; <span class="number">9</span> ? <span class="built_in">this</span>[atob(bigArr[<span class="number">10</span>])]().toString() : atob(bigArr[<span class="number">9</span>]) + <span class="built_in">this</span>[atob(bigArr[<span class="number">10</span>])]());</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">window</span>[atob(bigArr[<span class="number">11</span>])]()[atob(bigArr[<span class="number">12</span>])](atob(bigArr[<span class="number">13</span>])));</span><br></pre></td></tr></table></figure>
<h5 id="花指令"><a href="#花指令" class="headerlink" title="花指令"></a>花指令</h5><p>所谓花指令，就是添加一些没有意义却可以混淆视听的代码。以前面提到的demo中的某一行代码为例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">str = str.replace(<span class="regexp">/MM/</span>, (<span class="built_in">this</span>.getMonth() + <span class="number">1</span>) &gt; <span class="number">9</span> ? (<span class="built_in">this</span>.getMonth() + <span class="number">1</span>).toString() : <span class="string">&#x27;0&#x27;</span> + (<span class="built_in">this</span>.getMonth() + <span class="number">1</span>));</span><br></pre></td></tr></table></figure>
<p>把this.getMonth() + 1这个二项式改写为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_0x20abefx1</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// str = str.replace(/MM/, (_0x20abefx1(new Date().getMonth(), 1)) &gt; 9 ? (_0x20abefx1(new Date().getMonth(), 1)).toString() : &#x27;0&#x27; + (_0x20abefx1(new Date().getMonth(), 1)));</span></span><br></pre></td></tr></table></figure>
<p>本质是把一个二项式拆成三个部分，最左边和最右边的参数，中间的运算符可以封装成一个函数，这个函数没有什么意义，但是能瞬间增加代码量，从而增加JS你逆向者的工作量。</p>
<p>二项式转成函数时，还可以多级嵌套：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_0x20abefx1</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_0x20abefx2</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _0x20abefx1(a, b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具有同样功能的二项式，可以调用不同的函数，比如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_0x20abefx1</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_0x20abefx2</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_0x20abefx3</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _0x20abefx1(a, b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// str = str.replace(/MM/, (_0x20abefx1(new Date().getMonth(), 1)) &gt; 9 ? (_0x20abefx2(new Date().getMonth(), 1)).toString() : &#x27;0&#x27; + (_0x20abefx3(new Date().getMonth(), 1)));</span></span><br></pre></td></tr></table></figure>
<p>除了二项式转为函数可以使用花指令，函数调用表达式也可以处理成类似的花指令：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_0x20abefx1</span>(<span class="params">a, b, c</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a(b, c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_0x20abefx2</span>(<span class="params">a, b, c</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _0x20abefx1(a, b, c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_0x20abefx3</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">str = str.replace(</span><br><span class="line">    <span class="regexp">/MM/</span>, </span><br><span class="line">    _0x20abefx2(_0x20abefx3, <span class="keyword">new</span> <span class="built_in">Date</span>().getMonth(), <span class="number">1</span>) &gt; <span class="number">9</span> ? (_0x20abefx2(_0x20abefx3, <span class="keyword">new</span> <span class="built_in">Date</span>().getMonth(), <span class="number">1</span>)).toString() : _0x20abefx2(_0x20abefx3, <span class="string">&#x27;0&#x27;</span>, (_0x20abefx2(_0x20abefx3, <span class="keyword">new</span> <span class="built_in">Date</span>().getMonth(), <span class="number">1</span>)))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h5 id="jsfuck"><a href="#jsfuck" class="headerlink" title="jsfuck"></a>jsfuck</h5><p>jsfuck可以看作一种编码方式，可以把JS代码通过只用()，[]，+，!这6种字符表示的代码，并且可以正常阅读。比如数值常量8可以表示成：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(!+[]+!![]+!![]+!![]+!![]+!![]+!![]+!![]+[])</span><br></pre></td></tr></table></figure>
<p>[]表示空数组，+[]表示把空数组转换为数值然后进行运行，由于空数组是0，所以+[]表示数值0，!+[]表示对数值0取反为布尔值true。</p>
<p>JS中有七种值为false，其余都为true。这7种值为false, undefine, null, 0, -0, NaN和””。所以!![]为true。</p>
<p>JS中的+运算符作为一个二元运算符时，假如有一边是字符串则代表字符串拼接，否则代表数值相加。所以true + true = 2。</p>
<p>在实际的开发中，jsfuck的应用有限。只会应用于js文件中的一部分代码。主要它的代码量非常庞大，且易于还原，只需要将代码复制到console即可还原。在jsfuck的混淆中，通过用()来进行分组，如果我们遇到JS文件局部应用jsfuck的代码，可以先通过()将代码分组，然后逐组逐组的分析还原。</p>
<h4 id="代码执行流程的防护原理"><a href="#代码执行流程的防护原理" class="headerlink" title="代码执行流程的防护原理"></a>代码执行流程的防护原理</h4><h5 id="流程平坦化"><a href="#流程平坦化" class="headerlink" title="流程平坦化"></a>流程平坦化</h5><p>在流程平坦化混淆中，会用到switch语句，因为switch语句中的case块是平级的，而且调换case块的前后顺序并不影响代码原先的执行逻辑。看一段代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">var</span> b = a + <span class="number">200</span>;</span><br><span class="line">    <span class="keyword">var</span> c = b + <span class="number">300</span>;</span><br><span class="line">    <span class="keyword">var</span> d = c + <span class="number">400</span>;</span><br><span class="line">    <span class="keyword">var</span> e = d + <span class="number">500</span>;</span><br><span class="line">    <span class="keyword">var</span> f = e + <span class="number">600</span>;</span><br><span class="line">    <span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>混淆test方法的执行流程为：首先把代码分块，且打乱代码块的顺序，分别添加到不同的case块中，方便起见，这里处理场一行代码对应一个case块的形式，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> () &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">        <span class="keyword">var</span> c = b + <span class="number">300</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">        <span class="keyword">var</span> e = d + <span class="number">500</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">        <span class="keyword">var</span> d = c + <span class="number">400</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;4&#x27;</span>:</span><br><span class="line">        <span class="keyword">var</span> f = e + <span class="number">600</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;5&#x27;</span>:</span><br><span class="line">        <span class="keyword">var</span> b = a + <span class="number">200</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;6&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> f;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;7&#x27;</span>:</span><br><span class="line">        <span class="keyword">var</span> a = <span class="number">100</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，当代码块打乱之后，如果想跟原先的执行顺序一样，那么case块的跳转顺序应该是7，5，1，3，2，4，6。只有case块按照这个流程执行，才能跟原始代码块的顺序保持一致。其次，需要一个循环，因为switch语句只计算一次switch表达式。整个代码改写如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (!![]) &#123;</span><br><span class="line">    <span class="keyword">switch</span> () &#123;</span><br><span class="line">     <span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">         <span class="keyword">var</span> c = b + <span class="number">300</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">     <span class="keyword">case</span> <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">         <span class="keyword">var</span> e = d + <span class="number">500</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">     <span class="keyword">case</span> <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">         <span class="keyword">var</span> d = c + <span class="number">400</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">     <span class="keyword">case</span> <span class="string">&#x27;4&#x27;</span>:</span><br><span class="line">         <span class="keyword">var</span> f = e + <span class="number">600</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">     <span class="keyword">case</span> <span class="string">&#x27;5&#x27;</span>:</span><br><span class="line">         <span class="keyword">var</span> b = a + <span class="number">200</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">     <span class="keyword">case</span> <span class="string">&#x27;6&#x27;</span>:</span><br><span class="line">         <span class="keyword">return</span> f;</span><br><span class="line">     <span class="keyword">case</span> <span class="string">&#x27;7&#x27;</span>:</span><br><span class="line">         <span class="keyword">var</span> a = <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是一个死循环，假如函数有返回值，则执行到相应的case语句块后直接返回。假如函数没有返回值，则代码块执行到最后就需要让switch计算出来的表达式的值与每一个case的值都不匹配，那么就会执行最后的break来跳出循环。</p>
<p>接着我们需要构造一个分发器，里面记录代码块执行的真实顺序，例如var arrStr = ‘7|5|1|3|2|4|6’.split(‘|’)，i=0。把这个字符串’7|5|1|3|2|4|6’通过split分割成一个数组。i作为计数器，每次递增，按顺序引用数组中的每一个成员。因此，switch中的表达式就可以写成switch(arrStr[i++])，完整代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> arrStr = <span class="string">&#x27;7|5|1|3|2|4|6&#x27;</span>.split(<span class="string">&#x27;|&#x27;</span>)，i=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (!![]) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (arrStr[i++]) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">                <span class="keyword">var</span> c = b + <span class="number">300</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">                <span class="keyword">var</span> e = d + <span class="number">500</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">                <span class="keyword">var</span> d = c + <span class="number">400</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;4&#x27;</span>:</span><br><span class="line">                <span class="keyword">var</span> f = e + <span class="number">600</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;5&#x27;</span>:</span><br><span class="line">                <span class="keyword">var</span> b = a + <span class="number">200</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;6&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span> f;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;7&#x27;</span>:</span><br><span class="line">                <span class="keyword">var</span> a = <span class="number">100</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果函数没有返回值，即switch中没有return语句，最后一次递增i会导致数组越界，JS中数组越界不会报错，而是取出来为undefined，然后匹配不到任何的switch语句就会执行break跳出死循环。</p>
<p>在了解了流程平坦化之后，我们可以对之前的demo进一步混淆：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bigArr = [</span><br><span class="line">    <span class="string">&#x27;eXl5eS1NTS1kZA==&#x27;</span>, <span class="string">&quot;&quot;</span>[<span class="string">&#x27;constructor&#x27;</span>][<span class="string">&#x27;fromCharCode&#x27;</span>], <span class="string">&#x27;\u65e5&#x27;</span>, <span class="string">&#x27;\u4e00&#x27;</span>, <span class="string">&#x27;\u4e8c&#x27;</span>, <span class="string">&#x27;\u4e09&#x27;</span>, <span class="string">&#x27;\u56db&#x27;</span>, <span class="string">&#x27;\u4e94&#x27;</span>, <span class="string">&#x27;\u516d&#x27;</span>, <span class="string">&#x27;cmVwbGFjZQ==&#x27;</span>, <span class="string">&#x27;Z2V0TW9udGg=&#x27;</span>, <span class="string">&#x27;MA==&#x27;</span>, <span class="string">&#x27;Z2V0RGF0ZQ==&#x27;</span>, <span class="string">&#x27;RGF0ZQ==&#x27;</span>, <span class="string">&#x27;Zm9ybWF0&#x27;</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">arr, num</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> shuffer = <span class="function"><span class="keyword">function</span>(<span class="params">nums</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (--nums) &#123;</span><br><span class="line">            arr[<span class="string">&#x27;push&#x27;</span>](arr[<span class="string">&#x27;shift&#x27;</span>]());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    shuffer(++num);</span><br><span class="line">&#125;(bigArr, <span class="number">0x20</span>));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_0x20abefx1</span>(<span class="params">a, b, c</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a(b, c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_0x20abefx2</span>(<span class="params">a, b, c</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _0x20abefx1(a, b, c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_0x20abefx3</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>[atob(<span class="string">&#x27;RGF0ZQ==&#x27;</span>)][atob(<span class="string">&#x27;cHJvdG90eXBl&#x27;</span>)][atob(<span class="string">&#x27;Zm9ybWF0&#x27;</span>)] = <span class="function"><span class="keyword">function</span>(<span class="params">formatStr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> arrStr = <span class="string">&#x27;7|5|1|3|2|4&#x27;</span>.split(<span class="string">&quot;|&quot;</span>), i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (!![]) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (arrStr[i++]) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">                <span class="built_in">eval</span>(bigArr[<span class="number">14</span>](<span class="number">115</span>, <span class="number">116</span>, <span class="number">114</span>,  <span class="number">32</span>,  <span class="number">61</span>, <span class="number">32</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">114</span>,  <span class="number">91</span>, <span class="number">39</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">112</span>, <span class="number">108</span>,  <span class="number">97</span>, <span class="number">99</span>, <span class="number">101</span>,  <span class="number">39</span>,  <span class="number">93</span>,  <span class="number">40</span>, <span class="number">47</span>, <span class="number">121</span>, <span class="number">121</span>, <span class="number">121</span>, <span class="number">121</span>, <span class="number">124</span>, <span class="number">89</span>,  <span class="number">89</span>,  <span class="number">89</span>,  <span class="number">89</span>,  <span class="number">47</span>, <span class="number">44</span>, <span class="number">32</span>, <span class="number">116</span>, <span class="number">104</span>, <span class="number">105</span>, <span class="number">115</span>, <span class="number">91</span>,  <span class="number">39</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">70</span>, <span class="number">117</span>, <span class="number">108</span>, <span class="number">108</span>,  <span class="number">89</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">114</span>,  <span class="number">39</span>,  <span class="number">93</span>,  <span class="number">40</span>, <span class="number">41</span>, <span class="number">41</span>,  <span class="number">59</span>));</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">                str = str[atob(bigArr[<span class="number">7</span>])](</span><br><span class="line">    				<span class="regexp">/dd|DD/</span>,</span><br><span class="line">    				<span class="built_in">this</span>[atob(bigArr[<span class="number">10</span>])] &gt; <span class="number">9</span> ? <span class="built_in">this</span>[atob(bigArr[<span class="number">10</span>])]().toString() : _0x20abefx2(_0x20abefx3, atob(bigArr[<span class="number">9</span>]), <span class="built_in">this</span>[atob(bigArr[<span class="number">10</span>])]())</span><br><span class="line">);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">                str = str[atob(bigArr[<span class="number">7</span>])](</span><br><span class="line">    				<span class="regexp">/MM/</span>,</span><br><span class="line">    				_0x20abefx2(_0x20abefx3, <span class="built_in">this</span>[atob(bigArr[<span class="number">8</span>])](), <span class="number">1</span>) &gt; <span class="number">9</span> ? (_0x20abefx2(_0x20abefx3, <span class="built_in">this</span>[atob(bigArr[<span class="number">8</span>])](), <span class="number">1</span>)).toString() : _0x20abefx2(_0x20abefx3, atob(bigArr[<span class="number">9</span>]), (_0x20abefx2(_0x20abefx3, <span class="built_in">this</span>[atob(bigArr[<span class="number">8</span>])](), <span class="number">1</span>)))</span><br><span class="line">);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;4&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span> str;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;5&#x27;</span>:</span><br><span class="line">     			<span class="keyword">var</span> Week = [bigArr[<span class="number">0</span>], bigArr[<span class="number">1</span>], bigArr[<span class="number">2</span>], bigArr[<span class="number">3</span>], bigArr[<span class="number">4</span>], bigArr[<span class="number">5</span>], bigArr[<span class="number">6</span>]];</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;7&#x27;</span>:</span><br><span class="line">     			<span class="keyword">var</span> \u0073\u0074\u0072 = \u0066\u006f\u0072\u006d\u0061\u0074\u0053\u0074\u0072; </span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">window</span>[atob(bigArr[<span class="number">11</span>])]()[atob(bigArr[<span class="number">12</span>])](atob(bigArr[<span class="number">13</span>])));</span><br></pre></td></tr></table></figure>
<h5 id="逗号表达式混淆"><a href="#逗号表达式混淆" class="headerlink" title="逗号表达式混淆"></a>逗号表达式混淆</h5><p>逗号运算符的主要作用是把多个表达式或语句连接成一个复合语句。比如前面提到的test方法，可以改写为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> a, b, c, d, e, f;</span><br><span class="line">    <span class="keyword">return</span> a = <span class="number">100</span>, b = a + <span class="number">200</span>, c = b + <span class="number">300</span>, d = c + <span class="number">400</span>, e = d + <span class="number">500</span>, f = e + <span class="number">600</span>, f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>return语句通常只跟一个语句，但是逗号表达式可以把多个语句符合成一个语句，这样会依次执行前面的语句，然后把最后一条语句作为返回值。</p>
<p>再看一个例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = (a = <span class="number">100</span>, a += <span class="number">200</span>)</span><br><span class="line"><span class="built_in">console</span>.log(a); <span class="comment">// 300</span></span><br></pre></td></tr></table></figure>
<p>括号会作为一个整体，先把括号里面的运算完，然后把这个整体的值赋值给a。明白了这个道理，我们再改写下test方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> a, b, c, d, e, f;</span><br><span class="line">    <span class="keyword">return</span> f = (e = (d = (c = (b = (a = <span class="number">100</span>, a + <span class="number">200</span>), b + <span class="number">300</span>), c + <span class="number">400</span>), d + <span class="number">500</span>), e + <span class="number">600</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以进一步优化，这里声明了一系列的变量，可以把这些变量作为参数传入，同时，在每一个变量的赋值的逗号表达式中可以插入花指令：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params">a, b, c, d, e, f</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> f = (e = (d = (c = (b = (a = <span class="number">100</span>, b + <span class="number">1000</span>, c + <span class="number">2000</span>, d + <span class="number">3000</span>, e + <span class="number">4000</span>, f + <span class="number">5000</span>, a + <span class="number">200</span>), c + <span class="number">2000</span>, d + <span class="number">3000</span>, e + <span class="number">4000</span>, f + <span class="number">5000</span>, b + <span class="number">300</span>), d + <span class="number">3000</span>, e + <span class="number">4000</span>, f + <span class="number">5000</span>, c + <span class="number">400</span>), e + <span class="number">4000</span>, f + <span class="number">5000</span>, d + <span class="number">500</span>), f + <span class="number">5000</span>, e + <span class="number">600</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>虽然需要6个参数，但是实际上不传任何参数，依然是正确的代码逻辑。同时中间的花指令，b+1000，c+2000，d+3000，e+4000，f+5000是没有意义的。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203081500383.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220308150018181" title="">
                </div>
                <div class="image-caption">image-20220308150018181</div>
            </figure>
<p>我们对前面给的demo进行改写：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bigArr = [</span><br><span class="line">    <span class="string">&#x27;eXl5eS1NTS1kZA==&#x27;</span>, <span class="string">&quot;&quot;</span>[<span class="string">&#x27;constructor&#x27;</span>][<span class="string">&#x27;fromCharCode&#x27;</span>], <span class="string">&#x27;\u65e5&#x27;</span>, <span class="string">&#x27;\u4e00&#x27;</span>, <span class="string">&#x27;\u4e8c&#x27;</span>, <span class="string">&#x27;\u4e09&#x27;</span>, <span class="string">&#x27;\u56db&#x27;</span>, <span class="string">&#x27;\u4e94&#x27;</span>, <span class="string">&#x27;\u516d&#x27;</span>, <span class="string">&#x27;cmVwbGFjZQ==&#x27;</span>, <span class="string">&#x27;Z2V0TW9udGg=&#x27;</span>, <span class="string">&#x27;MA==&#x27;</span>, <span class="string">&#x27;Z2V0RGF0ZQ==&#x27;</span>, <span class="string">&#x27;RGF0ZQ==&#x27;</span>, <span class="string">&#x27;Zm9ybWF0&#x27;</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">arr, num</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> shuffer = <span class="function"><span class="keyword">function</span>(<span class="params">nums</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (--nums) &#123;</span><br><span class="line">            arr[<span class="string">&#x27;push&#x27;</span>](arr[<span class="string">&#x27;shift&#x27;</span>]());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    shuffer(++num);</span><br><span class="line">&#125;(bigArr, <span class="number">0x20</span>));</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>[atob(<span class="string">&#x27;RGF0ZQ==&#x27;</span>)][atob(<span class="string">&#x27;cHJvdG90eXBl&#x27;</span>)][atob(<span class="string">&#x27;Zm9ybWF0&#x27;</span>)] = <span class="function"><span class="keyword">function</span>(<span class="params">formatStr, str, Week</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str = (</span><br><span class="line">        (str = (</span><br><span class="line">                Week = (</span><br><span class="line">                    \u0073\u0074\u0072 = \u0066\u006f\u0072\u006d\u0061\u0074\u0053\u0074\u0072,</span><br><span class="line">                        [bigArr[<span class="number">0</span>], bigArr[<span class="number">1</span>], bigArr[<span class="number">2</span>], bigArr[<span class="number">3</span>], bigArr[<span class="number">4</span>], bigArr[<span class="number">5</span>], bigArr[<span class="number">6</span>]]</span><br><span class="line">                ),</span><br><span class="line">                    <span class="built_in">eval</span>(bigArr[<span class="number">14</span>](<span class="number">115</span>, <span class="number">116</span>, <span class="number">114</span>,  <span class="number">32</span>,  <span class="number">61</span>, <span class="number">32</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">114</span>,  <span class="number">91</span>, <span class="number">39</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">112</span>, <span class="number">108</span>,  <span class="number">97</span>, <span class="number">99</span>, <span class="number">101</span>,  <span class="number">39</span>,  <span class="number">93</span>,  <span class="number">40</span>, <span class="number">47</span>, <span class="number">121</span>, <span class="number">121</span>, <span class="number">121</span>, <span class="number">121</span>, <span class="number">124</span>, <span class="number">89</span>,  <span class="number">89</span>,  <span class="number">89</span>,  <span class="number">89</span>,  <span class="number">47</span>, <span class="number">44</span>, <span class="number">32</span>, <span class="number">116</span>, <span class="number">104</span>, <span class="number">105</span>, <span class="number">115</span>, <span class="number">91</span>,  <span class="number">39</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">70</span>, <span class="number">117</span>, <span class="number">108</span>, <span class="number">108</span>,  <span class="number">89</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">114</span>,  <span class="number">39</span>,  <span class="number">93</span>,  <span class="number">40</span>, <span class="number">41</span>, <span class="number">41</span>,  <span class="number">59</span>)),</span><br><span class="line">                    str[atob(bigArr[<span class="number">7</span>])](<span class="regexp">/MM/</span>, (<span class="built_in">this</span>[atob(bigArr[<span class="number">8</span>])]() + <span class="number">1</span>) &gt; <span class="number">9</span> ? (<span class="built_in">this</span>[atob(bigArr[<span class="number">8</span>])]() + <span class="number">1</span>).toString() : atob(bigArr[<span class="number">9</span>]) + (<span class="built_in">this</span>[atob(bigArr[<span class="number">8</span>])]() + <span class="number">1</span>))</span><br><span class="line">            ),</span><br><span class="line">                str[atob(bigArr[<span class="number">7</span>])](<span class="regexp">/dd|DD/</span>, <span class="built_in">this</span>[atob(bigArr[<span class="number">10</span>])]() &gt; <span class="number">9</span> ? <span class="built_in">this</span>[atob(bigArr[<span class="number">10</span>])]().toString() : atob(bigArr[<span class="number">9</span>]) + <span class="built_in">this</span>[atob(bigArr[<span class="number">10</span>])]())</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">window</span>[atob(bigArr[<span class="number">11</span>])]()[atob(bigArr[<span class="number">12</span>])](atob(bigArr[<span class="number">13</span>])));</span><br></pre></td></tr></table></figure>
<h4 id="其它代码防护方案"><a href="#其它代码防护方案" class="headerlink" title="其它代码防护方案"></a>其它代码防护方案</h4><h5 id="eval加密"><a href="#eval加密" class="headerlink" title="eval加密"></a>eval加密</h5><p>看一段代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="function"><span class="keyword">function</span> (<span class="params">p, a, c, k, e, r</span>) </span>&#123;</span><br><span class="line">    e = <span class="function"><span class="keyword">function</span> (<span class="params">c</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> c.toString(<span class="number">36</span>)</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;0&#x27;</span>.replace(<span class="number">0</span>, e) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (c--)</span><br><span class="line">            r[e(c)] = k[c];</span><br><span class="line">        k = [<span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> r[e] || e</span><br><span class="line">            &#125;</span><br><span class="line">        ];</span><br><span class="line">        e = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;[2-8a-f]&#x27;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        c = <span class="number">1</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">while</span> (c--)</span><br><span class="line">        <span class="keyword">if</span> (k[c])</span><br><span class="line">            p = p.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&#x27;\\b&#x27;</span> + e(c) + <span class="string">&#x27;\\b&#x27;</span>, <span class="string">&#x27;g&#x27;</span>), k[c]);</span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line">&#125;(<span class="string">&#x27;7.prototype.8=function(a)&#123;b 2=a;b Week=[\&#x27;日\&#x27;,\&#x27;一\&#x27;,\&#x27;二\&#x27;,\&#x27;三\&#x27;,\&#x27;四\&#x27;,\&#x27;五\&#x27;,\&#x27;六\&#x27;];2=2.4(/c|YYYY/,3.getFullYear());2=2.4(/d/,(3.5()+1)&gt;9?(3.5()+1).e():\&#x27;0\&#x27;+(3.5()+1));2=2.4(/f|DD/,3.6()&gt;9?3.6().e():\&#x27;0\&#x27;+3.6());return 2&#125;;console.log(new 7().8(\&#x27;c-d-f\&#x27;));&#x27;</span>, [], <span class="number">16</span>, <span class="string">&#x27;||str|this|replace|getMonth|getDate|Date|format||formatStr|var|yyyy|MM|toString|dd&#x27;</span>.split(<span class="string">&#x27;|&#x27;</span>), <span class="number">0</span>, &#123;&#125;))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>传给eval的是一个匿名函数，而不是一个字符串，这就是说先通过匿名函数将加密的代码解密成字符串代码，然后再通过eval之心这串代码。所以eval加密跟eval关系不大，重要的是这个解密函数，eval只是执行解密后的结果，并不参与加解密。</p>
<p>通过解密函数解密出来的字符串代码为：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203081534835.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220308153442661" title="">
                </div>
                <div class="image-caption">image-20220308153442661</div>
            </figure>
<p>通过eval执行解密出来的字符串结果为：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203081535577.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220308153523029" title="">
                </div>
                <div class="image-caption">image-20220308153523029</div>
            </figure>
<h5 id="内存爆破"><a href="#内存爆破" class="headerlink" title="内存爆破"></a>内存爆破</h5><p>内存爆破是指在代码中加入死代码，正常情况下这段代码不执行。当检测到函数被格式化或者函数被Hook的时候，就跳转到这段代码执行，直到内存溢出，浏览器会提示Out of Memory程序奔溃。内存爆破的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> d = [<span class="number">0x1</span>, <span class="number">0x0</span>, <span class="number">0x0</span>];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0x0</span>, c = d.length; i &lt; c; i++) &#123;</span><br><span class="line">        d.push(<span class="built_in">Math</span>.round(<span class="built_in">Math</span>.round()));</span><br><span class="line">        c = d.length;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码中的for循环是一个死循环，但是代码写的又不像 while(true) 这样明显。尤其是代码混淆以后，会更具迷惑性。这段代码其实是从某网站简化而来，原先的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>[<span class="string">&#x27;NsTJKl&#x27;</span>] = [<span class="number">0x1</span>, <span class="number">0x0</span>, <span class="number">0x0</span>]</span><br><span class="line">......</span><br><span class="line"><span class="number">0x4b1809</span>[<span class="string">&#x27;prototype&#x27;</span>][<span class="string">&#x27;xTDWoN&#x27;</span>] = <span class="function"><span class="keyword">function</span>(<span class="params">_0x597ca7</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> _0x3e27c4 = <span class="number">0x0</span>, _0x192434 = <span class="built_in">this</span>[<span class="string">&#x27;NsTJKl&#x27;</span>][<span class="string">&#x27;length&#x27;</span>]; _0x3e27c4 &lt; _0x192434; _0x3e27c4++) &#123;</span><br><span class="line">        <span class="built_in">this</span>[<span class="string">&#x27;NsTJKl&#x27;</span>][<span class="string">&#x27;push&#x27;</span>](<span class="built_in">Math</span>[<span class="string">&#x27;round&#x27;</span>](<span class="built_in">Math</span>[<span class="string">&#x27;random&#x27;</span>]()))</span><br><span class="line">        _0x192434 = <span class="built_in">this</span>[<span class="string">&#x27;NsTJKl&#x27;</span>][<span class="string">&#x27;length&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _0x597ca7(<span class="built_in">this</span>[<span class="string">&#x27;NsTJKl&#x27;</span>][<span class="number">0x0</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>for循环的结束条件是 _03e27c4 &lt; _0x92434，其中 _0x192434 的初始化值是数组的大小。看着像是一个遍历数组的操作，是在循环中，又往数组中push了成员，接着又重新给 _0x192434 赋值为数组的大小。这时这段代码就永远也不会结束了，直到内存溢出。</p>
<h5 id="检测代码是否被格式化"><a href="#检测代码是否被格式化" class="headerlink" title="检测代码是否被格式化"></a>检测代码是否被格式化</h5><p>检测的思路很简单，在JS中，函数是可以转为字符串的。因此可以选择一个函数转为字符串，然后跟内置的字符串对比或者用正则匹配。函数转为字符串很简单：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(add + <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="built_in">console</span>.log(add.toString())</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在调试窗口使用格式化之后，会产生一个后缀为：formatted的文件。之后这个文件中设置断点，触发断点后，会停在这个文件中，选中这个函数，鼠标悬停在上面，会显示出他原来没有格式化之前的样子。</p>

    

        <a href="/JS%E4%BB%A3%E7%A0%81%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94AST%E6%B7%B7%E6%B7%86%E5%8E%9F%E7%90%86/" class="post-more waves-effect waves-button">
            Continue reading...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JS/" rel="tag">JS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%80%86%E5%90%91/" rel="tag">逆向</a></li></ul>

    </div>
    
</article>

        </li>
    
        <li class="post-list-item fade">
            <article id="post-JS逆向中用到的常见的编码和加密"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time class="post-time" title="2022-03-02 21:51:19" datetime="2022-03-02T13:51:19.000Z"  itemprop="datePublished">2022-03-02</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/JS%E9%80%86%E5%90%91/">JS逆向</a></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/JS%E9%80%86%E5%90%91%E4%B8%AD%E7%94%A8%E5%88%B0%E7%9A%84%E5%B8%B8%E8%A7%81%E7%9A%84%E7%BC%96%E7%A0%81%E5%92%8C%E5%8A%A0%E5%AF%86/">JS逆向中用到的常见的编码和加密</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent">

    
        <h4 id="ASCII码"><a href="#ASCII码" class="headerlink" title="ASCII码"></a>ASCII码</h4><h5 id="Python代码演示"><a href="#Python代码演示" class="headerlink" title="Python代码演示"></a>Python代码演示</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">_ = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: <span class="built_in">print</span>(<span class="string">f&quot;ascii of <span class="subst">&#123;x&#125;</span> is&quot;</span>, <span class="built_in">ord</span>(x)), <span class="string">&quot;abcd&quot;</span>))</span><br><span class="line"><span class="comment"># ascii of a is 97</span></span><br><span class="line"><span class="comment"># ascii of b is 98</span></span><br><span class="line"><span class="comment"># ascii of c is 99</span></span><br><span class="line"><span class="comment"># ascii of d is 100</span></span><br></pre></td></tr></table></figure>
<h4 id="Base64"><a href="#Base64" class="headerlink" title="Base64"></a>Base64</h4><h5 id="什么是Base64"><a href="#什么是Base64" class="headerlink" title="什么是Base64"></a>什么是Base64</h5><p>Base64是一种基于64个可打印字符来表示二进制数据的表示方法。</p>
<h5 id="Base64的字符集"><a href="#Base64的字符集" class="headerlink" title="Base64的字符集"></a>Base64的字符集</h5><ul>
<li>数字 {0, 1, 2, 3, 4, 5, 6, 7, 8, 9} 共10位</li>
<li>大小写字母 {A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z, a, b, c, d, e, f, g, h, i, j, k, l, m, n, o, p, q, r, s, t, u, v, w, x, y, z} 共52位</li>
<li>特殊符号 {+, /} 共2位</li>
</ul>
<h5 id="Base64编码过程"><a href="#Base64编码过程" class="headerlink" title="Base64编码过程"></a>Base64编码过程</h5><p>由于base64的字符集大小为64，那么，需要6个比特的二进制数作为一个基本单元表示一个base64字符集中的字符。因为6个比特有2^6=64种排列组合。</p>
<p>具体来说，编码过程如下：</p>
<ol>
<li>将每三个字节作为一组，共24bit，若不足24bit在其后补充0；</li>
<li>将这24个bit分为4组，每一组6个bit；</li>
<li>在每组前加00扩展为8个bit，形成4个字节，每个字节表示base64字符集索引；</li>
<li>扩展后的8bit表示的整数作为索引，对应base64字符集的一个字符，这就是base64编码值；在处理最后的不足3字节时，缺一个字节索引字节取3个，最后填充一个=，；缺两个字节取2个索引字节，最后填充==。</li>
</ol>
<p>解码时将过程逆向即可。</p>
<p>Base64字符集索引表：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203212353849.png" alt="图片来源维基百科" title="">
                </div>
                <div class="image-caption">图片来源维基百科</div>
            </figure>****

##### 编码示例

**Man的base64编码**：

<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203212359415.png" alt="图片来源维基百科" title="">
                </div>
                <div class="image-caption">图片来源维基百科</div>
            </figure>
<ol>
<li>第一步，’M’, ‘a’, ‘n’的ASCII值分别为77, 97, 110，对应的二进制值分别为：01001101, 01100001, 01101110；取三个字节共24bit：010011010110000101101110。</li>
<li>第二步，将这24bit分为4组，每组6个bit：010011, 010110, 000101, 101110。</li>
<li>每组前面加00，形成4个字节的，00010011, 00010110, 00000101, 00101110, 即19, 22, 5, 46。</li>
<li>根据索引表，对应的base64字符分别是T, W, F, u。</li>
</ol>
<h5 id="Python实现"><a href="#Python实现" class="headerlink" title="Python实现"></a>Python实现</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">base64实现</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="comment"># base 字符集</span></span><br><span class="line"></span><br><span class="line">base64_charset = string.ascii_uppercase + string.ascii_lowercase + string.digits + <span class="string">&#x27;+/&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span>(<span class="params">origin_bytes</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    将bytes类型编码为base64</span></span><br><span class="line"><span class="string">    :param origin_bytes:需要编码的bytes</span></span><br><span class="line"><span class="string">    :return:base64字符串</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将每一位bytes转换为二进制字符串</span></span><br><span class="line">    base64_bytes = [<span class="string">&#x27;&#123;:0&gt;8&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(<span class="built_in">bin</span>(b)).replace(<span class="string">&#x27;0b&#x27;</span>, <span class="string">&#x27;&#x27;</span>)) <span class="keyword">for</span> b <span class="keyword">in</span> origin_bytes]</span><br><span class="line"></span><br><span class="line">    resp = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    nums = <span class="built_in">len</span>(base64_bytes) // <span class="number">3</span></span><br><span class="line">    remain = <span class="built_in">len</span>(base64_bytes) % <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    integral_part = base64_bytes[<span class="number">0</span>:<span class="number">3</span> * nums]</span><br><span class="line">    <span class="keyword">while</span> integral_part:</span><br><span class="line">        <span class="comment"># 取三个字节，以每6比特，转换为4个整数</span></span><br><span class="line">        tmp_unit = <span class="string">&#x27;&#x27;</span>.join(integral_part[<span class="number">0</span>:<span class="number">3</span>])</span><br><span class="line">        tmp_unit = [<span class="built_in">int</span>(tmp_unit[x: x + <span class="number">6</span>], <span class="number">2</span>) <span class="keyword">for</span> x <span class="keyword">in</span> [<span class="number">0</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">18</span>]]</span><br><span class="line">        <span class="comment"># 取对应base64字符</span></span><br><span class="line">        resp += <span class="string">&#x27;&#x27;</span>.join([base64_charset[i] <span class="keyword">for</span> i <span class="keyword">in</span> tmp_unit])</span><br><span class="line">        integral_part = integral_part[<span class="number">3</span>:]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> remain:</span><br><span class="line">        <span class="comment"># 补齐三个字节，每个字节补充 0000 0000</span></span><br><span class="line">        remain_part = <span class="string">&#x27;&#x27;</span>.join(base64_bytes[<span class="number">3</span> * nums:]) + (<span class="number">3</span> - remain) * <span class="string">&#x27;0&#x27;</span> * <span class="number">8</span></span><br><span class="line">        <span class="comment"># 取三个字节，以每6比特，转换为4个整数</span></span><br><span class="line">        <span class="comment"># 剩余1字节可构造2个base64字符，补充==；剩余2字节可构造3个base64字符，补充=</span></span><br><span class="line">        tmp_unit = [<span class="built_in">int</span>(remain_part[x: x + <span class="number">6</span>], <span class="number">2</span>) <span class="keyword">for</span> x <span class="keyword">in</span> [<span class="number">0</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">18</span>]][:remain + <span class="number">1</span>]</span><br><span class="line">        resp += <span class="string">&#x27;&#x27;</span>.join([base64_charset[i] <span class="keyword">for</span> i <span class="keyword">in</span> tmp_unit]) + (<span class="number">3</span> - remain) * <span class="string">&#x27;=&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span>(<span class="params">base64_str</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    解码base64字符串</span></span><br><span class="line"><span class="string">    :param base64_str:base64字符串</span></span><br><span class="line"><span class="string">    :return:解码后的bytearray；若入参不是合法base64字符串，返回空bytearray</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> valid_base64_str(base64_str):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytearray</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对每一个base64字符取下标索引，并转换为6为二进制字符串</span></span><br><span class="line">    base64_bytes = [<span class="string">&#x27;&#123;:0&gt;6&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(<span class="built_in">bin</span>(base64_charset.index(s))).replace(<span class="string">&#x27;0b&#x27;</span>, <span class="string">&#x27;&#x27;</span>)) <span class="keyword">for</span> s <span class="keyword">in</span> base64_str <span class="keyword">if</span> s != <span class="string">&#x27;=&#x27;</span>]</span><br><span class="line">    resp = <span class="built_in">bytearray</span>()</span><br><span class="line">    nums = <span class="built_in">len</span>(base64_bytes) // <span class="number">4</span></span><br><span class="line">    remain = <span class="built_in">len</span>(base64_bytes) % <span class="number">4</span></span><br><span class="line">    integral_part = base64_bytes[<span class="number">0</span>:<span class="number">4</span> * nums]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> integral_part:</span><br><span class="line">        <span class="comment"># 取4个6位base64字符，作为3个字节</span></span><br><span class="line">        tmp_unit = <span class="string">&#x27;&#x27;</span>.join(integral_part[<span class="number">0</span>:<span class="number">4</span>])</span><br><span class="line">        tmp_unit = [<span class="built_in">int</span>(tmp_unit[x: x + <span class="number">8</span>], <span class="number">2</span>) <span class="keyword">for</span> x <span class="keyword">in</span> [<span class="number">0</span>, <span class="number">8</span>, <span class="number">16</span>]]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> tmp_unit:</span><br><span class="line">            resp.append(i)</span><br><span class="line">        integral_part = integral_part[<span class="number">4</span>:]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> remain:</span><br><span class="line">        remain_part = <span class="string">&#x27;&#x27;</span>.join(base64_bytes[nums * <span class="number">4</span>:])</span><br><span class="line">        tmp_unit = [<span class="built_in">int</span>(remain_part[i * <span class="number">8</span>:(i + <span class="number">1</span>) * <span class="number">8</span>], <span class="number">2</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(remain - <span class="number">1</span>)]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> tmp_unit:</span><br><span class="line">            resp.append(i)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resp</span><br></pre></td></tr></table></figure>
<p>特别注意：<span style="color: red"><strong>Base64默认的字符集索引是上边给出的那张图片，有一些JS反爬会在Base64的字符集上面做文章，比如打乱字符集的顺序，导致编码之后的字符串无法用原来的字符集索引进行解码，这样让人误以为不是Base64编码，实际上依然使用的是Base64编码，只不过解码的时候用的是跟编码一样的打乱之后的字符集索引</strong></span>。比如我们将上面生成字符集索引的代码改为如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">base64_charset = <span class="built_in">list</span>(string.ascii_uppercase + string.ascii_lowercase + string.digits + <span class="string">&#x27;+/&#x27;</span>)</span><br><span class="line">random.shuffle(base64_charset)</span><br><span class="line">base64_charset = <span class="string">&quot;&quot;</span>.join(base64_charset)</span><br></pre></td></tr></table></figure>
<p>然后测试一下程序，结果如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203220024628.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220322002411118" title="">
                </div>
                <div class="image-caption">image-20220322002411118</div>
            </figure>
<p>可以看到随着每次使用的字符集索引表不同，导致每次Base64编码的结果也不同，但是如果解码跟编码使用同一套字符集索引表，依然可以正确的解码得到编码之前的内容。</p>
<h4 id="md5信息指纹"><a href="#md5信息指纹" class="headerlink" title="md5信息指纹"></a>md5信息指纹</h4><p><strong>MD5消息摘要算法</strong>（英语：MD5 Message-Digest Algorithm），一种被广泛使用的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/密碼雜湊函數">密码散列函数</a>，可以产生出一个128位（16个字符(BYTES)）的散列值（hash value），用于确保信息传输完整一致。</p>
<h5 id="Python代码演示-1"><a href="#Python代码演示-1" class="headerlink" title="Python代码演示"></a>Python代码演示</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span>(<span class="params">text: <span class="built_in">str</span></span>):</span></span><br><span class="line">    m = hashlib.md5()</span><br><span class="line">    m.update(text.encode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> m.hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file_md5</span>(<span class="params">filename: <span class="built_in">str</span></span>):</span></span><br><span class="line">    m = hashlib.md5()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> chunk <span class="keyword">in</span> <span class="built_in">iter</span>(<span class="keyword">lambda</span>: f.read(<span class="number">4096</span>), <span class="string">b&quot;&quot;</span>):</span><br><span class="line">        	m.update(chunk)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">return</span> m.hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(md5(<span class="string">&quot;123456&quot;</span>))  <span class="comment"># e10adc3949ba59abbe56e057f20f883e</span></span><br><span class="line"><span class="built_in">print</span>(file_md5(<span class="string">&quot;xxx.json&quot;</span>)) <span class="comment"># eea7fb16ddf174c2f92cac5adb6ce7bc</span></span><br></pre></td></tr></table></figure>
<h4 id="AES-加密"><a href="#AES-加密" class="headerlink" title="AES 加密"></a>AES 加密</h4><p>AES，高级加密标准（Advanced Encryption Standard）。是用来替代 DES，目前比较流行的对称加密算法。</p>
<h5 id="对称加密"><a href="#对称加密" class="headerlink" title="对称加密"></a>对称加密</h5><p>一方通过密钥将信息加密后，把密文传给另一方，另一方通过这个相同的密钥将密文解密，转换成可以理解的明文。</p>
<h5 id="非对称加密"><a href="#非对称加密" class="headerlink" title="非对称加密"></a>非对称加密</h5><ol>
<li>A要向B发送信息，A和B都要产生一对用于加密和解密的公钥和私钥。</li>
<li>A的私钥保密，公钥告诉B；B的私钥保密，公钥告诉A。</li>
<li>A要给B发送信息时，A用B的公钥加密信息，因为A知道B的公钥。</li>
<li>A将这个信息发给B(已经用B的公钥加密信息)。</li>
<li>B收到信息后，B用自己的私钥解密A的信息，其它所有收到这个报文的人都无法解密，因为只有B才有解密的私钥。</li>
<li>反过来，B给A发送信息时一样。</li>
</ol>
<h5 id="对称加密与非对称加密的区别"><a href="#对称加密与非对称加密的区别" class="headerlink" title="对称加密与非对称加密的区别"></a>对称加密与非对称加密的区别</h5><ul>
<li>对称加密与解密使用的同样的密钥，所以速度快，但由于需要将密钥在网络中传输，所以安全性不高。</li>
<li>非对称加密使用了一对密钥，公钥与私钥，所以安全性高，但加密与解密速度慢。</li>
<li>解决的方法是将对称加密使用非对称加密的公钥进行加密，然后发送出去，接收方使用私钥进行解密得到对称加密的密钥，然后双方使用对称加密进行信息的传输。</li>
</ul>
<h5 id="AES加密三要素"><a href="#AES加密三要素" class="headerlink" title="AES加密三要素"></a>AES加密三要素</h5><p>密钥，填充和模式。</p>
<ol>
<li>密钥</li>
</ol>
<p>对称加密之所以对称就是因为这类算法对明文的加密和解密使用的是同一个密钥。AES支持三种长度的密钥：128位，192位，256位。</p>
<ol>
<li>填充</li>
</ol>
<p>说到填充一定要说一下，AES分组加密的特性，AES加密并不是一股脑将明文加密成密文，而是把明文拆成一个个独立的明文块，且每个明文块128bit。假如有一段明文长度是196bit，如果按照每128bit一个明文块来拆分的话，第二个明文块只有64bit，不足128bit。这个时候怎么办呢？就需要对明文块进行填充。</p>
<p>填充的种类：</p>
<ul>
<li>NoPadding - 不作任何填充，但是要求明文长度必须是128位的整倍数。</li>
<li>PKCS7Padding - 当明文块少于16个字节，在明文块末尾补充相应数量的字符（字符为缺少的字节数）。</li>
<li>ZeroPadding - 用0进行填充，但是这种方式不推荐，因为经常出现明文块最后一块也是0的时候，解密经常出现错误。</li>
</ul>
<p>演示PKCS7Padding：</p>
<p>比如一段明文为1，2，4，5，6，1，2，3，4，5当这10个字节进行加密的时候是不足16个字节的，如果用PKCS7Padding进行填充，应该是：1，2，4，5，6，1，2，3，4，6，6，6，6，6，6(差6位，补6，且补6个；如果是差7位，则补足7个7)。</p>
<ol>
<li>模式</li>
</ol>
<p>AES的工作模式主要体现在把明文块加密成密文块的处理过程中，AES加密算法提供了五种不同的工作模式：CBC，ECB，CTR，CFB，OFB。</p>
<p>模式之间的主题思想是近似的，在处理细节上有一些差别。</p>
<ul>
<li>ECB模式是最简单的工作模式，在该模式下，每一个明文块的加密都是完全独立，互不干涉。</li>
</ul>
<p>这样做的好处？简单；有利于并行计算。</p>
<p>这样做的缺点？相同的明文块经过加密会变成相同的密文块，因此安全性较差。</p>
<ul>
<li>CBC模式引入了一个新的概念：初始向量IV。</li>
</ul>
<p>IV是用来做什么的呢？它的作用和MD5的加盐有些类似，目的是防止同样的明文块始终加密成同样的密文块。</p>
<p>CBC模式在每一个明文块加密前会让明文块和一个值先做异或操作。</p>
<p>IV作为初始化变量，参与第一个明文的异或，后续的每一个明文块和它前一个明文块所加密的明文块相异或。这样相同的明文块加密出来的密文块显然是不同的。</p>
<p>这样做的好处？安全性更高。</p>
<p>这样做的缺点？无法并行计算，性能上不如CBC模式；引入初始化向量IV，增加复杂度。</p>
<h5 id="Python代码实现"><a href="#Python代码实现" class="headerlink" title="Python代码实现"></a>Python代码实现</h5><ol>
<li><strong>ECB 模式</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BLOCK_SIZE = <span class="number">16</span>  <span class="comment"># Bytes</span></span><br><span class="line">pad = <span class="keyword">lambda</span> s: s + (BLOCK_SIZE - <span class="built_in">len</span>(s) % BLOCK_SIZE) * \</span><br><span class="line">                <span class="built_in">chr</span>(BLOCK_SIZE - <span class="built_in">len</span>(s) % BLOCK_SIZE)</span><br><span class="line">unpad = <span class="keyword">lambda</span> s: s[:-<span class="built_in">ord</span>(s[<span class="built_in">len</span>(s) - <span class="number">1</span>:])]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aesEncrypt</span>(<span class="params">key, data</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    AES的ECB模式加密方法</span></span><br><span class="line"><span class="string">    :param key: 密钥</span></span><br><span class="line"><span class="string">    :param data:被加密字符串（明文）</span></span><br><span class="line"><span class="string">    :return:密文</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    key = key.encode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    <span class="comment"># 字符串补位</span></span><br><span class="line">    data = pad(data)</span><br><span class="line">    cipher = AES.new(key, AES.MODE_ECB)</span><br><span class="line">    <span class="comment"># 加密后得到的是bytes类型的数据，使用Base64进行编码,返回byte字符串</span></span><br><span class="line">    result = cipher.encrypt(data.encode())</span><br><span class="line">    encodestrs = base64.b64encode(result)</span><br><span class="line">    enctext = encodestrs.decode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(enctext)</span><br><span class="line">    <span class="keyword">return</span> enctext</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aesDecrypt</span>(<span class="params">key, data</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param key: 密钥</span></span><br><span class="line"><span class="string">    :param data: 加密后的数据（密文）</span></span><br><span class="line"><span class="string">    :return:明文</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    key = key.encode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    data = base64.b64decode(data)</span><br><span class="line">    cipher = AES.new(key, AES.MODE_ECB)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 去补位</span></span><br><span class="line">    text_decrypted = unpad(cipher.decrypt(data))</span><br><span class="line">    text_decrypted = text_decrypted.decode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(text_decrypted)</span><br><span class="line">    <span class="keyword">return</span> text_decrypted</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    key = <span class="string">&#x27;5c44c819appsapi0&#x27;</span></span><br><span class="line"></span><br><span class="line">    data = <span class="string">&#x27;herish acorn&#x27;</span></span><br><span class="line"></span><br><span class="line">    ecdata = aesEncrypt(key, data)  <span class="comment"># 0FyQSXu3Q9Q13JGf4F74jA==</span></span><br><span class="line">    aesDecrypt(key, ecdata)			<span class="comment"># herish acorn</span></span><br></pre></td></tr></table></figure>
<ol>
<li><strong>CBC 模式</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher  <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 密钥（key）, 密斯偏移量（iv） CBC模式加密</span></span><br><span class="line"></span><br><span class="line">BLOCK_SIZE = <span class="number">16</span>  <span class="comment"># Bytes</span></span><br><span class="line">pad = <span class="keyword">lambda</span> s: s + (BLOCK_SIZE - <span class="built_in">len</span>(s) % BLOCK_SIZE) * \</span><br><span class="line">                <span class="built_in">chr</span>(BLOCK_SIZE - <span class="built_in">len</span>(s) % BLOCK_SIZE)</span><br><span class="line">unpad = <span class="keyword">lambda</span> s: s[:-<span class="built_in">ord</span>(s[<span class="built_in">len</span>(s) - <span class="number">1</span>:])]</span><br><span class="line"></span><br><span class="line">vi = <span class="string">&#x27;0102030405060708&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AES_Encrypt</span>(<span class="params">key, data</span>):</span></span><br><span class="line">    data = pad(data)</span><br><span class="line">    <span class="comment"># 字符串补位</span></span><br><span class="line">    cipher = AES.new(key.encode(<span class="string">&#x27;utf8&#x27;</span>), AES.MODE_CBC, vi.encode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">    encryptedbytes = cipher.encrypt(data.encode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">    <span class="comment"># 加密后得到的是bytes类型的数据，使用Base64进行编码,返回byte字符串</span></span><br><span class="line">    encodestrs = base64.b64encode(encryptedbytes)</span><br><span class="line">    <span class="comment"># 对byte字符串按utf-8进行解码</span></span><br><span class="line">    enctext = encodestrs.decode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> enctext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AES_Decrypt</span>(<span class="params">key, data</span>):</span></span><br><span class="line">    data = data.encode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    encodebytes = base64.decodebytes(data)</span><br><span class="line">    <span class="comment"># 将加密数据转换位bytes类型数据</span></span><br><span class="line">    cipher = AES.new(key.encode(<span class="string">&#x27;utf8&#x27;</span>), AES.MODE_CBC, vi.encode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">    text_decrypted = cipher.decrypt(encodebytes)</span><br><span class="line">    <span class="comment"># 去补位</span></span><br><span class="line">    text_decrypted = unpad(text_decrypted)</span><br><span class="line">    text_decrypted = text_decrypted.decode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(text_decrypted)</span><br><span class="line">    <span class="keyword">return</span> text_decrypted</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    key = <span class="string">&#x27;5c44c819appsapi0&#x27;</span></span><br><span class="line"></span><br><span class="line">    data = <span class="string">&#x27;herish acorn&#x27;</span></span><br><span class="line">    enctext = AES_Encrypt(key, data)	<span class="comment"># svAg4qrFNphvwS47DLSb2A==</span></span><br><span class="line">    <span class="built_in">print</span>(enctext)						<span class="comment"># herish acorn</span></span><br><span class="line"></span><br><span class="line">    AES_Decrypt(key, enctext)</span><br></pre></td></tr></table></figure>
<h5 id="NodeJS代码实现"><a href="#NodeJS代码实现" class="headerlink" title="NodeJS代码实现"></a>NodeJS代码实现</h5><ol>
<li><strong>ECB模式</strong></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> CryptoJS = <span class="built_in">require</span>(<span class="string">&quot;crypto-js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> key = <span class="string">&quot;ABC1234567891234&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> CryptoJS.AES.encrypt(text, CryptoJS.enc.Utf8.parse(key), &#123;</span><br><span class="line">        <span class="attr">iv</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">mode</span>: CryptoJS.mode.ECB,</span><br><span class="line">        <span class="attr">padding</span>: CryptoJS.pad.Pkcs7</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decrypt</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = CryptoJS.AES.decrypt(text, CryptoJS.enc.Utf8.parse(key), &#123;</span><br><span class="line">        <span class="attr">iv</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">mode</span>: CryptoJS.mode.ECB,</span><br><span class="line">        <span class="attr">padding</span>: CryptoJS.pad.Pkcs7</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> result.toString(CryptoJS.enc.Utf8);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> text = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> encoded = encrypt(text);</span><br><span class="line"><span class="built_in">console</span>.log(encoded.toString());	<span class="comment">// nWhAGHyLGTLV1dff9+PEUw==</span></span><br><span class="line"><span class="built_in">console</span>.log(decrypt(encoded));		<span class="comment">// 123456</span></span><br></pre></td></tr></table></figure>
<ol>
<li><strong>CBC模式</strong></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> CryptoJS = <span class="built_in">require</span>(<span class="string">&quot;crypto-js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> key = <span class="string">&quot;ABC1234567891234&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> iv = <span class="string">&quot;1234567812345678&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> CryptoJS.AES.encrypt(text, CryptoJS.enc.Utf8.parse(key), &#123;</span><br><span class="line">        <span class="attr">iv</span>: CryptoJS.enc.Utf8.parse(iv),</span><br><span class="line">        <span class="attr">mode</span>: CryptoJS.mode.CBC,</span><br><span class="line">        <span class="attr">padding</span>: CryptoJS.pad.Pkcs7</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decrypt</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = CryptoJS.AES.decrypt(text, CryptoJS.enc.Utf8.parse(key), &#123;</span><br><span class="line">        <span class="attr">iv</span>: CryptoJS.enc.Utf8.parse(iv),</span><br><span class="line">        <span class="attr">mode</span>: CryptoJS.mode.CBC,</span><br><span class="line">        <span class="attr">padding</span>: CryptoJS.pad.Pkcs7</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> result.toString(CryptoJS.enc.Utf8);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> text = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> encoded = encrypt(text);</span><br><span class="line"><span class="built_in">console</span>.log(encoded.toString());	<span class="comment">// 6S3YRylMmp9vIFOplWxypw==</span></span><br><span class="line"><span class="built_in">console</span>.log(decrypt(encoded));		<span class="comment">// 123456</span></span><br></pre></td></tr></table></figure>
<h5 id="AES加密流程总结"><a href="#AES加密流程总结" class="headerlink" title="AES加密流程总结"></a>AES加密流程总结</h5><ol>
<li>把明文按照128bit拆分成若干个明文块。</li>
<li>按照选择的填充方式来填充最后一个明文块。</li>
<li>每一个明文块利用AES加密器和密钥加密成明文。</li>
<li>拼接所有的密文块成为最终的密文结果。</li>
</ol>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203172352889.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="AES加密" title="">
                </div>
                <div class="image-caption">AES加密</div>
            </figure>

    

        <a href="/JS%E9%80%86%E5%90%91%E4%B8%AD%E7%94%A8%E5%88%B0%E7%9A%84%E5%B8%B8%E8%A7%81%E7%9A%84%E7%BC%96%E7%A0%81%E5%92%8C%E5%8A%A0%E5%AF%86/" class="post-more waves-effect waves-button">
            Continue reading...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JS/" rel="tag">JS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%80%86%E5%90%91/" rel="tag">逆向</a></li></ul>

    </div>
    
</article>

        </li>
    
        <li class="post-list-item fade">
            <article id="post-JS逆向之快速定位关键代码"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time class="post-time" title="2022-03-01 22:23:00" datetime="2022-03-01T14:23:00.000Z"  itemprop="datePublished">2022-03-01</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/JS%E9%80%86%E5%90%91/">JS逆向</a></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/JS%E9%80%86%E5%90%91%E4%B9%8B%E5%BF%AB%E9%80%9F%E5%AE%9A%E4%BD%8D%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81/">JS逆向之快速定位关键代码</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent">

    
        <h5 id="快速定位之搜索"><a href="#快速定位之搜索" class="headerlink" title="快速定位之搜索"></a>快速定位之搜索</h5><ol>
<li>DOM元素或者当前页面内容的搜索</li>
</ol>
<p>Element面板快捷键CTRL+F就可以打开搜索框，搜索DOM元素。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203131949450.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220313194959329" title="">
                </div>
                <div class="image-caption">image-20220313194959329</div>
            </figure>
<ol>
<li>全局搜索</li>
</ol>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203131952349.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220313195223274" title="">
                </div>
                <div class="image-caption">image-20220313195223274</div>
            </figure>
<p>全局搜索包含页面搜索</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203131953520.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220313195307491" title="">
                </div>
                <div class="image-caption">image-20220313195307491</div>
            </figure>
<h5 id="快速定位之断点"><a href="#快速定位之断点" class="headerlink" title="快速定位之断点"></a>快速定位之断点</h5><ol>
<li>XHR断点</li>
</ol>
<p>XHR断点只对请求内容为XHR的请求生效。在<a href="http://blog.heshipeng.com/Chrome%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E5%85%B7%E4%BD%A0%E7%9F%A5%E5%A4%9A%E5%B0%91/">JS逆向之Chrome浏览器工具你知多少？</a>中介绍过通过网络面板抓包可以看到请求的类型，如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203140027831.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220314002711032" title="">
                </div>
                <div class="image-caption">image-20220314002711032</div>
            </figure>
<p>通过抓包得到XHR请求的URL之后，就可以打上XHR断点了。开发者工具切换到Source面板，展开XHR/fetch Breakpoints点击+号新建一个XHR断点。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203140030770.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220314003042713" title="">
                </div>
                <div class="image-caption">image-20220314003042713</div>
            </figure>
<p>XHR断点不填任何字符表示对任何XHR请求都会断上，也可以填一个完整的URL，也可以填URL的一部分，如上图。<strong>注意：通常会去掉URL后边的参数，因为URL后边的参数可能是动态变化的，如果是动态变化的会导致每次都匹配不上，就没法断上。</strong></p>
<ol>
<li>DOM断点</li>
</ol>
<p>DOM断点一般指的是页面元素的断点。打DOM断点的方式是在Source面板，选中某一个元素右键选择Break on，如下图：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203141346655.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220314134609560" title="">
                </div>
                <div class="image-caption">image-20220314134609560</div>
            </figure>
<p>subtree modifications表示子树发生更改，attribute modifications表示节点属性值发生改变，node removal表示节点被移除。我们也第二个attribute modifications为例，更改百度首页的百度一下，将其替换为谷歌一下。如下图：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203141625197.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220314162541977" title="">
                </div>
                <div class="image-caption">image-20220314162541977</div>
            </figure>
<p>然后就成功断下了。DOM断点的应用场景在哪？比如说有一个Input输入框，然后每次点击submit按钮，Input输出框的value属性都会改变，同时把这个value值提交到后端，这个时候通过DOM断点就可以断到value值发生改变的地方，通过调用栈去查找对应改变value值的代码。</p>
<ol>
<li>Event断点</li>
</ol>
<p>Event断点在Source面板的Event Listener Breakpoints一栏。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203141707913.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220314170733786" title="">
                </div>
                <div class="image-caption">image-20220314170733786</div>
            </figure>
<p>这里我们以鼠标的click事件为例，选择Mouse/Click事件，然后点击百度一下按钮：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203141711126.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220314171105093" title="">
                </div>
                <div class="image-caption">image-20220314171105093</div>
            </figure>
<p>可以看到成功断上了。</p>
<h5 id="快速定位之hook"><a href="#快速定位之hook" class="headerlink" title="快速定位之hook"></a>快速定位之hook</h5><ol>
<li>json</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> my_stringfy = <span class="built_in">JSON</span>.stringfy;</span><br><span class="line"><span class="built_in">JSON</span>.stringfy = <span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;xxx&quot;</span>, params);</span><br><span class="line">    <span class="keyword">return</span> my_stringfy(params);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> my_parse = <span class="built_in">JSON</span>.parse;</span><br><span class="line"><span class="built_in">JSON</span>.parse = <span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;xxx&quot;</span>, params);</span><br><span class="line">    <span class="keyword">return</span> my_parse(params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>cookie</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cookie_cache = <span class="built_in">document</span>.cookie;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(<span class="built_in">document</span>, <span class="string">&#x27;cookie&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;Getting cookie&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> cookie_cache;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">set</span>: <span class="function"><span class="keyword">function</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;Setting cookie&#x27;</span>, val);</span><br><span class="line">        <span class="keyword">var</span> cookie = val.split(<span class="string">&quot;;&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">var</span> ncookie = cookie.split(<span class="string">&quot;=&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> flag = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">var</span> cache = cookie_cache.split(<span class="string">&quot;; &quot;</span>);</span><br><span class="line">        cache = cache.map(<span class="function"><span class="keyword">function</span>(<span class="params">a</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (a.split(<span class="string">&quot;=&quot;</span>)[<span class="number">0</span>] === ncookie[<span class="number">0</span>]) &#123;</span><br><span class="line">                flag = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">return</span> cookie;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        &#125;);</span><br><span class="line">        cookie_cache = cache.join(<span class="string">&quot;; &quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">            cookie_cache += cookie + <span class="string">&quot;; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>._value = val;</span><br><span class="line">        <span class="keyword">return</span> cookie_cache;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ol>
<li>window attr</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> window_flag_1 = <span class="string">&quot;_t&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> window_flag_2 = <span class="string">&quot;ccc&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> key_value_map = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> window_value = <span class="built_in">window</span>[window_flag_1];</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(<span class="built_in">window</span>, window_flag_1, &#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Getting&quot;</span>, <span class="built_in">window</span>, window_flag_1, <span class="string">&quot;=&quot;</span>, window_value);</span><br><span class="line">        <span class="keyword">return</span> window_value;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">set</span>: <span class="function"><span class="keyword">function</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Setting&quot;</span>, <span class="built_in">window</span>, window_flag_1, <span class="string">&quot;=&quot;</span>, val);</span><br><span class="line">        window_value = val;</span><br><span class="line">        key_value_map[<span class="built_in">window</span>[window_flag_1]] = window_flag_1;</span><br><span class="line">        set_obj_attr(<span class="built_in">window</span>[window_flag_1], window_flag_2);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_obj_attr</span>(<span class="params">obj, attr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> obj_attr_value = obj[attr];</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(obj, attr, &#123;</span><br><span class="line">        <span class="attr">get</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;Getting&quot;</span>, key_value_map[obj], attr, <span class="string">&quot;=&quot;</span>, obj_attr_value);</span><br><span class="line">            <span class="keyword">return</span> obj_attr_value;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">set</span>: <span class="function"><span class="keyword">function</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;Setting&quot;</span>, key_value_map[obj], attr, <span class="string">&quot;=&quot;</span>, val);</span><br><span class="line">            obj_attr_value = val;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单测试如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203141743582.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220314174331478" title="">
                </div>
                <div class="image-caption">image-20220314174331478</div>
            </figure>
<ol>
<li>eval/Function</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.__cr_eval = <span class="built_in">window</span>.eval;</span><br><span class="line"><span class="keyword">var</span> my_eval = <span class="function"><span class="keyword">function</span>(<span class="params">src</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(src);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;============eval end===========&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">window</span>.__cr_eval(src);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _my_eval = <span class="built_in">eval</span>.bind(<span class="literal">null</span>);</span><br><span class="line">_my_eval.toString = <span class="built_in">window</span>.__cr_eval.toString;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(<span class="built_in">window</span>, <span class="string">&#x27;eval&#x27;</span>, &#123; <span class="attr">value</span>: _my_eval &#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.__cr_fun = <span class="built_in">window</span>.Function;</span><br><span class="line"><span class="keyword">var</span> myfun = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">0</span>, -<span class="number">1</span>).join(<span class="string">&quot;,&quot;</span>).src = <span class="built_in">arguments</span>[<span class="built_in">arguments</span>.length - <span class="number">1</span>];</span><br><span class="line">    <span class="built_in">console</span>.log(src);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;===========Function end=========&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">window</span>.__cr_fun.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">myfun.toString = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="built_in">window</span>.__cr_fun + <span class="string">&quot;&quot;</span> &#125;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(<span class="built_in">window</span>, <span class="string">&#x27;Function&#x27;</span>, &#123; <span class="attr">value</span>: myfun &#125;)</span><br></pre></td></tr></table></figure>
<p>  简单测试如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203150055349.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220315005512673" title="">
                </div>
                <div class="image-caption">image-20220315005512673</div>
            </figure>
<ol>
<li>websocket</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">WebSocket.prototype.senda = WebSocket.prototype.send;</span><br><span class="line">WebSocket.prototype.send = <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">&quot;Hook WebSocket, data&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.senda(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="快速定位之分析"><a href="#快速定位之分析" class="headerlink" title="快速定位之分析"></a>快速定位之分析</h5><ol>
<li>Elements Event Listeners</li>
</ol>
<p>在Elements面板，右边Event Listeners可以看到全部的事件监听器，如图：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203150108324.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220315010815283" title="">
                </div>
                <div class="image-caption">image-20220315010815283</div>
            </figure>
<ol>
<li>Network type initator</li>
</ol>
<p>在Network网络面板，请求列表的第三列是网络类型，第四列是调用栈。如下图：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203150111733.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220315011120666" title="">
                </div>
                <div class="image-caption">image-20220315011120666</div>
            </figure>
<p>常见的网络类型有xhr(XHR类型的请求)，gif，png，jpeg，stylesheet(css文件)，script(JS文件)，Json等。</p>
<p>鼠标悬浮任意一个请求的第四列，可以看到该请求的全部调用栈，如下图：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203150114096.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220315011435032" title="">
                </div>
                <div class="image-caption">image-20220315011435032</div>
            </figure>
<p>通常通过网络面板抓包抓到我们需要的请求，然后可以查看它的调用栈，迅速定位到相关的代码。</p>
<ol>
<li>Console Log XMLHttpRequests</li>
</ol>
<p>打开XMLHttpRequests日志的方法，点击开发者工具上的那个设置按钮：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203150122662.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220315012217598" title="">
                </div>
                <div class="image-caption">image-20220315012217598</div>
            </figure>
<p>找到Console那一部分，选中Log XMLHttpRequests，如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203150124093.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220315012414737" title="">
                </div>
                <div class="image-caption">image-20220315012414737</div>
            </figure>
<p>重新刷新页面，可以看到打印出了XMLRequests的请求日志了，点击可以看到调用栈：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203150127672.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220315012715597" title="">
                </div>
                <div class="image-caption">image-20220315012715597</div>
            </figure>

    

        <a href="/JS%E9%80%86%E5%90%91%E4%B9%8B%E5%BF%AB%E9%80%9F%E5%AE%9A%E4%BD%8D%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81/" class="post-more waves-effect waves-button">
            Continue reading...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JS/" rel="tag">JS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%80%86%E5%90%91/" rel="tag">逆向</a></li></ul>

    </div>
    
</article>

        </li>
    
        <li class="post-list-item fade">
            <article id="post-JS逆向之无限Debugger"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time class="post-time" title="2022-02-28 10:12:45" datetime="2022-02-28T02:12:45.000Z"  itemprop="datePublished">2022-02-28</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/JS%E9%80%86%E5%90%91/">JS逆向</a></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/JS%E9%80%86%E5%90%91%E4%B9%8B%E6%97%A0%E9%99%90Debugger/">JS逆向之无限Debugger</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent">

    
        <blockquote>
<p>免责声明：<strong>本文章中所有内容仅供学习交流，抓包内容、敏感网址、数据接口均已做脱敏处理，严禁用于商业用途和非法用途，否则由此产生的一切后果均与作者无关，若有侵权，请联系我立即删除！</strong></p>
</blockquote>
<h4 id="关于无限debugger"><a href="#关于无限debugger" class="headerlink" title="关于无限debugger"></a>关于无限debugger</h4><p>在进入无限debugger之前先看下三个问题。</p>
<h5 id="在什么情况下会遇到debugger"><a href="#在什么情况下会遇到debugger" class="headerlink" title="在什么情况下会遇到debugger"></a>在什么情况下会遇到debugger</h5><p>在分析网络请求，查看元素的事件监听器，跟踪JS等需求下，第一步就是打开浏览器的开发者工具，而打开浏览器工具就可能会碰到无限debugger死循环，或者在我们的调试过程中也可能出现无限debugger。</p>
<h5 id="为什么反爬虫会用到debugger"><a href="#为什么反爬虫会用到debugger" class="headerlink" title="为什么反爬虫会用到debugger"></a>为什么反爬虫会用到debugger</h5><p>因为分析代码逻辑，调试JS代码是JS逆向的必要手段，而分析调试则需要使用开发者工具。然后就可以在关键的地方设防，精准的设置第一道防线。</p>
<h5 id="debugger反爬的优势在哪"><a href="#debugger反爬的优势在哪" class="headerlink" title="debugger反爬的优势在哪"></a>debugger反爬的优势在哪</h5><ol>
<li><p>实现比较简单，前端工程师可以不会写那种复杂的反人类的反爬代码，但是写个无限debugger是个基本操作。</p>
</li>
<li><p>效果比较明显，如果第一步都没法通过的话，就不会有下一步了。</p>
</li>
<li>一定程度上可以提高代码的安全性，可以阻止我们调试分析代码逻辑。</li>
</ol>
<p>接下来正式进入无限debugger</p>
<h4 id="常见无限debugger及解决方案"><a href="#常见无限debugger及解决方案" class="headerlink" title="常见无限debugger及解决方案"></a>常见无限debugger及解决方案</h4><ol>
<li>按代码逻辑划分</li>
</ol>
<ul>
<li>无限循环，比如for/while循环里面包含debugger关键字</li>
<li>无限递归，一个方法包含debugger关键字，并且递归调用自己</li>
<li>两个方法互调，两个方法彼此都包含debugger关键字，然后彼此调用彼此。</li>
<li>定时器，使用定时器执行一个方法，方法里面包含debugger关键字，就会定时执行debugger。</li>
</ul>
<ol>
<li>按是否混淆划分</li>
</ol>
<ul>
<li>直接在方法中使用debugger关键字或者通过eval执行，比如eval(“debugger”)</li>
<li>重度混淆，通过对debugger字符串进行混淆，然后使用eval执行，从而在全局搜索中搜索不到debugger关键字。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>(<span class="string">&quot;debugger&quot;</span>).call()/apply() 或赋值 bind()</span><br><span class="line">xxx.constructor(<span class="string">&quot;debugger&quot;</span>).call(<span class="string">&quot;action&quot;</span>)</span><br><span class="line">Fuction.constructor(<span class="string">&quot;debugger&quot;</span>).call(<span class="string">&quot;action&quot;</span>)</span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> !{% image <span '];&#125;[<span class="string">&quot;constructor&quot;</span>](<span class="string">&quot;debugger&quot;</span>)[<span class="string">&quot;call&quot;</span>' 'class=string>&quot;action&quot;</span>)' %}</span><br></pre></td></tr></table></figure>
<ol>
<li>其它的方式</li>
</ol>
<p>debugger关键字贯穿整个JS文件。</p>
<h4 id="处理无限debugger的几种方式"><a href="#处理无限debugger的几种方式" class="headerlink" title="处理无限debugger的几种方式"></a>处理无限debugger的几种方式</h4><ol>
<li>去除断点</li>
</ol>
<p>这种情况针对debugger关键字比较少，可以选中debugger关键字的行号，鼠标右键添加conditional breakpoint，即添加条件断点，然后条件设置为false；也可以鼠标右键设置never pause here，即永远不会在此行暂停，这样也可以跳过这个debugger。</p>
<ol>
<li>替换debugger关键字</li>
</ol>
<p>如果debugger关键字非常多，贯穿多个JS文件，这时候一个个手动去除断点就显得非常麻烦了，这时候我们考虑保存相应的JS文件到本地，然后全局替换里面的debugger关键字，比如说把debugger关键字替换为false或者替换成debugger字符串，然后通过<a href="http://blog.heshipeng.com/Chrome%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E5%85%B7%E4%BD%A0%E7%9F%A5%E5%A4%9A%E5%B0%91/">JS逆向之Chrome浏览器工具你知多少？</a>介绍的override面板，把相应的请求代理到本地文件，或者说通过<a href="http://blog.heshipeng.com/JS%E9%80%86%E5%90%91%E4%B9%8BCharles%E5%B7%A5%E5%85%B7%E7%AF%87/">JS逆向之Charles工具篇</a>介绍的Chares，利用其反向代理，也可以达到同样的目的，这样就可以屏蔽debugger关键字了。</p>
<ol>
<li>hook某些方法</li>
</ol>
<p>手动置空包含debugger关键字的方法或者重写这个方法，这样做的前提是这个方法里面不包含有效的业务逻辑，不然虽然去除了无限debugger，但是相应的业务逻辑被修改了，导致我们无法调试正确的结果。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="案例分析"><a href="#案例分析" class="headerlink" title="案例分析"></a>案例分析</h4><h5 id="某气网"><a href="#某气网" class="headerlink" title="某气网"></a>某气网</h5><p>网址：aHR0cHM6Ly93d3cuYXFpc3R1ZHkuY24vaGlzdG9yeWRhdGEvZGF5ZGF0YS5waHA/Y2l0eT0lRTYlOUQlQUQlRTUlQjclOUUmbW9udGg9MjAyMjAy</p>
<p>打开浏览器输入网址然后本打算按照往常调出开发者工具，结果</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203011429562.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220301142911458" title="">
                </div>
                <div class="image-caption">image-20220301142911458</div>
            </figure>
<p>😮有意思，第一次遇到这样的网站，google了下遇到这种情况，首先打开一个空的tab，调出开发者工具，然后再输入网址，发现成功断上了。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203011437352.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220301143747259" title="">
                </div>
                <div class="image-caption">image-20220301143747259</div>
            </figure>
<p>这里就出现了一个无限debugger，右键第三行然后选择Never pause here，接着往下调试：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203011451282.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220301145120187" title="">
                </div>
                <div class="image-caption">image-20220301145120187</div>
            </figure>
<p>又出现了一个无限debugger，递归调用自己。我们在console控制台，把txsdefwsw这个方法置空：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">txsdefwsw = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>接着往下调试，接着又遇到一系列的检测：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203011454862.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220301145404806" title="">
                </div>
                <div class="image-caption">image-20220301145404806</div>
            </figure>
<p>我们依次把方法重写：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">endebug = <span class="function"><span class="keyword">function</span>(<span class="params">off, code</span>) </span>&#123;&#125; </span><br><span class="line"><span class="built_in">document</span>.onkeydown = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="built_in">document</span>.oncontextmenu = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>接着往下调试，会发现有一段代码通过检测窗口的outerHeight与innerHeight的差值判断是否打开了开发者工具：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203021440132.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220302144052945" title="">
                </div>
                <div class="image-caption">image-20220302144052945</div>
            </figure>
<p>这里我们把window.innerHeight设置为1200。上边还有一个检测时间差值的我们重写这个getTime方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.innerHeight = <span class="number">1400</span></span><br><span class="line"><span class="built_in">Date</span>.prototype.getTime = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br></pre></td></tr></table></figure>
<p>综合以上的分析，我们可以利用<a href="http://blog.heshipeng.com/JS%E9%80%86%E5%90%91%E4%B9%8BTampermonkey%E5%B7%A5%E5%85%B7%E7%AF%87/">JS逆向之Tampermonkey工具篇</a>介绍的油猴插件，更加方便的进行代码分析，油猴插件脚本内容如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203021518960.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220302151850796" title="">
                </div>
                <div class="image-caption">image-20220302151850796</div>
            </figure>
<p>解释下上面for循环代码的含义，由于前面我们提到的无论是txsdefwsw还是endebug方法，都是通过匿名定时器来实现无限debugger的，<strong>匿名定时器无法根据定时器的名字来取消定时器，但是定时器的id基本都是1～1000，所以我们穷举这1000个id暴力取消这些匿名定时器</strong>。这不妨也是一种小技巧。</p>
<p>启用之后，我们刷新页面，就可以看到页面上已经加载出来数据了：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203021521617.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220302152127528" title="">
                </div>
                <div class="image-caption">image-20220302152127528</div>
            </figure>
<p>我们再来分析网络请求，看看能否抓取到数据包。没有发现XHR请求。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203021524337.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220302152404276" title="">
                </div>
                <div class="image-caption">image-20220302152404276</div>
            </figure>
<p>我们找到一个daydata.php的请求，然后里面有2个通过eval计算字符串的代码，如上图。我们在当前html页面并没有找到dUHTtbN9Om和dwDMxkUh0FG方法，那就很明显这两个方法在其它的JS文件里面，我们查看下这个html页面看看它引入了哪些JS文件，找到一个可疑的js文件de8qI5LXFNehN.min.js，我们找到这个文件，查看其内容：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203021542199.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220302154247031" title="">
                </div>
                <div class="image-caption">image-20220302154247031</div>
            </figure>
<p>然后用eval执行，得到文件内容如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203021544313.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220302154446239" title="">
                </div>
                <div class="image-caption">image-20220302154446239</div>
            </figure>
<p>我们阅读下代码，发现以下几点：</p>
<ol>
<li>里面有一个Ajax请求是获取数据的。</li>
</ol>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203021545551.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220302154557476" title="">
                </div>
                <div class="image-caption">image-20220302154557476</div>
            </figure>
<ol>
<li>有一段读取本地缓存的逻辑，如果读取本地缓存没有数据然后再发Ajax请求去获取数据：</li>
</ol>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203021550437.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220302155002354" title="">
                </div>
                <div class="image-caption">image-20220302155002354</div>
            </figure>
<p>这也就解释了之前为啥没有XHR请求，只是有一个php请求，我们删除localStorage测试下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203021551951.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220302155104877" title="">
                </div>
                <div class="image-caption">image-20220302155104877</div>
            </figure>
<p>然后重新刷新页面，果然看到了XHR请求：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203021552862.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220302155235769" title="">
                </div>
                <div class="image-caption">image-20220302155235769</div>
            </figure>
<ol>
<li>前面找不到的dUHTtbN9Om和dwDMxkUh0FG方法，在这个文件中找到了。我们利用JS文件中找到的这2个方法，解开php中两串神秘的代码：</li>
</ol>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203021603310.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220302160300199" title="">
                </div>
                <div class="image-caption">image-20220302160300199</div>
            </figure>
<p>第一段是反爬检测的代码。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203021603182.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220302160331099" title="">
                </div>
                <div class="image-caption">image-20220302160331099</div>
            </figure>
<p>第二段是数据解密的代码。</p>
<p>😶‍🌫️分析了这么多，是不是感觉有一点混乱，那我们理理头绪，看看这个JS文件与PHP文件的关系。数据获取在JS文件里面，先读本地缓存，如果有的话取本地缓存数据；如果没有的话，发送Ajax请求。无论是Ajax请求来的还是本地读取的数据，都是加密的，解密的算法放在JS文件里面，然后渲染到PHP页面上去，整个JS文件的入口在PHP文件里面。总结下来就是JS文件包含数据的加密(Ajax参数)，解密(Ajax返回数据)和发送请求代码，PHP里则是存放JS的入口方法。</p>
<p>在分析的过程中有一点需要注意，这个网站大概几分钟会重新加载一次dom，这样混淆的代码名字又会变了，所以调试的时候将文件保存在本地，然后再进行分析。</p>
<p>最后说一下整个数据抓取的思路，首先请求php文件，然后通过正则匹配出php文件里面上面提到的那个加密解密的JS，执行JS里面的eval，得到实时的加密解密代码，然后用解密的代码去解密php文件里第二段的加密数据即可。</p>
<h5 id="推荐一些练手的无限debugger网站"><a href="#推荐一些练手的无限debugger网站" class="headerlink" title="推荐一些练手的无限debugger网站"></a>推荐一些练手的无限debugger网站</h5><ol>
<li>aHR0cHM6Ly93d3cubm1wYS5nb3YuY24v</li>
<li>网址：aHR0cDovL3p3Zncuc2FuLWhlLmdvdi5jbi9pY2l0eS9pY2l0eS9ndWVzdGJvb2svaW50ZXJhY3Q=</li>
</ol>
<p>​       接口：aHR0cDovL3p3Zncuc2FuLWhlLmdvdi5jbi9pY2l0eS9hcGktdjIvYXBwLmljaXR5Lmd1ZXN0Ym9vay5Xcml0ZUNtZC9nZXRMaXN0</p>
<ol>
<li>aHR0cHM6Ly9iei56enptaC5jbi9pbmRleA==</li>
</ol>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>本文介绍了常见的几种无限debugger的形式以及对应的几种解决方案。然后通过一个相对复杂的例子做了一个演示，这个网站通过检测浏览器高度，代码执行延迟来反调试，仔细阅读相关的代码我们还可以找到其对无头浏览器也做了检测，这样如果想用playwright之类的浏览器工具的话可能也会被检测到，而且请求的参数以及返回的数据也是做了动态的加密，总体而言反爬还是比较严的。本文的相关代码已经上传，关注公众号，回复关键字“代码 某气网”，即可获取案例完整代码。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://img.heshipeng.com/202203021721122.jpg?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="qrcode_for_gh_509fdefd3c81_258" title="">
                </div>
                <div class="image-caption">qrcode_for_gh_509fdefd3c81_258</div>
            </figure>

    

        <a href="/JS%E9%80%86%E5%90%91%E4%B9%8B%E6%97%A0%E9%99%90Debugger/" class="post-more waves-effect waves-button">
            Continue reading...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JS/" rel="tag">JS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%80%86%E5%90%91/" rel="tag">逆向</a></li></ul>

    </div>
    
</article>

        </li>
    
    </ul>

    
<nav id="page-nav">
    <div class="inner">
    <a class="extend prev" rel="prev" href="/">上一页</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">下一页</a>
    </div>
</nav>


</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>This blog is licensed under a <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</span>
        </p>
    </div>
    <div class="bottom">
        <p><span>拾光的碎羽 &copy; 2021 - 2022</span>
            <span>
                
                <a href="http://www.miitbeian.gov.cn/" target="_blank">鄂ICP备2022001140号</a><br>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.heshipeng.com/page/2/&title=Hexo&pic=https://img.heshipeng.com/202205092042366.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.heshipeng.com/page/2/&title=Hexo&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.heshipeng.com/page/2/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=Hexo&url=https://blog.heshipeng.com/page/2/&via=https://blog.heshipeng.com" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.heshipeng.com/page/2/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://blog.heshipeng.com/page/2/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="/js/main.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.js?v=1.7.2" async></script>



<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" async></script>




<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = '死鬼去哪里了！';
            clearTimeout(titleTime);
        } else {
            document.title = '(つェ⊂)咦!又好了!';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
